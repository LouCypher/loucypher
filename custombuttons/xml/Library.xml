<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Library]]></html:title>
    <html:link rel="shortcut icon" href=""/>
    <html:style type="text/css"><![CDATA[
body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
}
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-color: rgb(85, 168, 2);
  background-image: linear-gradient(to bottom, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -moz-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -o-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -webkit-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  border: 1px solid rgb(58, 116, 4);
  border-radius: .5em;
  -moz-border-radius: .5em;
  -webkit-border-radius: .5em;
  padding: 0;
  margin-bottom: 1em;
  box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -moz-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -o-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -webkit-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
}
#button a {
  color: #000;
  text-shadow: -1pt -1px 0pt rgba(255, 255, 255, .5);
  padding: 1em;
  text-decoration: none;
}
:-moz-any-link:focus {
  color: white;
  outline-color: transparent;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
date, image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3ELibrary%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bcustombuttons-stdicon-1%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5Bfunction%20showPlacesPanel%28aBrowser%2C%20aHierarchy%29%20%7B%0A%20%20let%20win%20%3D%20aBrowser.contentWindow%3B%0A%20%20let%20PlacesOrganizer%20%3D%20win.wrappedJSObject.PlacesOrganizer%3B%0A%0A%20%20if%20%28%22selectLeftPaneContainerByHierarchy%22%20in%20PlacesOrganizer%29%0A%20%20%20%20//%20Fx%2025+%0A%20%20%20%20PlacesOrganizer.selectLeftPaneContainerByHierarchy%28aHierarchy%29%3B%0A%20%20else%0A%20%20%20%20PlacesOrganizer.selectLeftPaneQuery%28aHierarchy%29%0A%0A%20%20win.focus%28%29%3B%0A%7D%0A%0A//%20This%20will%20switch%20to%20the%20tab%20in%20aWindow%20having%20aURI%2C%20if%20present.%0Afunction%20switchIfURIInWindow%28aWindow%2C%20aURI%29%20%7B%0A%20%20if%20%28%22PrivateBrowsingUtils%22%20in%20window%29%20%7B%20//%20Fx%2020+%0A%20%20%20%20//%20Only%20switch%20to%20the%20tab%20if%20neither%20the%20source%20and%20desination%20window%20are%0A%20%20%20%20//%20private%20and%20they%20are%20not%20in%20permanent%20private%20borwsing%20mode%0A%20%20%20%20if%20%28%28PrivateBrowsingUtils.isWindowPrivate%28window%29%20%7C%7C%0A%20%20%20%20%20%20%20%20PrivateBrowsingUtils.isWindowPrivate%28aWindow%29%29%20%26%26%0A%20%20%20%20%20%20%20%20%21PrivateBrowsingUtils.permanentPrivateBrowsing%29%20%7B%0A%20%20%20%20%20%20return%20false%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20let%20browsers%20%3D%20aWindow.gBrowser.browsers%3B%0A%20%20for%20%28let%20i%20%3D%200%3B%20i%20%3C%20browsers.length%3B%20i++%29%20%7B%0A%20%20%20%20let%20browser%20%3D%20browsers%5Bi%5D%3B%0A%20%20%20%20if%20%28browser.currentURI.equals%28aURI%29%29%20%7B%0A%20%20%20%20%20%20//%20Focus%20the%20matching%20window%20%26%20tab%0A%20%20%20%20%20%20aWindow.focus%28%29%3B%0A%20%20%20%20%20%20aWindow.gBrowser.tabContainer.selectedIndex%20%3D%20i%3B%0A%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20return%20false%3B%0A%7D%0A%0A/**%0A%20*%20Open%20Library%20in%20Tab.%0A%20*%0A%20*%20@param%20aHierarchy%20A%20single%20container%20or%20an%20array%20of%20containers%2C%20sorted%20from%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20the%20outmost%20to%20the%20innermost%20in%20the%20hierarchy.%20Each%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20container%20may%20be%20either%20an%20item%20id%2C%20a%20Places%20URI%20string%2C%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20or%20a%20named%20query.%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Supported%20named%20queries%20are%3A%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20AllBookmarks%20%20%20%20%20%20%20%20%20-%20History%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20BookmarksMenu%20%20%20%20%20%20%20%20-%20Tags%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20BookmarksToolbar%20%20%20%20%20-%20UnfiledBookmarks%0A%20*%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20Downloads%0A%20*/%0Afunction%20openLibraryInTab%28aHierarchy%29%20%7B%0A%20%20let%20URI%20%3D%20%22chrome%3A//browser/content/places/places.xul%22%3B%0A%0A%20%20//%20This%20can%20be%20passed%20either%20nsIURI%20or%20a%20string.%0A%20%20if%20%28%21%28URI%20instanceof%20Ci.nsIURI%29%29%0A%20%20%20%20URI%20%3D%20Services.io.newURI%28URI%2C%20null%2C%20null%29%3B%0A%0A%20%20let%20isBrowserWindow%20%3D%20%21%21window.gBrowser%3B%0A%0A%20%20//%20Prioritise%20this%20window.%0A%20%20if%20%28isBrowserWindow%20%26%26%20switchIfURIInWindow%28window%2C%20URI%29%29%20%7B%0A%20%20%20%20showPlacesPanel%28window.getBrowser%28%29.selectedBrowser%2C%20aHierarchy%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%0A%20%20let%20winEnum%20%3D%20Services.wm.getEnumerator%28%22navigator%3Abrowser%22%29%3B%0A%20%20while%20%28winEnum.hasMoreElements%28%29%29%20%7B%0A%20%20%20%20let%20browserWin%20%3D%20winEnum.getNext%28%29%3B%0A%20%20%20%20//%20Skip%20closed%20%28but%20not%20yet%20destroyed%29%20windows%2C%0A%20%20%20%20//%20and%20the%20current%20window%20%28which%20was%20checked%20earlier%29.%0A%20%20%20%20if%20%28browserWin.closed%20%7C%7C%20browserWin%20%3D%3D%20window%29%20%7B%0A%20%20%20%20%20%20openLinkIn%28URI.spec%2C%20%22tab%22%2C%20%7BfromChrome%3Atrue%7D%29%3B%0A%20%20%20%20%20%20browserWin.addEventListener%28%22pageshow%22%2C%20function%20browserWinPageShow%28event%29%20%7B%0A%20%20%20%20%20%20%20%20if%20%28event.target.location.href%20%21%3D%20URI.spec%29%0A%20%20%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%20%20browserWin.removeEventListener%28%22pageshow%22%2C%20browserWinPageShow%2C%20true%29%3B%0A%20%20%20%20%20%20%20%20showPlacesPanel%28browserWin.getBrowser%28%29.selectedBrowser%2C%20aHierarchy%29%3B%0A%20%20%20%20%20%20%7D%2C%20true%29%0A%20%20%20%20%7D%0A%20%20%20%20if%20%28switchIfURIInWindow%28browserWin%2C%20URI%29%29%0A%20%20%20%20%20%20return%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20newMenuitem%28aLabel%2C%20aValue%29%20%7B%0A%20%20let%20menuitem%20%3D%20document.createElement%28%22menuitem%22%29%3B%0A%20%20menuitem.setAttribute%28%22label%22%2C%20aLabel%29%3B%0A%20%20menuitem.setAttribute%28%22value%22%2C%20aValue%29%3B%0A%20%20return%20menuitem%3B%0A%7D%0A%0Alet%20popup%20%3D%20this.appendChild%28document.createElement%28%22menupopup%22%29%29%3B%0Apopup.openLibraryInTab%20%3D%20openLibraryInTab.bind%28%29%3B%0Apopup.setAttribute%28%22oncommand%22%2C%20%22openLibraryInTab%28event.target.value%29%3B%22%29%3B%0A%0A%5B%0A%20%20%7B%20label%3A%20%22History%22%2C%20%20%20%20%20%20%20%20%20%20%20%20%20value%3A%20%22History%22%20%7D%2C%0A%20%20%7B%20label%3A%20%22Downloads%22%2C%20%20%20%20%20%20%20%20%20%20%20value%3A%20%22Downloads%22%20%7D%2C%0A%20%20%7B%20label%3A%20%22Tags%22%2C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%3A%20%22Tags%22%20%7D%2C%0A%20%20%7B%20label%3A%20%22All%20Bookmarks%22%2C%20%20%20%20%20%20%20value%3A%20%22AllBookmarks%22%20%7D%2C%0A%20%20%7B%20label%3A%20%22Bookmarks%20Toolbar%22%2C%20%20%20value%3A%20%22BookmarksToolbar%22%20%7D%2C%0A%20%20%7B%20label%3A%20%22Bookmarks%20Menu%22%2C%20%20%20%20%20%20value%3A%20%22BookmarksMenu%22%20%7D%2C%0A%20%20%7B%20label%3A%20%22Unsorted%20Bookmarks%22%2C%20%20value%3A%20%22UnfiledBookmarks%22%20%7D%0A%5D.forEach%28function%28aItem%29%20%7B%0A%20%20popup.appendChild%28newMenuitem%28aItem.label%2C%20aItem.value%29%29%3B%0A%7D%29%0A%0Athis.appendChild%28popup%29%3B%0Athis.type%20%3D%20%22menu%22%3B%0A%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5B//%20http%3A//forums.mozillazine.org/viewtopic.php%3Fp%3D13105961%23p13105961%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Install Library">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/?src=external-custombuttons-xml">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.sourceforge.net/forum/viewtopic.php?t=78#p197">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>
  <name>Library</name>
  <image><![CDATA[custombuttons-stdicon-1]]></image>
  <mode>0</mode>
  <initcode><![CDATA[function showPlacesPanel(aBrowser, aHierarchy) {
  let win = aBrowser.contentWindow;
  let PlacesOrganizer = win.wrappedJSObject.PlacesOrganizer;

  if ("selectLeftPaneContainerByHierarchy" in PlacesOrganizer)
    // Fx 25+
    PlacesOrganizer.selectLeftPaneContainerByHierarchy(aHierarchy);
  else
    PlacesOrganizer.selectLeftPaneQuery(aHierarchy)

  win.focus();
}

// This will switch to the tab in aWindow having aURI, if present.
function switchIfURIInWindow(aWindow, aURI) {
  if ("PrivateBrowsingUtils" in window) { // Fx 20+
    // Only switch to the tab if neither the source and desination window are
    // private and they are not in permanent private borwsing mode
    if ((PrivateBrowsingUtils.isWindowPrivate(window) ||
        PrivateBrowsingUtils.isWindowPrivate(aWindow)) &&
        !PrivateBrowsingUtils.permanentPrivateBrowsing) {
      return false;
    }
  }

  let browsers = aWindow.gBrowser.browsers;
  for (let i = 0; i < browsers.length; i++) {
    let browser = browsers[i];
    if (browser.currentURI.equals(aURI)) {
      // Focus the matching window & tab
      aWindow.focus();
      aWindow.gBrowser.tabContainer.selectedIndex = i;
      return true;
    }
  }
  return false;
}

/**
 * Open Library in Tab.
 *
 * @param aHierarchy A single container or an array of containers, sorted from
 *                   the outmost to the innermost in the hierarchy. Each
 *                   container may be either an item id, a Places URI string,
 *                   or a named query.
 *                   Supported named queries are:
 *                   - AllBookmarks         - History
 *                   - BookmarksMenu        - Tags
 *                   - BookmarksToolbar     - UnfiledBookmarks
 *                   - Downloads
 */
function openLibraryInTab(aHierarchy) {
  let URI = "chrome://browser/content/places/places.xul";

  // This can be passed either nsIURI or a string.
  if (!(URI instanceof Ci.nsIURI))
    URI = Services.io.newURI(URI, null, null);

  let isBrowserWindow = !!window.gBrowser;

  // Prioritise this window.
  if (isBrowserWindow && switchIfURIInWindow(window, URI)) {
    showPlacesPanel(window.getBrowser().selectedBrowser, aHierarchy);
    return;
  }

  let winEnum = Services.wm.getEnumerator("navigator:browser");
  while (winEnum.hasMoreElements()) {
    let browserWin = winEnum.getNext();
    // Skip closed (but not yet destroyed) windows,
    // and the current window (which was checked earlier).
    if (browserWin.closed || browserWin == window) {
      openLinkIn(URI.spec, "tab", {fromChrome:true});
      browserWin.addEventListener("pageshow", function browserWinPageShow(event) {
        if (event.target.location.href != URI.spec)
          return;
        browserWin.removeEventListener("pageshow", browserWinPageShow, true);
        showPlacesPanel(browserWin.getBrowser().selectedBrowser, aHierarchy);
      }, true)
    }
    if (switchIfURIInWindow(browserWin, URI))
      return;
  }
}

function newMenuitem(aLabel, aValue) {
  let menuitem = document.createElement("menuitem");
  menuitem.setAttribute("label", aLabel);
  menuitem.setAttribute("value", aValue);
  return menuitem;
}

let popup = this.appendChild(document.createElement("menupopup"));
popup.openLibraryInTab = openLibraryInTab.bind();
popup.setAttribute("oncommand", "openLibraryInTab(event.target.value);");

[
  { label: "History",             value: "History" },
  { label: "Downloads",           value: "Downloads" },
  { label: "Tags",                value: "Tags" },
  { label: "All Bookmarks",       value: "AllBookmarks" },
  { label: "Bookmarks Toolbar",   value: "BookmarksToolbar" },
  { label: "Bookmarks Menu",      value: "BookmarksMenu" },
  { label: "Unsorted Bookmarks",  value: "UnfiledBookmarks" }
].forEach(function(aItem) {
  popup.appendChild(newMenuitem(aItem.label, aItem.value));
})

this.appendChild(popup);
this.type = "menu";
]]></initcode>
  <code><![CDATA[// http://forums.mozillazine.org/viewtopic.php?p=13105961#p13105961
]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[]]></help>
  <attributes/>
</custombutton>