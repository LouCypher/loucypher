<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Clipboard Viewer]]></html:title>
    <html:link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAArdJREFUeNpsU11IU2EYfs/Zt+Vy7sfKEZEp2pxmF2uKUVhq2VKwTB0FmT8FCUbgpTddBWFBICJRgVleRC5GUeRNpPZj+bfMrJZhajeWRTPa2mTnr/c77Iyj9cLD2fd97/PsOc/7HQawytMQW0AuhoF49a+rzmQYZp+yliTpSclP74yybh6QgHTuhdV1DeGkP6zPvNAyNONUDtp3Z/pgW7zPh2hiRQlADUEE5373SafVnu888eCtUxBYMBiMQJ90TffpOe2jKoQX/nEAtuYumOjthZHRp2A0GsGQmAgcx0EwGIQNpa1gq6qCR7dvyL1E+I9AKBKBEpcLvi0sANFoQMOywCJopaWno1MJFB6J8iu4DA3x+9ISrDebIctmkzcpQRRFWYRHJouinCLA8Wo2FG+0O/TJJhPf4/WOdns8U5i8VFdTk9vgdheggpbFJoLgYzyCYajrWPHZtk2evr6Rx2P+F1cvX8+gmxeudL7UaO+LtZWVeyLoQK9ywFIHKmRt3r7T8LC/f+xIZUPq5x98AkXt0VMZjwYHx3FIEF5eBh5fR3G+OgOgTSaLhUvS60hOqnkN3fsaCILRYokKSPyDAScmJYHCW+1gen5iOOQuK8t///GVP4FI4lotML6pockql2tHMByGZRyngKHGHYTCqIIT0hI5xPEv/g+HDzSeKdTqXgudd3ue0xALHY5d+dnZJfM41hSrFTSEwK9gTIDePpaRBSoKqutbXadbUu51tC+mZufkna+rK6JN/pHh0MXy0k+zkxMR5VXxT32ygDxnERodh+rPHb90M72rpWGur/tWW+A35OFRVqx/GnFHw8IAQooTaeXqAWpMME6tdjTVzxYZoMKuwxsHK2FWBZ2MjrcS+esE8g5D1fHgPahjYBHA84aDOeyxI6IILvaMqtZ8AC9mIBbiXwEGADy0Lb/f2n5rAAAAAElFTkSuQmCC"/>
    <html:style type="text/css"><![CDATA[
body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
}
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-color: rgb(85, 168, 2);
  background-image: linear-gradient(to bottom, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -moz-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -o-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -webkit-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  border: 1px solid rgb(58, 116, 4);
  border-radius: .5em;
  -moz-border-radius: .5em;
  -webkit-border-radius: .5em;
  padding: 0;
  margin-bottom: 1em;
  box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -moz-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -o-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -webkit-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
}
#button a {
  color: #000;
  text-shadow: -1pt -1px 0pt rgba(255, 255, 255, .5);
  padding: 1em;
  text-decoration: none;
}
:-moz-any-link:focus {
  color: white;
  outline-color: transparent;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
date, image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3EClipboard%20Viewer%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bdata%3Aimage/png%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAArdJREFUeNpsU11IU2EYfs/Zt+Vy7sfKEZEp2pxmF2uKUVhq2VKwTB0FmT8FCUbgpTddBWFBICJRgVleRC5GUeRNpPZj+bfMrJZhajeWRTPa2mTnr/c77Iyj9cLD2fd97/PsOc/7HQawytMQW0AuhoF49a+rzmQYZp+yliTpSclP74yybh6QgHTuhdV1DeGkP6zPvNAyNONUDtp3Z/pgW7zPh2hiRQlADUEE5373SafVnu888eCtUxBYMBiMQJ90TffpOe2jKoQX/nEAtuYumOjthZHRp2A0GsGQmAgcx0EwGIQNpa1gq6qCR7dvyL1E+I9AKBKBEpcLvi0sANFoQMOywCJopaWno1MJFB6J8iu4DA3x+9ISrDebIctmkzcpQRRFWYRHJouinCLA8Wo2FG+0O/TJJhPf4/WOdns8U5i8VFdTk9vgdheggpbFJoLgYzyCYajrWPHZtk2evr6Rx2P+F1cvX8+gmxeudL7UaO+LtZWVeyLoQK9ywFIHKmRt3r7T8LC/f+xIZUPq5x98AkXt0VMZjwYHx3FIEF5eBh5fR3G+OgOgTSaLhUvS60hOqnkN3fsaCILRYokKSPyDAScmJYHCW+1gen5iOOQuK8t///GVP4FI4lotML6pockql2tHMByGZRyngKHGHYTCqIIT0hI5xPEv/g+HDzSeKdTqXgudd3ue0xALHY5d+dnZJfM41hSrFTSEwK9gTIDePpaRBSoKqutbXadbUu51tC+mZufkna+rK6JN/pHh0MXy0k+zkxMR5VXxT32ygDxnERodh+rPHb90M72rpWGur/tWW+A35OFRVqx/GnFHw8IAQooTaeXqAWpMME6tdjTVzxYZoMKuwxsHK2FWBZ2MjrcS+esE8g5D1fHgPahjYBHA84aDOeyxI6IILvaMqtZ8AC9mIBbiXwEGADy0Lb/f2n5rAAAAAElFTkSuQmCC%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5BgCBClipboardViewer%20%3D%20this%3B%20//%20global%20obj%0Athis.toString%20%3D%20function%20toString%28%29%20%7Breturn%20this.name%3B%7D%0A%0Athis.xurl%20%3D%20%22data%3Aapplication/vnd.mozilla.xul+xml%3Bbase64%2C%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20encodeURIComponent%28btoa%28this.Help%29%29%3B%0A%0Athis.panel%20%3D%20false%3B%0A%0Athis.onclick%20%3D%20function%28aEvent%29%20%7B%0A%20%20if%20%28aEvent.button%20%3D%3D%201%29%20%7B%20//%20Middle%20click%0A%20%20%20%20this.togglePanel%28%29%3B%20%20%20%20%20//%20open%20in%20bottom%20panel%0A%20%20%7D%0A%20%20else%20if%20%28aEvent.shiftKey%29%20%7B%20%20%20//%20Shift+left-click%0A%20%20%20%20aEvent.preventDefault%28%29%3B%0A%20%20%20%20this.toggleSidebar%28%29%3B%20%20%20%20%20%20%20//%20open%20in%20sidebar%0A%20%20%7D%0A%20%20//%20This%20won%27t%20work%20for%20data%3AURI%20XUL%20on%20Firefox%204%0A%20%20else%20if%20%28%28aEvent.ctrlKey%20%20%7C%7C%20aEvent.metaKey%29%20%26%26%20//%20if%20Ctrl+left-click%0A%20%20%20%20%20%20%20%20%20%20%20%28%28Application.version%20%3C%20%224.0%22%29%20%7C%7C%20%20//%20if%20Firefox%20prior%20to%20version%204%0A%20%20%20%20%20%20%20%20%20%20%20%20%28/%5Echrome%5C%3A/.test%28this.xurl%29%29%29%29%20%7B%20%20%20%20%20//%20if%20chrome%20URL%0A%20%20%20%20aEvent.preventDefault%28%29%3B%0A%20%20%20%20var%20tabs%20%3D%20gBrowser.mTabs%3B%0A%20%20%20%20for%20%28var%20i%20%3D%200%3B%20i%20%3C%20tabs.length%3B%20i++%29%20%7B%0A%20%20%20%20%20%20if%20%28tabs%5Bi%5D.linkedBrowser.currentURI.spec%20%3D%3D%20this.xurl%29%20%7B%0A%20%20%20%20%20%20%20%20gBrowser.selectedTab%20%3D%20tabs%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20gBrowser.loadOneTab%28this.xurl%2C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20open%20in%20new%20tab%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20null%2C%20null%2C%20null%2C%20false%29%3B%0A%20%20%7D%0A%7D%0A%0Athis.info%20%3D%20%22%5Cn%5C%0ALeft-click%3A%20open%20in%20new%20window%5Cn%5Cn%5C%0AMiddle-click%3A%20open%20in%20bottom%20panel%5Cn%5Cn%5C%0AShift+click%3A%20open%20in%20sidebar%5Cn%5Cn%5C%0ACtrl+click%3A%20open%20in%20new%20tab%5Cn%5C%0A%28for%20Firefox%20prior%20to%20version%204%20only%29%5Cn%5Cn%22%3B%0A%0Afunction%20%24%28aId%29%20%7B%0A%20%20return%20document.getElementById%28aId%29%3B%0A%7D%0A%0Athis.togglePanel%20%3D%20function%28%29%20%7B%0A%20%20this.panel%20%3D%20%21this.panel%3B%0A%20%20%24%28this.id%20+%20%22-splitter%22%29.hidden%20%3D%20%21this.panel%3B%0A%20%20%24%28this.id%20+%20%22-panel%22%29.hidden%20%3D%20%21this.panel%3B%0A%20%20%24%28this.id%20+%20%22-iframe%22%29.setAttribute%28%22src%22%2C%20this.panel%20%3F%20this.xurl%20%3A%20%22%22%29%3B%0A%7D%0A%0Athis.toggleSidebar%20%3D%20function%28%29%20%7B%0A%20%20//var%20title%20%3D%20%24%28%22sidebar-title%22%29.getAttribute%28%22value%22%29%0A%20%20//%24%28%22sidebar-title%22%29.setAttribute%28%22value%22%2C%20%28title%20%3D%3D%20%22%22%29%20%3F%20this.label%20%3A%20%22%22%29%3B%0A%20%20toggleSidebar%28this.id%20+%20%22-sidebar%22%29%3B%0A%7D%0A%0Athis.checkForCBWindow%20%3D%20function%28%29%20%7B%0A%20%20var%20ww%20%3D%20Components.classes%5B%22@mozilla.org/embedcomp/window-watcher%3B1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getService%28Components.interfaces.nsIWindowWatcher%29%3B%0A%20%20var%20em%20%3D%20ww.getWindowEnumerator%28%29%3B%0A%20%20var%20winName%20%3D%20%22clipview%22%3B%0A%20%20var%20index%20%3D%201%3B%0A%20%20while%20%28em.hasMoreElements%28%29%29%20%7B%0A%20%20%20%20let%20win%20%3D%20em.getNext%28%29%3B%0A%20%20%20%20if%28win.name%20%3D%3D%20winName%29%20%7B%0A%20%20%20%20%20%20win.focus%28%29%3B%0A%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20index++%0A%20%20%7D%0A%20%20return%20false%3B%0A%7D%0A%0Athis.showTooltip%20%3D%20function%28aNode%29%20%7B%0A%20%20var%20win%20%3D%20this.checkForCBWindow%28%29%3B%0A%20%20if%20%28win%20%7C%7C%20this.opened%29%20%7B%0A%20%20%20%20aNode.label%20%3D%20this.info%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20aNode.label%20%3D%20readFromClipboard%28%29%20%3F%20readFromClipboard%28%29%20%3A%20this.info%3B%0A%7D%0A%0Afunction%20%24xml%28aNode%2C%20aId%2C%20aXML%29%20%7B%0A%20%20var%20node%20%3D%20%24%28aId%29%3B%0A%20%20node%20%26%26%20node.parentNode.removeChild%28node%29%3B%0A%20%20aNode%20%26%26%20aNode.appendChild%28cbu.makeXML%28aXML%29%29%0A%7D%0A%0A%24xml%28%24%28%22mainBroadcasterSet%22%29%2C%0A%20%20%20%20%20%20%20this.id%20+%20%22-sidebar%22%2C%0A%20%20%20%20%20%20%20%20%3Cbroadcaster%20xmlns%3D%7Bxulns%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7Bthis.id%20+%20%22-sidebar%22%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D%7Bthis.label%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sidebartitle%3D%7Bthis.label%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sidebarurl%3D%7Bthis.xurl%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3D%22checkbox%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20autoCheck%3D%22false%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20group%3D%22sidebar%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%22gCBClipboardViewer.toggleSidebar%28%29%3B%22%20/%3E%29%3B%0A%0A%24xml%28%24%28%22viewSidebarMenu%22%29%2C%0A%20%20%20%20%20%20%20this.id%20+%20%22-viewsidebar%22%2C%0A%20%20%20%20%20%20%20%3Cmenuitem%20xmlns%3D%7Bxulns%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7Bthis.id%20+%20%22-viewsidebar%22%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20observes%3D%7Bthis.id%20+%20%22-sidebar%22%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D%7Bthis.label%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sidebartitle%3D%7Bthis.label%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sidebarurl%3D%7Bthis.xurl%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3D%22checkbox%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20autoCheck%3D%22false%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20group%3D%22sidebar%22%20/%3E%29%3B%0A%0A%24xml%28%24%28%22appcontent%22%29%2C%0A%20%20%20%20%20%20%20this.id%20+%20%22-splitter%22%2C%0A%20%20%20%20%20%20%20%3Csplitter%20xmlns%3D%7Bxulns%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7Bthis.id%20+%20%22-splitter%22%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20orient%3D%22vertical%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hidden%3D%22true%22%3E%0A%20%20%20%20%20%20%20%20%20%3Cgrippy%20oncommand%3D%7B%22this.parentNode.nextSibling.collapsed%20%3D%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%21this.parentNode.nextSibling.collapsed%3B%22%7D/%3E%0A%20%20%20%20%20%20%20%3C/splitter%3E%29%3B%0A%0A%24xml%28%24%28%22appcontent%22%29%2C%0A%20%20%20%20%20%20%20this.id%20+%20%22-panel%22%2C%0A%20%20%20%20%20%20%20%3Cvbox%20xmlns%3D%7Bxulns%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7Bthis.id%20+%20%22-panel%22%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20height%3D%22300%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20hidden%3D%22true%22%3E%0A%20%20%20%20%20%20%20%20%20%3Ctoolbox%3E%0A%20%20%20%20%20%20%20%20%20%20%20%3Ctoolbar%20align%3D%22center%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%20value%3D%7Bthis.label%7D%20flex%3D%221%22%20crop%3D%22end%22%20/%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctoolbarbutton%20class%3D%22tabs-closebutton%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%22gCBClipboardViewer.togglePanel%28%29%3B%22%20/%3E%0A%20%20%20%20%20%20%20%20%20%20%20%3C/toolbar%3E%0A%20%20%20%20%20%20%20%20%20%3C/toolbox%3E%0A%20%20%20%20%20%20%20%20%20%3Ciframe%20id%3D%7Bthis.id%20+%20%22-iframe%22%7D%20src%3D%22%22%20flex%3D%221%22%20/%3E%0A%20%20%20%20%20%20%20%3C/vbox%3E%29%3B%0A%0A%0A%0A//%20Custom%20Tooltip%0A//%20http%3A//custombuttons.mozdev.org/drupal/node/645%0A%0Avar%20tooltip%20%3D%20this.appendChild%28document.createElement%28%22tooltip%22%29%29%3B%0Atooltip.style.MozAppearance%20%3D%20%22none%22%3B%0Atooltip.style.background%20%3D%20%22menu%22%3B%0Atooltip.style.color%20%3D%20%22menutext%22%3B%0Atooltip.style.opacity%20%3D%20%22.9%22%3B%0Atooltip.style.border%20%3D%20%221px%20solid%20menutext%22%3B%0Atooltip.style.borderRadius%20%3D%20%225px%22%3B%0Atooltip.style.MozBorderRadius%20%3D%20%225px%22%3B%0Atooltip.style.fontFamily%20%3D%20%22monospace%22%3B%0Atooltip.style.fontSize%20%3D%20%22medium%22%3B%0Atooltip.style.maxWidth%20%3D%20%28screen.width%20/%202%29%20+%20%22px%22%3B%0Atooltip.style.maxHeight%20%3D%20%28screen.height%20/%202%29%20+%20%22px%22%3B%20//%20not%20working%0Atooltip.style.padding%20%3D%20%221em%22%3B%0Atooltip.setAttribute%28%22onpopupshowing%22%2C%20%22this.parentNode.showTooltip%28this%29%3B%22%29%3B%0A%0Athis.removeAttribute%28%22tooltiptext%22%29%3B%0Athis.tooltip%20%3D%20%22_child%22%3B%0A%0A%0A////////////////////////////////////////////////////////////////////////////%0A//////////////////////////////%20Button%20updater%20//////////////////////////////%0A////////////////////////////////////////////////////////////////////////////%0A%0A/*%20*****%20BEGIN%20LICENSE%20BLOCK%20*****%0A%20*%20Version%3A%20MPL%201.1/GPL%202.0/LGPL%202.1%0A%20*%0A%20*%20The%20contents%20of%20this%20file%20are%20subject%20to%20the%20Mozilla%20Public%20License%0A%20*%20Version%201.1%20%28the%20%22License%22%29%3B%20you%20may%20not%20use%20this%20file%20except%20in%0A%20*%20compliance%20with%20the%20License.%20You%20may%20obtain%20a%20copy%20of%20the%20License%20at%0A%20*%20http%3A//www.mozilla.org/MPL/%0A%20*%0A%20*%20Software%20distributed%20under%20the%20License%20is%20distributed%20on%20an%20%22AS%20IS%22%20basis%2C%0A%20*%20WITHOUT%20WARRANTY%20OF%20ANY%20KIND%2C%20either%20express%20or%20implied.%20See%20the%20License%0A%20*%20for%20the%20specific%20language%20governing%20rights%20and%20limitations%20under%20the%0A%20*%20License.%0A%20*%0A%20*%20Original%20code%20is%20Button%20Updater%20for%20Custom%20Buttons%20extension%0A%20*%0A%20*%20The%20Initial%20Developer%20of%20the%20Original%20Code%20is%20LouCypher.%0A%20*%20Portions%20created%20by%20the%20Initial%20Developer%20are%20Copyright%20%28C%29%202011%0A%20*%20the%20Initial%20Developer.%20All%20Rights%20Reserved.%0A%20*%0A%20*%20Contributor%28s%29%3A%0A%20*%20-%20LouCypher%3A%20original%20code%0A%20*%0A%20*%20Alternatively%2C%20the%20contents%20of%20this%20file%20may%20be%20used%20under%20the%20terms%20of%0A%20*%20either%20the%20GNU%20General%20Public%20License%20Version%202%20or%20later%20%28the%20%22GPL%22%29%2C%0A%20*%20in%20which%20case%20the%20provisions%20of%20the%20GPL%20are%20applicable%20instead%20of%20those%0A%20*%20above.%0A%20*%0A%20*%20*****%20END%20LICENSE%20BLOCK%20*****%20*/%0A%0Athis.updateURL%20%3D%20%22https%3A//loucypher.googlecode.com/svn/custombuttons/xml/%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Clipboard%2520Viewer.xml%22%3B%0A%0Avar%20btnClick%20%3D%20this.onclick%3B%0Avar%20btnIcon%20%3D%20this.image%3B%0A%0Athis.updater%20%3D%20%7B%0A%0A%20%20get%20bsyIcon%28%29%20%7B%0A%20%20%20%20return%20%20Application.name%20%3D%3D%20%22Firefox%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%3F%20Application.version%20%3E%3D%20%224%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3F%20%22chrome%3A//browser/skin/tabbrowser/connecting.png%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%22chrome%3A//global/skin/icons/loading_16.png%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%3A%20Application.name%20%3D%3D%20%22SeaMonkey%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3F%20%22chrome%3A//communicator/skin/icons/loading.gif%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%22chrome%3A//custombuttons/skin/button.png%22%3B%0A%20%20%7D%2C%0A%0A%20%20isValidCbURI%3A%20function%20isValidCbURI%28aURL%29%20%7B%0A%20%20%20%20if%20%28%21aURL%29%20return%20false%3B%0A%20%20%20%20return%20/%5Ecustombutton%5C%3A%5C/%5C//.test%28aURL%29%3B%0A%20%20%7D%2C%0A%0A%20%20convertURItoDOM%3A%20function%20convertURItoDOM%28aURL%29%20%7B%0A%20%20%20%20if%20%28%21this.isValidCbURI%28aURL%29%29%20%7B%0A%20%20%20%20%20%20custombuttons.alertBox%28self.name%2C%20%22Not%20a%20Custom%20Buttons%20link%21%22%29%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20string%20%3D%20unescape%28aURL.replace%28/%5Ecustombutton%5C%3A%5C/%5C//%2C%20%22%22%29.toString%28%29%29%3B%0A%20%20%20%20var%20parser%20%3D%20new%20DOMParser%28%29%3B%0A%20%20%20%20var%20dom%20%3D%20parser.parseFromString%28string%2C%20%22text/xml%22%29%3B%0A%20%20%20%20if%20%28dom.documentElement.nodeName%20%3D%3D%20%22parsererror%22%29%20%7B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20return%20dom.documentElement%3B%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%0A%20%20getParamValue%3A%20function%20getParamValue%28aDocument%2C%20aNodeName%29%20%7B%0A%20%20%20%20var%20node%20%3D%20aDocument.querySelector%28aNodeName%29%3B%0A%20%20%20%20if%20%28%21node%29%20return%20%22%22%3B%0A%20%20%20%20if%20%28%21node.firstChild%20%7C%7C%20%28node.firstChild%20%26%26%0A%20%20%20%20%20%20%20%20%28node.firstChild.nodeType%20%3D%3D%20node.TEXT_NODE%29%29%29%20%7B%0A%20%20%20%20%20%20return%20node.textContent%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20return%20node.firstChild.textContent%3B%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%0A%20%20getButtonParameters%3A%20function%20getButtonParameters%28aButtonLink%2C%20aURL%29%20%7B%0A%20%20%20%20var%20dom%20%3D%20this.convertURItoDOM%28aURL%29%3B%0A%20%20%20%20var%20params%20%3D%20custombuttons.cbService.getButtonParameters%28aButtonLink%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.wrappedJSObject%3B%0A%20%20%20%20params.name%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22name%22%29%0A%20%20%20%20params.image%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22image%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.getParamValue%28dom%2C%20%22stdicon%22%29%3B%0A%20%20%20%20params.code%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22code%22%29%0A%20%20%20%20params.initCode%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22initcode%22%29%0A%20%20%20%20params.help%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22help%22%29%0A%20%20%20%20params.accelkey%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22accelkey%22%29%0A%20%20%20%20params.mode%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22mode%22%29%0A%20%20%20%20params.wrappedJSObject%20%20%3D%20params%3B%0A%20%20%20%20return%20params%3B%0A%20%20%7D%2C%0A%0A%20%20resetAttributes%3A%20function%20resetAttributes%28%29%20%7B%0A%20%20%20%20self.image%20%3D%20btnIcon%3B%0A%20%20%20%20self.removeAttribute%28%22busy%22%29%3B%0A%20%20%20%20self.removeAttribute%28%22tooltiptext%22%29%3B%0A%20%20%20%20self.onclick%20%3D%20btnClick%3B%0A%20%20%7D%2C%0A%0A%20%20checkForUpdate%3A%20function%20checkForUpdate%28aCallback%29%20%7B%0A%20%20%20%20var%20url%20%3D%20self.updateURL%20+%20%22%3F%22%20+%20Date.now%28%29%3B%0A%20%20%20%20var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%20%20%20%20req.open%28%22GET%22%2C%20url%2C%20true%29%3B%0A%20%20%20%20if%20%28self.hasAttribute%28%22busy%22%29%29%20%7B%0A%20%20%20%20%20%20this.resetAttributes%28%29%3B%0A%20%20%20%20%20%20return%0A%20%20%20%20%7D%0A%20%20%20%20var%20updater%20%3D%20this%3B%0A%20%20%20%20req.onreadystatechange%20%3D%20function%20%28aEvent%29%20%7B%0A%20%20%20%20%20%20self.onclick%20%3D%20function%28aEvent%29%20%7B%0A%20%20%20%20%20%20%20%20aEvent.preventDefault%28%29%3B%0A%20%20%20%20%20%20%20%20req.abort%28%29%3B%0A%20%20%20%20%20%20%20%20this.updater.resetAttributes%28%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20self.image%20%3D%20updater.bsyIcon%3B%0A%20%20%20%20%20%20self.setAttribute%28%22busy%22%2C%20%22%22%29%3B%0A%20%20%20%20%20%20self.tooltipText%20%3D%20%22Checking%20for%20update...%5CnClick%20to%20abort.%22%3B%0A%20%20%20%20%20%20if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%20%20%20%20%20%20%20%20updater.resetAttributes%28%29%3B%0A%20%20%20%20%20%20%20%20aCallback%28req.responseXML%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20req.send%28null%29%3B%0A%20%20%7D%2C%0A%0A%20%20getUpdate%3A%20function%20getUpdate%28aDocument%29%20%7B%0A%20%20%20%20if%20%28aDocument.documentElement.localName%20%21%3D%20%22custombutton%22%29%20%7B%0A%20%20%20%20%20%20alert%28%22Not%20a%20valid%20Custom%20Buttons%20XML%20file%21%22%29%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%0A%20%20%20%20let%20button%20%3D%20aDocument.getElementById%28%22button%22%29%3B%0A%20%20%20%20let%20link%20%3D%20button.getElementsByTagNameNS%28%22http%3A//www.w3.org/1999/xhtml%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22a%22%29%5B0%5D%3B%0A%20%20%20%20if%20%28link.href%20%3D%3D%20self.URI%29%20%7B%0A%20%20%20%20%20%20let%20as%20%3D%20Cc%5B%27@mozilla.org/alerts-service%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIAlertsService%29%3B%0A%20%20%20%20%20%20as.showAlertNotification%28btnIcon%2C%20%22No%20update%20found%21%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Finish%20checking%22%2C%20false%2C%20%22%22%2C%20null%29%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%20%0A%20%20%20%20let%20install%20%3D%20custombuttons.confirmBox%28self.name%2C%20%22Update%20found%21%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Update%20%22%20+%20self.name%20+%20%22%3F%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Yes%22%2C%20%22No%22%29%3B%0A%20%20%20%20if%20%28%21install%29%20return%3B%0A%20%20%20%20let%20btnLink%20%3D%20custombuttons.makeButtonLink%28%22update%22%2C%20self.id%29%3B%0A%20%20%20%20let%20params%20%3D%20self.updater.getButtonParameters%28btnLink%2C%20link.href%29%3B%0A%20%20%20%20custombuttons.cbService.installButton%28params%29%3B%0A%20%20%20%20custombuttons.alertBox%28self.name%2C%20%22Button%20updated%21%22%29%3B%0A%20%20%20%20self.setAttribute%28%22cb-edit-state%22%2C%20%22active%22%29%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20addMenuItem%28aNewIDs%2C%20aNodeIDs%2C%20aLabel%2C%20aIcon%2C%20aCommand%2C%20aSeparator%29%20%7B%0A%20%20for%20%28var%20i%20%3D%200%3B%20i%20%3C%20aNewIDs.length%3B%20i++%29%20%7B%0A%20%20%20%20//%20Remove%20previously%20created%20menuitems%20if%20any%0A%20%20%20%20if%20%28%24%28aNewIDs%5Bi%5D%29%29%20%24%28aNewIDs%5Bi%5D%29.parentNode.removeChild%28%24%28aNewIDs%5Bi%5D%29%29%3B%0A%0A%20%20%20%20//%20Added%20%27Export%20to%20XML%27%20menuitem%20to%20CB%20contextmenu%0A%20%20%20%20let%20mi%20%3D%20cbu.makeXML%28%3Cmenuitem%20xmlns%3D%7Bxulns%7D%20id%3D%7BaNewIDs%5Bi%5D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20class%3D%22menuitem-iconic%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20image%3D%7BaIcon%7D%20label%3D%7BaLabel%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%7BaCommand%7D/%3E%29%3B%0A%0A%20%20%20%20if%20%28i%20%3D%3D%200%29%20%7B%0A%20%20%20%20%20%20mi.setAttribute%28%22observes%22%2C%20%22custombuttons-contextbroadcaster-primary%22%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20%24%28aNodeIDs%5Bi%5D%29.parentNode.insertBefore%28mi%2C%20%24%28aNodeIDs%5Bi%5D%29.nextSibling%29%3B%0A%20%20%20%20if%20%28aSeparator%29%20%7B%0A%20%20%20%20%20%20let%20sep%20%3D%20cbu.makeXML%28%3Cmenuseparator%20xmlns%3D%7Bxulns%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7Bmi.id%20+%20%22-separator%22%7D/%3E%29%3B%0A%20%20%20%20%20%20mi.parentNode.insertBefore%28sep%2C%20mi.nextSibling%29%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Alet%20kIDs%20%3D%20%5Bthis.id%20+%20%22-checkForUpdate%22%2C%20this.id%20+%20%22-checkForUpdate-sub%22%5D%3B%0Alet%20uIDs%20%3D%20%5B%22custombuttons-contextpopup-updateButton%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22custombuttons-contextpopup-updateButton-sub%22%5D%3B%0A%0A//%20Add%20%27Check%20for%20Update...%27%20menuitem%20to%20CB%20contextmenu%0AaddMenuItem%28kIDs%2C%20uIDs%2C%20%22Check%20for%20updates%20for%20this%20button%22%2C%20this.image%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22var%20btn%20%3D%20document.getElementById%28%27%22%20+%20this.id%20+%20%22%27%29%3B%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%22btn.updater.checkForUpdate%28btn.updater.getUpdate%29%3B%22%2C%20true%29%3B%0A%0Afunction%20initCbPopup%28%29%20%7B%0A%20%20for%20%28var%20i%20%3D%200%3B%20i%20%3C%20kIDs.length%3B%20i++%29%20%7B%0A%20%20%20%20%24%28kIDs%5Bi%5D%29.hidden%20%3D%20%28document.popupNode%20%21%3D%20self%29%3B%0A%20%20%20%20%28%24%28kIDs%5Bi%5D%29.nextSibling.id%20%3D%3D%20%24%28kIDs%5Bi%5D%29.id%20+%20%22-separator%22%29%20%26%26%0A%20%20%20%20%28%24%28kIDs%5Bi%5D%29.nextSibling.hidden%20%3D%20%28document.popupNode%20%21%3D%20self%29%29%3B%0A%20%20%7D%0A%7D%0A%0A%24%28uIDs%5B0%5D%29.parentNode.addEventListener%28%22popupshowing%22%2C%20initCbPopup%2C%20false%29%3B%0A%24%28uIDs%5B0%5D%29.parentNode.removeEventListener%28%22popuphiding%22%2C%20initCbPopup%2C%20false%29%3B%0A%0A//%20Remove%20contextmenu%20items%20when%20this%20button%20is%20deleted%0Athis.onDestroy%20%3D%20function%28%29%20%7B%0A%20%20%24%28kIDs%5B0%5D%29.parentNode.removeEventListener%28%22popupshowing%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20initCbPopup%2C%20false%29%3B%0A%20%20for%20%28var%20i%20%3D%200%3B%20i%20%3C%202%3B%20i++%29%20%7B%0A%20%20%20%20%24%28kIDs%5Bi%5D%29%20%26%26%20%28%24%28kIDs%5Bi%5D%29.nextSibling.id%20%3D%3D%20%24%28kIDs%5Bi%5D%29.id%20+%20%22-separator%22%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%26%20%24%28kIDs%5Bi%5D%29.parentNode.removeChild%28%24%28kIDs%5Bi%5D%29.nextSibling%29%3B%0A%20%20%20%20%24%28kIDs%5Bi%5D%29%20%26%26%20%24%28kIDs%5Bi%5D%29.parentNode.removeChild%28%24%28kIDs%5Bi%5D%29%29%3B%0A%20%20%7D%0A%7D%0A%0A/////////////////////////////////////////////////////////////////////////////%0A%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5B/*%0A%20%20Changelog%3A%0A%20%20%20%202011-07-05%3A%0A%20%20%20%20%20%20x%20%27Edit%27%20button%20is%20now%20using%20external%20editor%0A%20%20%20%20%20%20+%20Added%20style%0A%20%20%20%20%20%20+%20Added%20button%20updater%20+%20context%20menu%0A%20%20%20%202011-06-18%3A%0A%20%20%20%20%20%20*%20Fixed%20error%20on%20Seamonkey%0A%20%20%20%20%20%20x%20Moved%20XUL%20data%20to%20Help%20section%0A%20%20%20%20%20%20x%20Close%20button%20now%20closes%20bottom%20panel%20if%20it%27s%20loaded%20on%20bottom%20panel%0A%20%20%20%202011-06-13%3A%0A%20%20%20%20%20%20*%20Includes%20XUL%20file%20in%20init%20code.%0A%20%20%20%20%20%20+%20Added%20bottom%20panel%20%28middle-click%20to%20open%29.%0A%20%20%20%20%20%20+%20Added%20%27Edit%27%20button%20to%20edit%20clipboard%20content%20%27directly%27.%0A%20%20%20%20%20%20+%20Ctrl+click%20open%20Clipboard%20Viewer%20in%20new%20tab%20%28Firefox%20prior%20to%20version%204%20only%29.%0A%20%20%20%20%20%20+%20Shift+click%20open%20Clipboard%20Viewer%20in%20sidebar.%0A%20%20%20%202011-05-31%3A%0A%20%20%20%20%20%20x%20Close%20button%20now%20closes%20the%20sidebar%20if%20it%27s%20loaded%20in%20sidebar.%0A%20%20%20%202011-05-30%3A%0A%20%20%20%20%20%20*%20Initial%20release.%0A*/%0A%0A%0Avar%20ww%20%3D%20Components.classes%5B%22@mozilla.org/embedcomp/window-watcher%3B1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getService%28Components.interfaces.nsIWindowWatcher%29%3B%0Avar%20em%20%3D%20ww.getWindowEnumerator%28%29%3B%0Avar%20winName%20%3D%20%22clipview%22%3B%0Avar%20index%20%3D%201%3B%0Awhile%20%28em.hasMoreElements%28%29%29%20%7B%0A%20%20let%20win%20%3D%20em.getNext%28%29%3B%0A%20%20if%28win.name%20%3D%3D%20winName%29%20%7B%0A%20%20%20%20win.focus%28%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20index++%0A%7D%0A%0AopenDialog%28this.xurl%2C%20winName%2C%20%22chrome%2C%20dialog%3Dno%2C%20centerscreen%2C%20minimizable%2C%20resizable%22%29%3B%0A%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%26lt%3B%3Fxml%20version%3D%221.0%22%3F%26gt%3B%0A%26lt%3B%21--%0A%20%20Version%3A%20MPL%201.1/GPL%202.0/LGPL%202.1%0A%0A%20%20The%20contents%20of%20this%20file%20are%20subject%20to%20the%20Mozilla%20Public%20License%20Version%0A%20%201.1%20%28the%20%22License%22%29%3B%20you%20may%20not%20use%20this%20file%20except%20in%20compliance%20with%0A%20%20the%20License.%20You%20may%20obtain%20a%20copy%20of%20the%20License%20at%0A%20%20http%3A//www.mozilla.org/MPL/%0A%0A%20%20Software%20distributed%20under%20the%20License%20is%20distributed%20on%20an%20%22AS%20IS%22%20basis%2C%0A%20%20WITHOUT%20WARRANTY%20OF%20ANY%20KIND%2C%20either%20express%20or%20implied.%20See%20the%20License%0A%20%20for%20the%20specific%20language%20governing%20rights%20and%20limitations%20under%20the%0A%20%20License.%0A%0A%20%20The%20Original%20Code%20is%20Clipboard%20Viewer%0A%0A%20%20The%20Initial%20Developer%20of%20the%20Original%20Code%20is%20LouCypher.%0A%20%20Portions%20created%20by%20the%20Initial%20Developer%20are%20Copyright%20%28C%29%202011%0A%20%20the%20Initial%20Developer.%20All%20Rights%20Reserved.%0A%0A%20%20Contributor%28s%29%3A%0A%20%20-%20LouCypher%20%26lt%3Bloucypher@mozillaca.com%26gt%3B%0A%20%20-%20Alice0775%2C%20external%20editor%0A%0A%20%20Alternatively%2C%20the%20contents%20of%20this%20file%20may%20be%20used%20under%20the%20terms%20of%0A%20%20either%20the%20GNU%20General%20Public%20License%20Version%202%20or%20later%20%28the%20%22GPL%22%29%2C%20or%0A%20%20the%20GNU%20Lesser%20General%20Public%20License%20Version%202.1%20or%20later%20%28the%20%22LGPL%22%29%2C%0A%20%20in%20which%20case%20the%20provisions%20of%20the%20GPL%20or%20the%20LGPL%20are%20applicable%20instead%0A%20%20of%20those%20above.%20If%20you%20wish%20to%20allow%20use%20of%20your%20version%20of%20this%20file%20only%0A%20%20under%20the%20terms%20of%20either%20the%20GPL%20or%20the%20LGPL%2C%20and%20not%20to%20allow%20others%20to%0A%20%20use%20your%20version%20of%20this%20file%20under%20the%20terms%20of%20the%20MPL%2C%20indicate%20your%0A%20%20decision%20by%20deleting%20the%20provisions%20above%20and%20replace%20them%20with%20the%20notice%0A%20%20and%20other%20provisions%20required%20by%20the%20GPL%20or%20the%20LGPL.%20If%20you%20do%20not%20delete%0A%20%20the%20provisions%20above%2C%20a%20recipient%20may%20use%20your%20version%20of%20this%20file%20under%0A%20%20the%20terms%20of%20any%20one%20of%20the%20MPL%2C%20the%20GPL%20or%20the%20LGPL.%0A--%26gt%3B%0A%0A%26lt%3B%3Fxml-stylesheet%20type%3D%22text/css%22%20href%3D%22chrome%3A//global/skin/%22%3F%26gt%3B%0A%0A%26lt%3Bdialog%20xmlns%3D%22http%3A//www.mozilla.org/keymaster/gatekeeper/there.is.only.xul%22%0A%20%20%20%20%20%20%20%20xmlns%3Ahtml%3D%22http%3A//www.w3.org/1999/xhtml%22%0A%20%20%20%20%20%20%20%20id%3D%22clipboard-viewer%22%0A%20%20%20%20%20%20%20%20width%3D%22800%22%20height%3D%22600%22%0A%20%20%20%20%20%20%20%20title%3D%22Clipboard%20Viewer%22%0A%20%20%20%20%20%20%20%20buttons%3D%22extra1%2C%20extra2%2C%20cancel%22%0A%20%20%20%20%20%20%20%20buttonlabelextra1%3D%22Edit%22%0A%20%20%20%20%20%20%20%20buttonlabelextra2%3D%22Clear%22%0A%20%20%20%20%20%20%20%20buttonlabelcancel%3D%22Close%22%0A%20%20%20%20%20%20%20%20buttonaccesskeyextra1%3D%22E%22%0A%20%20%20%20%20%20%20%20buttonaccesskeyextra2%3D%22r%22%0A%20%20%20%20%20%20%20%20buttonaccesskeycancel%3D%22C%22%0A%20%20%20%20%20%20%20%20ondialogextra1%3D%22edit%28%29%3B%22%0A%20%20%20%20%20%20%20%20ondialogextra2%3D%22clearClipboard%28%29%3B%22%0A%20%20%20%20%20%20%20%20ondialogcancel%3D%22closeDialog%28%29%3B%22%0A%20%20%20%20%20%20%20%20onfocus%3D%22loadFromClipboard%28%29%3B%22%26gt%3B%0A%0A%20%20%26lt%3Bhtml%3Ahead%26gt%3B%0A%20%20%20%20%26lt%3Bhtml%3Astyle%20type%3D%22text/css%22%26gt%3B%0A%20%20%20%20%26lt%3B%21%5BCDATA%5B%23textbox%20%7B%0A%20%20%20%20%20%20font-family%3A%20monospace%3B%20font-size%3A%20medium%3B%20white-space%3A%20pre-wrap%3B%0A%20%20%20%20%7D%5D%5D%26gt%3B%0A%20%20%20%20%26lt%3B/html%3Astyle%26gt%3B%0A%20%20%26lt%3B/html%3Ahead%26gt%3B%0A%0A%20%20%26lt%3Bkeyset%26gt%3B%26lt%3Bkey%20keycode%3D%22VK_F5%22%20oncommand%3D%22loadFromClipboard%28%29%3B%22%20/%26gt%3B%26lt%3B/keyset%26gt%3B%0A%0A%20%20%26lt%3Bpopupset%26gt%3B%0A%20%20%20%20%26lt%3Bmenupopup%20id%3D%22contextmenu%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20onpopupshowing%3D%22popupShowing%28event%29%3B%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20onpopuphiding%3D%22loadFromClipboard%28%29%3B%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%22var%20cmd%20%3D%20event.originalTarget.getAttribute%28%27cmd%27%29%3B%0A%20if%20%28cmd%29%20document.popupNode.parentNode.doCommand%28cmd%29%3B%22%26gt%3B%0A%20%20%20%20%20%20%26lt%3Bmenuitem%20id%3D%22edit-copy%22%20label%3D%22Copy%22%20accesskey%3D%22c%22%20cmd%3D%22cmd_copy%22%20/%26gt%3B%0A%20%20%20%20%20%20%26lt%3B%21--menuitem%20id%3D%22edit-delete%22%20label%3D%22Delete%22%20accesskey%3D%22d%22%20cmd%3D%22cmd_delete%22%20/--%26gt%3B%0A%20%20%20%20%20%20%26lt%3Bmenuseparator%20/%26gt%3B%0A%20%20%20%20%20%20%26lt%3Bmenuitem%20id%3D%22edit-selectAll%22%20label%3D%22Select%20All%22%20accesskey%3D%22a%22%20cmd%3D%22cmd_selectAll%22%20/%26gt%3B%0A%20%20%20%20%26lt%3B/menupopup%26gt%3B%0A%20%20%26lt%3B/popupset%26gt%3B%0A%0A%20%20%26lt%3Btextbox%20id%3D%22textbox%22%20multiline%3D%22true%22%20flex%3D%221%22%0A%20%20%20%20%20%20%20%20%20%20%20onclick%3D%22gmon_edit_mouseclick%28event%29%3B%22%0A%20%20%20%20%20%20%20%20%20%20%20context%3D%22contextmenu%22%20readonly%3D%22%22%20/%26gt%3B%0A%0A%20%20%26lt%3Bscript%20type%3D%22application/x-javascript%22%26gt%3B%26lt%3B%21%5BCDATA%5B%0Aconst%20Cc%20%3D%20Components.classes%3B%0Aconst%20Ci%20%3D%20Components.interfaces%3B%0A%0Aconst%20gTextbox%20%3D%20document.getElementById%28%22textbox%22%29%3B%0A%0Afunction%20getMainwin%28%29%20%7B%0A%20%20if%20%28window.frameElement%29%20%7B%0A%20%20%20%20return%20window.frameElement.ownerDocument.defaultView%3B%0A%20%20%7D%20else%20if%20%28window.opener%29%20%7B%0A%20%20%20%20return%20window.opener%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20return%20Cc%5B%22@mozilla.org/appshell/window-mediator%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20getService%28%29.QueryInterface%28Ci.nsIWindowMediator%29.%0A%20%20%20%20%20%20%20%20%20%20%20getMostRecentWindow%28%22navigator%3Abrowser%22%29%0A%20%20%7D%0A%7D%0A%0Afunction%20readFromClipboard%28%29%20%7B%0A//http%3A//mxr.mozilla.org/mozilla2.0/source/browser/base/content/browser.js%232299%0A%20%20var%20string%3B%0A%20%20try%20%7B%0A%20%20%20%20%20%20var%20clipboard%20%3D%20Cc%5B%22@mozilla.org/widget/clipboard%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIClipboard%29%3B%0A%20%20%20%20%20%20var%20trans%20%3D%20Cc%5B%22@mozilla.org/widget/transferable%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsITransferable%29%3B%0A%20%20%20%20%20%20trans.addDataFlavor%28%22text/unicode%22%29%3B%0A%20%20%20%20%20%20if%20%28clipboard.supportsSelectionClipboard%28%29%29%20%7B%0A%20%20%20%20%20%20%20%20clipboard.getData%28trans%2C%20clipboard.kSelectionClipboard%29%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20clipboard.getData%28trans%2C%20clipboard.kGlobalClipboard%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20data%20%3D%20%7B%7D%3B%0A%20%20%20%20%20%20var%20dataLen%20%3D%20%7B%7D%3B%0A%20%20%20%20%20%20trans.getTransferData%28%22text/unicode%22%2C%20data%2C%20dataLen%29%3B%0A%20%20%20%20%20%20if%20%28data%29%20%7B%0A%20%20%20%20%20%20%20%20data%20%3D%20data.value.QueryInterface%28Ci.nsISupportsString%29%3B%0A%20%20%20%20%20%20%20%20string%20%3D%20data.data.substring%280%2C%20dataLen.value%20/%202%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%7D%20catch%20%28ex%29%20%7B%0A%20%20%7D%0A%20%20return%20string%3B%0A%7D%0A%0Afunction%20loadFromClipboard%28%29%20%7B%0A%20%20var%20string%20%3D%20readFromClipboard%28%29%3B%0A%20%20if%20%28gTextbox.value%20%21%3D%20string%29%20%7B%0A%20%20%20%20if%20%28%21string%29%20%7B%0A%20%20%20%20%20%20gTextbox.value%20%3D%20%22%22%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20gTextbox.value%20%3D%20string%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20gTextbox.selectionStart%20%3D%200%3B%0A%20%20gTextbox.selectionEnd%20%3D%200%3B%0A%20%20//gTextbox.scrollTop%20%3D%200%3B%0A%7D%0A%0Afunction%20copyToClipboard%28aString%29%20%7B%0A%20%20let%20clipboardHelper%20%3D%20Cc%5B%22@mozilla.org/widget/clipboardhelper%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIClipboardHelper%29%3B%0A%20%20clipboardHelper.copyString%28aString%29%3B%0A%7D%0A%0Afunction%20clearClipboard%28%29%20%7B%0A%20%20copyToClipboard%28%22%22%29%3B%0A%20%20gTextbox.value%20%3D%20%22%22%3B%0A%7D%0A%0Afunction%20edit%28%29%20%7B%0A%20%20edittarget%28gTextbox%29%3B%0A%7D%0A%0Afunction%20closeDialog%28%29%20%7B%0A%20%20getMainwin%28%29.gCBClipboardViewer.opened%20%3D%20false%3B%0A%20%20if%20%28window.frameElement%29%20%7B%0A%20%20%20%20switch%20%28window.frameElement.id%29%20%7B%0A%20%20%20%20case%20%22sidebar%22%3A%0A%20%20%20%20%20%20getMainwin%28%29.gCBClipboardViewer.toggleSidebar%28%29%3B%0A%20%20%20%20%20%20break%3B%0A%20%20%20%20default%3A%0A%20%20%20%20%20%20getMainwin%28%29.gCBClipboardViewer.togglePanel%28%29%3B%0A%20%20%20%20%7D%0A%20%20%7D%20else%20%7B%0A%20%20%20%20window.close%28%29%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20popupShowing%28aEvent%29%20%7B%0A%20%20var%20children%20%3D%20aEvent.target.childNodes%3B%0A%20%20for%20%28var%20i%20%3D%200%3B%20i%20%26lt%3B%20children.length%3B%20i++%29%20%7B%0A%20%20%20%20var%20command%20%3D%20children%5Bi%5D.getAttribute%28%22cmd%22%29%3B%0A%20%20%20%20if%20%28command%29%20%7B%0A%20%20%20%20%20%20var%20controller%20%3D%20document.commandDispatcher%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getControllerForCommand%28command%29%3B%0A%20%20%20%20%20%20var%20enabled%20%3D%20controller.isCommandEnabled%28command%29%3B%0A%20%20%20%20%20%20if%20%28enabled%29%20%7B%0A%20%20%20%20%20%20%20%20children%5Bi%5D.removeAttribute%28%22disabled%22%29%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20children%5Bi%5D.setAttribute%28%22disabled%22%2C%20%22true%22%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0A/////////////////////////////////////////////////////////////////////////////%0A//////////////////////////////%20External%20Editor%20//////////////////////////////%0A/////////////////////////////////////////////////////////////////////////////%0A%0Avar%20_tmpdir%3Dnull%2C_dir_separator%2C_os%3B%0Avar%20_ext%2C_encode%2C_target%3D%5B%5D%3B%0A%0Afunction%20editinit%28%29%20%7B%0A%20%20if%20%28window.navigator.platform.toLowerCase%28%29.indexOf%28%22win%22%29%20%21%3D%20-1%29%20%7B%0A%20%20%20%20//%20Windows%20OS%0A%20%20%20%20_dir_separator%20%3D%20%22%5C%5C%22%3B%0A%20%20%20%20_os%20%3D%20%22win%22%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20//%20UNIX/Linux%20OS%0A%20%20%20%20_dir_separator%20%3D%20%22/%22%3B%0A%20%20%20%20_os%20%3D%20%22unix%22%3B%0A%20%20%7D%0A%0A%20%20_ext%20%3D%20%22txt%22%3B%0A%20%20_encode%20%3D%20%22UTF-8%22%3B%0A%20%20_target%20%3D%20%5B%5D%3B%0A%0A%20%20window.addEventListener%28%22unload%22%2C%20edituninit%2C%20false%29%3B%0A%20%20window.addEventListener%28%22unload%22%2C%20function%28%29%20%7B%0A%20%20%20%20document.removeEventListener%28%22focus%22%2C%20checkfocus_window%2C%20true%29%3B%0A%20%20%7D%2C%20false%29%3B%0A%7D%0A%0Afunction%20getEditor%28%29%20%7B%0A%20%20let%20pref%20%3D%20Cc%5B%22@mozilla.org/preferences-service%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIPrefService%29.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20getBranch%28%22custombuttons.ClipboardViewer.%22%29%3B%0A%20%20let%20editor%20%3D%20null%3B%0A%20%20try%20%7B%0A%20%20%20%20editor%20%3D%20pref.getCharPref%28%22external_editor%22%29%3B%0A%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20let%20prompts%20%3D%20Cc%5B%22@mozilla.org/embedcomp/prompt-service%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIPromptService%29%3B%0A%0A%20%20%20%20let%20ask%20%3D%20prompts.confirm%28null%2C%20%22Clipboard%20Viewer%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22You%20must%20choose%20a%20text%20editor%20before%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22using%20this%20feature.%5CnClick%20OK%20to%20continue.%22%29%3B%0A%20%20%20%20if%20%28%21ask%29%20return%20false%3B%0A%0A%20%20%20%20let%20nsIFilePicker%20%3D%20Ci.nsIFilePicker%3B%0A%20%20%20%20let%20filePicker%20%3D%20Cc%5B%22@mozilla.org/filepicker%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28nsIFilePicker%29%3B%0A%20%20%20%20filePicker.init%28window%2C%20%22Select%20editor%22%2C%20nsIFilePicker.modeOpen%29%3B%0A%20%20%20%20filePicker.appendFilters%28nsIFilePicker.filterApplication%29%3B%0A%20%20%20%20filePicker.appendFilters%28nsIFilePicker.filterAll%29%3B%0A%20%20%20%20if%20%28filePicker.show%28%29%20%3D%3D%20nsIFilePicker.returnOK%29%20%7B%0A%20%20%20%20%20%20if%20%28filePicker.file.exists%28%29%20%26amp%3B%26amp%3B%20filePicker.file.isExecutable%28%29%29%20%7B%0A%20%20%20%20%20%20%20%20pref.setCharPref%28%22external_editor%22%2C%20filePicker.file.path%29%3B%0A%20%20%20%20%20%20%20%20editor%20%3D%20filePicker.file.path%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20return%20editor%3B%0A%7D%0A%0Afunction%20edituninit%28%29%20%7B%0A%20%20if%20%28_tmpdir%20%3D%3D%20null%29%20return%3B%0A%20%20var%20windowType%20%3D%20%22navigator%3Abrowser%22%3B%0A%20%20var%20windowManager%20%3D%20Cc%5B%22@mozilla.org/appshell/window-mediator%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28%29%3B%0A%20%20var%20windowManagerInterface%20%3D%20windowManager.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20QueryInterface%28Ci.nsIWindowMediator%29%3B%0A%20%20var%20enumerator%20%3D%20windowManagerInterface.getEnumerator%28windowType%29%3B%0A%20%20if%20%28enumerator.hasMoreElements%28%29%29%20%7B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%0A%20%20var%20file%20%3D%20Cc%5B%22@mozilla.org/file/local%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsILocalFile%29%3B%0A%20%20file.initWithPath%28_tmpdir%29%3B%0A%20%20var%20entries%20%3D%20file.directoryEntries%3B%0A%20%20while%20%28entries.hasMoreElements%28%29%29%20%7B%0A%20%20%20%20var%20entry%20%3D%20entries.getNext%28%29.QueryInterface%28Ci.nsIFile%29%3B%0A%20%20%20%20if%20%28/%5Ecustombuttons%5C./i.test%28entry.leafName%29%29%20%7B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20entry.remove%28false%29%3B%0A%20%20%20%20%20%20%7D%20catch%28e%29%20%7B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20try%20%7B%0A%20%20%20%20if%20%28file.exists%28%29%20%3D%3D%20true%20%29%20%7B%0A%20%20%20%20%20%20file.remove%28false%29%3B%0A%20%20%20%20%7D%0A%20%20%7D%20catch%28e%29%20%7B%0A%20%20%7D%0A%0A%20%20_tmpdir%20%3D%20null%3B%0A%7D%0A%0Afunction%20gmon_edit_mouseclick%28e%29%20%7B%0A%20%20if%20%28e.button%20%21%3D%201%29%20return%3B%0A%20%20var%20target%20%3D%20e.target%3B%0A%20%20edittarget%28target%29%3B%0A%7D%0A%0Afunction%20checkfocus_window%28%29%20%7B%0A%20%20var%20target%2C%20filename%2C%20timestamp%2C%20encode%2C%0A%20%20%20%20%20%20file%2C%20inst%2C%20sstream%2C%20utf%2C%20textBoxText%3B%0A%0A%20%20if%20%28_target.length%26lt%3B%3D0%29%20return%3B%0A%0A%20%20file%20%3D%20Cc%5B%22@mozilla.org/file/local%3B1%22%5D.createInstance%28Ci.nsILocalFile%29%3B%0A%20%20istr%20%3D%20Cc%5B%22@mozilla.org/network/file-input-stream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIFileInputStream%29%3B%0A%0A%20%20//%20FileInputStream%27s%20read%20is%20%5Bnoscript%5D.%0A%20%20sstream%20%3D%20Cc%5B%22@mozilla.org/scriptableinputstream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIScriptableInputStream%29%3B%0A%20%20utf%20%3D%20Cc%5B%22@mozilla.org/intl/utf8converterservice%3B1%22%5D.%0A%20%20%20%20%20%20%20%20createInstance%28Ci.nsIUTF8ConverterService%29%3B%0A%0A%20%20for%20%28var%20i%3D0%3B%20i%20%26lt%3B%20_target.length%3Bi++%29%20%7B%0A%20%20%20%20target%20%3D%20_target%5Bi%5D%3B%0A%20%20%20%20if%20%28%21target.hasAttribute%28%22filename%22%29%29%20continue%3B%0A%20%20%20%20filename%20%3D%20target.getAttribute%28%22filename%22%29%3B%0A%20%20%20%20timestamp%20%3D%20target.getAttribute%28%22timestamp%22%29%3B%0A%20%20%20%20file.initWithPath%28filename%29%3B%0A%20%20%20%20if%20%28%21file.exists%28%29%20%7C%7C%20%21file.isReadable%28%29%29%20continue%3B%0A%20%20%20%20if%20%28file.lastModifiedTime%20%26lt%3B%3D%20timestamp%29%20continue%3B%0A%0A%20%20%20%20target.setAttribute%28%22timestamp%22%2C%20file.lastModifiedTime%29%3B%0A%0A%20%20%20%20istr.init%28file%2C%201%2C%200x400%2C%20false%29%3B%0A%20%20%20%20sstream.init%28istr%29%3B%0A%0A%20%20%20%20textBoxText%20%20%3D%20sstream.read%28sstream.available%28%29%29%3B%0A%20%20%20%20encode%20%3D%20target.getAttribute%28%22encode%22%29%3B%0A%20%20%20%20if%20%28textBoxText.length%29%20%7B%0A%20%20%20%20%20%20copyToClipboard%28utf.convertStringToUTF8%28textBoxText%2C%20encode%2C%20true%29%29%3B%0A%20%20%20%20%20%20target.value%20%3D%20utf.convertStringToUTF8%28textBoxText%2C%20encode%2C%20true%29%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20clearClipboard%28%29%3B%0A%20%20%20%20%20%20target.value%20%3D%20%22%22%3B%0A%20%20%20%20%7D%0A%20%20%20%20sstream.close%28%29%3B%0A%20%20%20%20istr.close%28%29%3B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20file.remove%28false%29%3B%0A%20%20%20%20%7D%20catch%28e%29%20%7B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Afunction%20editfile%28target%2Cfilename%29%20%7B%0A%20%20//%20Figure%20out%20what%20editor%20to%20use.%0A%20%20var%20editor%20%3D%20getEditor%28%29%3B%0A%20%20if%20%28%21editor%29%20return%20false%3B%0A%0A%20%20var%20file%20%3D%20Cc%5B%22@mozilla.org/file/local%3B1%22%5D.createInstance%28Ci.nsILocalFile%29%3B%0A%20%20file.initWithPath%28editor%29%3B%0A%20%20if%20%28%21file.exists%28%29%29%20%7B%0A%20%20%20%20alert%28%22Error_invalid_Editor_file%22%29%3B%0A%20%20%20%20return%20false%3B%0A%20%20%7D%0A%20%20if%20%28%21file.isExecutable%28%29%29%20%7B%0A%20%20%20%20alert%28%22Error_Editor_not_executable%22%29%3B%0A%20%20%20%20return%20false%3B%0A%20%20%7D%0A%20%20target.setAttribute%28%22filename%22%2C%20filename%29%3B%0A%20%20target.setAttribute%28%22timestamp%22%2C%20file.lastModifiedTime%29%3B%0A%0A%20%20//%20Run%20the%20editor.%0A%20%20var%20process%20%3D%20Cc%5B%22@mozilla.org/process/util%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIProcess%29%3B%0A%20%20process.init%28file%29%3B%0A%20%20var%20args%20%3D%20%5Bfilename%5D%3B%0A%20%20process.run%28false%2C%20args%2C%20args.length%29%3B%20%20//%20don%27t%20block%0A%20%20document.addEventListener%28%22focus%22%2C%20checkfocus_window%2C%20true%29%3B%0A%20%20return%20true%3B%0A%7D%0A%0Afunction%20edittarget%28target%29%20%7B%0A%20%20var%20textBoxText%20%3D%20target.value%3B%0A%20%20//%20Get%20filename.%0A%20%20var%20file%20%3D%20Cc%5B%22@mozilla.org/file/local%3B1%22%5D.createInstance%28Ci.nsILocalFile%29%3B%0A%20%20if%20%28target.hasAttribute%28%22filename%22%29%29%20%7B%0A%20%20%20%20var%20filename%20%3D%20target.getAttribute%28%22filename%22%29%3B%0A%20%20%20%20file.initWithPath%28filename%29%3B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20if%28file.exists%28%29%29%20file.remove%28false%29%3B%0A%20%20%20%20%7D%20catch%28e%29%20%7B%0A%20%20%20%20%7D%0A%20%20%7D%20else%20%7B%0A%20%20%20%20var%20filename%20%3D%20TmpFilenameTextarea%28%29%3B%0A%20%20%7D%0A%20%20file.initWithPath%28filename%29%3B%20%20%20%20%0A%20%20file.create%28file.NORMAL_FILE_TYPE%2C%200600%29%3B%0A%0A%20%20//%20Write%20the%20data%20to%20the%20file.%0A%20%20var%20ostr%20%3D%20Cc%5B%22@mozilla.org/network/file-output-stream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIFileOutputStream%29%3B%0A%20%20ostr.init%28file%2C%202%2C%200x200%2C%20false%29%3B%0A%0A%20%20if%28navigator.platform%20%3D%3D%20%22Win32%22%29%20%7B%0A%20%20%20%20//%20Convert%20Unix%20newlines%20to%20standard%20network%20newlines%0A%20%20%20%20textBoxText%20%3D%20textBoxText.replace%28/%5Cn/g%2C%20%22%5Cr%5Cn%22%29%3B%0A%20%20%7D%0A%20%20var%20conv%20%3D%20Cc%5B%22@mozilla.org/intl/saveascharset%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsISaveAsCharset%29%3B%0A%20%20try%20%7B%0A%20%20%20%20conv.Init%28_encode%2C%200%2C%200%29%3B%0A%20%20%20%20textBoxText%20%3D%20conv.Convert%28textBoxText%29%3B%0A%20%20%7D%20catch%28e%29%20%7B%0A%20%20%20%20textBoxText%20%3D%20%22%22%3B%0A%20%20%7D%0A%20%20ostr.write%28textBoxText%2C%20textBoxText.length%29%3B%0A%0A%20%20ostr.flush%28%29%3B%0A%20%20ostr.close%28%29%3B%0A%0A%20%20//%20setup%20target%20info%0A%20%20target.setAttribute%28%22encode%22%2C%20_encode%29%3B%0A%0A%20%20//%20Edit%20the%20file.%0A%20%20if%20%28editfile%28target%2Cfile.path%29%29%20%7B%0A%20%20%20%20_target.push%28target%29%3B%20%20//%20Editting%20target%20array%0A%20%20%7D%0A%7D%0A%0A//Compose%20temporary%20filename%20out%20of%0A//%20%20%20%20-%20tmpdir%20setting%0A//%20%20%20%20-%20document%20url%0A//%20%20%20%20-%20textarea%20name%0A//%20%20%20%20-%20ext%20suffix%0Afunction%20TmpFilenameTextarea%28%29%20%7B%0A%20%20var%20TmpFilename%3B%0A%20%20_tmpdir%20%3D%20gettmpDir%28%29%3B%0A%20%20do%20%7B%0A%20%20%20%20TmpFilename%20%3D%20_tmpdir%20+%20_dir_separator%20+%20%22clipboard.%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Math.floor%28Math.random%28%29%20*%20100000%29%20+%20%22.%22%20+%20_ext%3B%0A%20%20%7D%20while%20%28%21ExistsFile%28TmpFilename%29%29%0A%20%20%20%20return%20TmpFilename%3B%0A%7D%0A%0A//Function%20returns%20true%20if%20given%20filename%20exists%0Afunction%20ExistsFile%28filename%29%20%7B%0A%20%20try%20%7B%0A%20%20%20%20var%20file%20%3D%20Cc%5B%22@mozilla.org/file/local%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsILocalFile%29%3B%0A%20%20%20%20file.initWithPath%28filename%29%3B%0A%20%20%20%20return%20true%3B%0A%20%20%7D%20catch%28e%29%20%7B%0A%20%20%20%20return%20false%3B%0A%20%20%7D%0A%7D%0A%0A/**%0A*%20Returns%20the%20directory%20where%20we%20put%20files%20to%20edit.%0A*%20@returns%20nsILocalFile%20The%20location%20where%20we%20should%20write%20editable%20files.%0A*/%0Afunction%20gettmpDir%28%29%20%7B%0A%20%20/*%20Where%20is%20the%20directory%20that%20we%20use.%20*/%0A%20%20var%20fobj%20%3D%20Cc%5B%22@mozilla.org/file/directory_service%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIProperties%29.get%28%22TmpD%22%2C%20Ci.nsIFile%29%3B%0A%20%20fobj.append%28%22Clipboard_Viewer%22%29%3B%0A%20%20if%20%28%21fobj.exists%28%29%29%20%7B%0A%20%20%20%20fobj.create%28Ci.nsIFile.DIRECTORY_TYPE%2C%20parseInt%28%220700%22%2C%208%29%29%3B%0A%20%20%7D%0A%20%20if%20%28%21fobj.isDirectory%28%29%29%20%7B%0A%20%20%20%20//%20the%20string%20will%20be%20replaced%20locale%20properties%20in%20the%20future%0A%20%20%20%20alert%28%22Having%20a%20problem%20finding%20or%20creating%20directory%3A%20%22+%20fobj.path%29%3B%0A%20%20%7D%0A%20%20return%20fobj.path%3B%0A%7D%0A%0A//////////////////////////////////////////////%0A%0Afunction%20onLoad%28%29%20%7B%0A%20%20getMainwin%28%29.gCBClipboardViewer.opened%20%3D%20true%3B%0A%20%20editinit%28%29%3B%0A%7D%0A%0Awindow.addEventListener%28%22load%22%2C%20onLoad%2C%20false%29%3B%0Awindow.removeEventListener%28%22unload%22%2C%20onLoad%2C%20false%29%3B%0A%0A%20%20%5D%5D%26gt%3B%26lt%3B/script%26gt%3B%0A%0A%26lt%3B/dialog%26gt%3B%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Install Clipboard Viewer">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/?src=external-custombuttons-xml">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.sourceforge.net/forum/viewtopic.php?t=78#p197">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>
  <name>Clipboard Viewer</name>
  <image><![CDATA[data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAArdJREFUeNpsU11IU2EYfs/Zt+Vy7sfKEZEp2pxmF2uKUVhq2VKwTB0FmT8FCUbgpTddBWFBICJRgVleRC5GUeRNpPZj+bfMrJZhajeWRTPa2mTnr/c77Iyj9cLD2fd97/PsOc/7HQawytMQW0AuhoF49a+rzmQYZp+yliTpSclP74yybh6QgHTuhdV1DeGkP6zPvNAyNONUDtp3Z/pgW7zPh2hiRQlADUEE5373SafVnu888eCtUxBYMBiMQJ90TffpOe2jKoQX/nEAtuYumOjthZHRp2A0GsGQmAgcx0EwGIQNpa1gq6qCR7dvyL1E+I9AKBKBEpcLvi0sANFoQMOywCJopaWno1MJFB6J8iu4DA3x+9ISrDebIctmkzcpQRRFWYRHJouinCLA8Wo2FG+0O/TJJhPf4/WOdns8U5i8VFdTk9vgdheggpbFJoLgYzyCYajrWPHZtk2evr6Rx2P+F1cvX8+gmxeudL7UaO+LtZWVeyLoQK9ywFIHKmRt3r7T8LC/f+xIZUPq5x98AkXt0VMZjwYHx3FIEF5eBh5fR3G+OgOgTSaLhUvS60hOqnkN3fsaCILRYokKSPyDAScmJYHCW+1gen5iOOQuK8t///GVP4FI4lotML6pockql2tHMByGZRyngKHGHYTCqIIT0hI5xPEv/g+HDzSeKdTqXgudd3ue0xALHY5d+dnZJfM41hSrFTSEwK9gTIDePpaRBSoKqutbXadbUu51tC+mZufkna+rK6JN/pHh0MXy0k+zkxMR5VXxT32ygDxnERodh+rPHb90M72rpWGur/tWW+A35OFRVqx/GnFHw8IAQooTaeXqAWpMME6tdjTVzxYZoMKuwxsHK2FWBZ2MjrcS+esE8g5D1fHgPahjYBHA84aDOeyxI6IILvaMqtZ8AC9mIBbiXwEGADy0Lb/f2n5rAAAAAElFTkSuQmCC]]></image>
  <mode>0</mode>
  <initcode><![CDATA[gCBClipboardViewer = this; // global obj
this.toString = function toString() {return this.name;}

this.xurl = "data:application/vnd.mozilla.xul+xml;base64," +
            encodeURIComponent(btoa(this.Help));

this.panel = false;

this.onclick = function(aEvent) {
  if (aEvent.button == 1) { // Middle click
    this.togglePanel();     // open in bottom panel
  }
  else if (aEvent.shiftKey) {   // Shift+left-click
    aEvent.preventDefault();
    this.toggleSidebar();       // open in sidebar
  }
  // This won't work for data:URI XUL on Firefox 4
  else if ((aEvent.ctrlKey  || aEvent.metaKey) && // if Ctrl+left-click
           ((Application.version < "4.0") ||  // if Firefox prior to version 4
            (/^chrome\:/.test(this.xurl)))) {     // if chrome URL
    aEvent.preventDefault();
    var tabs = gBrowser.mTabs;
    for (var i = 0; i < tabs.length; i++) {
      if (tabs[i].linkedBrowser.currentURI.spec == this.xurl) {
        gBrowser.selectedTab = tabs[i];
        return;
      }
    }
    gBrowser.loadOneTab(this.xurl,                // open in new tab
                        null, null, null, false);
  }
}

this.info = "\n\
Left-click: open in new window\n\n\
Middle-click: open in bottom panel\n\n\
Shift+click: open in sidebar\n\n\
Ctrl+click: open in new tab\n\
(for Firefox prior to version 4 only)\n\n";

function $(aId) {
  return document.getElementById(aId);
}

this.togglePanel = function() {
  this.panel = !this.panel;
  $(this.id + "-splitter").hidden = !this.panel;
  $(this.id + "-panel").hidden = !this.panel;
  $(this.id + "-iframe").setAttribute("src", this.panel ? this.xurl : "");
}

this.toggleSidebar = function() {
  //var title = $("sidebar-title").getAttribute("value")
  //$("sidebar-title").setAttribute("value", (title == "") ? this.label : "");
  toggleSidebar(this.id + "-sidebar");
}

this.checkForCBWindow = function() {
  var ww = Components.classes["@mozilla.org/embedcomp/window-watcher;1"]
                     .getService(Components.interfaces.nsIWindowWatcher);
  var em = ww.getWindowEnumerator();
  var winName = "clipview";
  var index = 1;
  while (em.hasMoreElements()) {
    let win = em.getNext();
    if(win.name == winName) {
      win.focus();
      return true;
    }
    index++
  }
  return false;
}

this.showTooltip = function(aNode) {
  var win = this.checkForCBWindow();
  if (win || this.opened) {
    aNode.label = this.info;
    return;
  }
  aNode.label = readFromClipboard() ? readFromClipboard() : this.info;
}

function $xml(aNode, aId, aXML) {
  var node = $(aId);
  node && node.parentNode.removeChild(node);
  aNode && aNode.appendChild(cbu.makeXML(aXML))
}

$xml($("mainBroadcasterSet"),
       this.id + "-sidebar",
        <broadcaster xmlns={xulns}
                     id={this.id + "-sidebar"}
                     label={this.label}
                     sidebartitle={this.label}
                     sidebarurl={this.xurl}
                     type="checkbox"
                     autoCheck="false"
                     group="sidebar"
                     oncommand="gCBClipboardViewer.toggleSidebar();" />);

$xml($("viewSidebarMenu"),
       this.id + "-viewsidebar",
       <menuitem xmlns={xulns}
                 id={this.id + "-viewsidebar"}
                 observes={this.id + "-sidebar"}
                 label={this.label}
                 sidebartitle={this.label}
                 sidebarurl={this.xurl}
                 type="checkbox"
                 autoCheck="false"
                 group="sidebar" />);

$xml($("appcontent"),
       this.id + "-splitter",
       <splitter xmlns={xulns}
                 id={this.id + "-splitter"}
                 orient="vertical"
                 hidden="true">
         <grippy oncommand={"this.parentNode.nextSibling.collapsed = " +
                            "!this.parentNode.nextSibling.collapsed;"}/>
       </splitter>);

$xml($("appcontent"),
       this.id + "-panel",
       <vbox xmlns={xulns}
             id={this.id + "-panel"}
             height="300"
             hidden="true">
         <toolbox>
           <toolbar align="center">
             <label value={this.label} flex="1" crop="end" />
             <toolbarbutton class="tabs-closebutton"
                            oncommand="gCBClipboardViewer.togglePanel();" />
           </toolbar>
         </toolbox>
         <iframe id={this.id + "-iframe"} src="" flex="1" />
       </vbox>);



// Custom Tooltip
// http://custombuttons.mozdev.org/drupal/node/645

var tooltip = this.appendChild(document.createElement("tooltip"));
tooltip.style.MozAppearance = "none";
tooltip.style.background = "menu";
tooltip.style.color = "menutext";
tooltip.style.opacity = ".9";
tooltip.style.border = "1px solid menutext";
tooltip.style.borderRadius = "5px";
tooltip.style.MozBorderRadius = "5px";
tooltip.style.fontFamily = "monospace";
tooltip.style.fontSize = "medium";
tooltip.style.maxWidth = (screen.width / 2) + "px";
tooltip.style.maxHeight = (screen.height / 2) + "px"; // not working
tooltip.style.padding = "1em";
tooltip.setAttribute("onpopupshowing", "this.parentNode.showTooltip(this);");

this.removeAttribute("tooltiptext");
this.tooltip = "_child";


////////////////////////////////////////////////////////////////////////////
////////////////////////////// Button updater //////////////////////////////
////////////////////////////////////////////////////////////////////////////

/* ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License
 * Version 1.1 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * Original code is Button Updater for Custom Buttons extension
 *
 * The Initial Developer of the Original Code is LouCypher.
 * Portions created by the Initial Developer are Copyright (C) 2011
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 * - LouCypher: original code
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"),
 * in which case the provisions of the GPL are applicable instead of those
 * above.
 *
 * ***** END LICENSE BLOCK ***** */

this.updateURL = "https://loucypher.googlecode.com/svn/custombuttons/xml/" +
                 "Clipboard%20Viewer.xml";

var btnClick = this.onclick;
var btnIcon = this.image;

this.updater = {

  get bsyIcon() {
    return  Application.name == "Firefox"
            ? Application.version >= "4"
              ? "chrome://browser/skin/tabbrowser/connecting.png"
              : "chrome://global/skin/icons/loading_16.png"
            : Application.name == "SeaMonkey"
              ? "chrome://communicator/skin/icons/loading.gif"
              : "chrome://custombuttons/skin/button.png";
  },

  isValidCbURI: function isValidCbURI(aURL) {
    if (!aURL) return false;
    return /^custombutton\:\/\//.test(aURL);
  },

  convertURItoDOM: function convertURItoDOM(aURL) {
    if (!this.isValidCbURI(aURL)) {
      custombuttons.alertBox(self.name, "Not a Custom Buttons link!");
      return;
    }
    var string = unescape(aURL.replace(/^custombutton\:\/\//, "").toString());
    var parser = new DOMParser();
    var dom = parser.parseFromString(string, "text/xml");
    if (dom.documentElement.nodeName == "parsererror") {
      return null;
    } else {
      return dom.documentElement;
    }
  },

  getParamValue: function getParamValue(aDocument, aNodeName) {
    var node = aDocument.querySelector(aNodeName);
    if (!node) return "";
    if (!node.firstChild || (node.firstChild &&
        (node.firstChild.nodeType == node.TEXT_NODE))) {
      return node.textContent;
    } else {
      return node.firstChild.textContent;
    }
  },

  getButtonParameters: function getButtonParameters(aButtonLink, aURL) {
    var dom = this.convertURItoDOM(aURL);
    var params = custombuttons.cbService.getButtonParameters(aButtonLink)
                                        .wrappedJSObject;
    params.name             = this.getParamValue(dom, "name")
    params.image            = this.getParamValue(dom, "image") ||
                              this.getParamValue(dom, "stdicon");
    params.code             = this.getParamValue(dom, "code")
    params.initCode         = this.getParamValue(dom, "initcode")
    params.help             = this.getParamValue(dom, "help")
    params.accelkey         = this.getParamValue(dom, "accelkey")
    params.mode             = this.getParamValue(dom, "mode")
    params.wrappedJSObject  = params;
    return params;
  },

  resetAttributes: function resetAttributes() {
    self.image = btnIcon;
    self.removeAttribute("busy");
    self.removeAttribute("tooltiptext");
    self.onclick = btnClick;
  },

  checkForUpdate: function checkForUpdate(aCallback) {
    var url = self.updateURL + "?" + Date.now();
    var req = new XMLHttpRequest();
    req.open("GET", url, true);
    if (self.hasAttribute("busy")) {
      this.resetAttributes();
      return
    }
    var updater = this;
    req.onreadystatechange = function (aEvent) {
      self.onclick = function(aEvent) {
        aEvent.preventDefault();
        req.abort();
        this.updater.resetAttributes();
      }
      self.image = updater.bsyIcon;
      self.setAttribute("busy", "");
      self.tooltipText = "Checking for update...\nClick to abort.";
      if (req.readyState == 4 && req.status == 200) {
        updater.resetAttributes();
        aCallback(req.responseXML);
      }
    }
    req.send(null);
  },

  getUpdate: function getUpdate(aDocument) {
    if (aDocument.documentElement.localName != "custombutton") {
      alert("Not a valid Custom Buttons XML file!");
      return;
    }
    let button = aDocument.getElementById("button");
    let link = button.getElementsByTagNameNS("http://www.w3.org/1999/xhtml",
                                             "a")[0];
    if (link.href == self.URI) {
      let as = Cc['@mozilla.org/alerts-service;1'].
               getService(Ci.nsIAlertsService);
      as.showAlertNotification(btnIcon, "No update found!",
                               "Finish checking", false, "", null);
      return;
    } 
    let install = custombuttons.confirmBox(self.name, "Update found! " +
                                           "Update " + self.name + "?",
                                           "Yes", "No");
    if (!install) return;
    let btnLink = custombuttons.makeButtonLink("update", self.id);
    let params = self.updater.getButtonParameters(btnLink, link.href);
    custombuttons.cbService.installButton(params);
    custombuttons.alertBox(self.name, "Button updated!");
    self.setAttribute("cb-edit-state", "active");
  }
}

function addMenuItem(aNewIDs, aNodeIDs, aLabel, aIcon, aCommand, aSeparator) {
  for (var i = 0; i < aNewIDs.length; i++) {
    // Remove previously created menuitems if any
    if ($(aNewIDs[i])) $(aNewIDs[i]).parentNode.removeChild($(aNewIDs[i]));

    // Added 'Export to XML' menuitem to CB contextmenu
    let mi = cbu.makeXML(<menuitem xmlns={xulns} id={aNewIDs[i]}
                                   class="menuitem-iconic"
                                   image={aIcon} label={aLabel}
                                   oncommand={aCommand}/>);

    if (i == 0) {
      mi.setAttribute("observes", "custombuttons-contextbroadcaster-primary");
    }
    $(aNodeIDs[i]).parentNode.insertBefore(mi, $(aNodeIDs[i]).nextSibling);
    if (aSeparator) {
      let sep = cbu.makeXML(<menuseparator xmlns={xulns}
                                           id={mi.id + "-separator"}/>);
      mi.parentNode.insertBefore(sep, mi.nextSibling);
    }
  }
}

let kIDs = [this.id + "-checkForUpdate", this.id + "-checkForUpdate-sub"];
let uIDs = ["custombuttons-contextpopup-updateButton",
            "custombuttons-contextpopup-updateButton-sub"];

// Add 'Check for Update...' menuitem to CB contextmenu
addMenuItem(kIDs, uIDs, "Check for updates for this button", this.image,
            "var btn = document.getElementById('" + this.id + "'); " +
            "btn.updater.checkForUpdate(btn.updater.getUpdate);", true);

function initCbPopup() {
  for (var i = 0; i < kIDs.length; i++) {
    $(kIDs[i]).hidden = (document.popupNode != self);
    ($(kIDs[i]).nextSibling.id == $(kIDs[i]).id + "-separator") &&
    ($(kIDs[i]).nextSibling.hidden = (document.popupNode != self));
  }
}

$(uIDs[0]).parentNode.addEventListener("popupshowing", initCbPopup, false);
$(uIDs[0]).parentNode.removeEventListener("popuphiding", initCbPopup, false);

// Remove contextmenu items when this button is deleted
this.onDestroy = function() {
  $(kIDs[0]).parentNode.removeEventListener("popupshowing",
                                            initCbPopup, false);
  for (var i = 0; i < 2; i++) {
    $(kIDs[i]) && ($(kIDs[i]).nextSibling.id == $(kIDs[i]).id + "-separator")
               && $(kIDs[i]).parentNode.removeChild($(kIDs[i]).nextSibling);
    $(kIDs[i]) && $(kIDs[i]).parentNode.removeChild($(kIDs[i]));
  }
}

/////////////////////////////////////////////////////////////////////////////
]]></initcode>
  <code><![CDATA[/*
  Changelog:
    2011-07-05:
      x 'Edit' button is now using external editor
      + Added style
      + Added button updater + context menu
    2011-06-18:
      * Fixed error on Seamonkey
      x Moved XUL data to Help section
      x Close button now closes bottom panel if it's loaded on bottom panel
    2011-06-13:
      * Includes XUL file in init code.
      + Added bottom panel (middle-click to open).
      + Added 'Edit' button to edit clipboard content 'directly'.
      + Ctrl+click open Clipboard Viewer in new tab (Firefox prior to version 4 only).
      + Shift+click open Clipboard Viewer in sidebar.
    2011-05-31:
      x Close button now closes the sidebar if it's loaded in sidebar.
    2011-05-30:
      * Initial release.
*/


var ww = Components.classes["@mozilla.org/embedcomp/window-watcher;1"]
                   .getService(Components.interfaces.nsIWindowWatcher);
var em = ww.getWindowEnumerator();
var winName = "clipview";
var index = 1;
while (em.hasMoreElements()) {
  let win = em.getNext();
  if(win.name == winName) {
    win.focus();
    return;
  }
  index++
}

openDialog(this.xurl, winName, "chrome, dialog=no, centerscreen, minimizable, resizable");

]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help>&lt;?xml version="1.0"?&gt;
&lt;!--
  Version: MPL 1.1/GPL 2.0/LGPL 2.1

  The contents of this file are subject to the Mozilla Public License Version
  1.1 (the "License"); you may not use this file except in compliance with
  the License. You may obtain a copy of the License at
  http://www.mozilla.org/MPL/

  Software distributed under the License is distributed on an "AS IS" basis,
  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
  for the specific language governing rights and limitations under the
  License.

  The Original Code is Clipboard Viewer

  The Initial Developer of the Original Code is LouCypher.
  Portions created by the Initial Developer are Copyright (C) 2011
  the Initial Developer. All Rights Reserved.

  Contributor(s):
  - LouCypher &lt;loucypher@mozillaca.com&gt;
  - Alice0775, external editor

  Alternatively, the contents of this file may be used under the terms of
  either the GNU General Public License Version 2 or later (the "GPL"), or
  the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  in which case the provisions of the GPL or the LGPL are applicable instead
  of those above. If you wish to allow use of your version of this file only
  under the terms of either the GPL or the LGPL, and not to allow others to
  use your version of this file under the terms of the MPL, indicate your
  decision by deleting the provisions above and replace them with the notice
  and other provisions required by the GPL or the LGPL. If you do not delete
  the provisions above, a recipient may use your version of this file under
  the terms of any one of the MPL, the GPL or the LGPL.
--&gt;

&lt;?xml-stylesheet type="text/css" href="chrome://global/skin/"?&gt;

&lt;dialog xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
        xmlns:html="http://www.w3.org/1999/xhtml"
        id="clipboard-viewer"
        width="800" height="600"
        title="Clipboard Viewer"
        buttons="extra1, extra2, cancel"
        buttonlabelextra1="Edit"
        buttonlabelextra2="Clear"
        buttonlabelcancel="Close"
        buttonaccesskeyextra1="E"
        buttonaccesskeyextra2="r"
        buttonaccesskeycancel="C"
        ondialogextra1="edit();"
        ondialogextra2="clearClipboard();"
        ondialogcancel="closeDialog();"
        onfocus="loadFromClipboard();"&gt;

  &lt;html:head&gt;
    &lt;html:style type="text/css"&gt;
    &lt;![CDATA[#textbox {
      font-family: monospace; font-size: medium; white-space: pre-wrap;
    }]]&gt;
    &lt;/html:style&gt;
  &lt;/html:head&gt;

  &lt;keyset&gt;&lt;key keycode="VK_F5" oncommand="loadFromClipboard();" /&gt;&lt;/keyset&gt;

  &lt;popupset&gt;
    &lt;menupopup id="contextmenu"
               onpopupshowing="popupShowing(event);"
               onpopuphiding="loadFromClipboard();"
               oncommand="var cmd = event.originalTarget.getAttribute('cmd');
 if (cmd) document.popupNode.parentNode.doCommand(cmd);"&gt;
      &lt;menuitem id="edit-copy" label="Copy" accesskey="c" cmd="cmd_copy" /&gt;
      &lt;!--menuitem id="edit-delete" label="Delete" accesskey="d" cmd="cmd_delete" /--&gt;
      &lt;menuseparator /&gt;
      &lt;menuitem id="edit-selectAll" label="Select All" accesskey="a" cmd="cmd_selectAll" /&gt;
    &lt;/menupopup&gt;
  &lt;/popupset&gt;

  &lt;textbox id="textbox" multiline="true" flex="1"
           onclick="gmon_edit_mouseclick(event);"
           context="contextmenu" readonly="" /&gt;

  &lt;script type="application/x-javascript"&gt;&lt;![CDATA[
const Cc = Components.classes;
const Ci = Components.interfaces;

const gTextbox = document.getElementById("textbox");

function getMainwin() {
  if (window.frameElement) {
    return window.frameElement.ownerDocument.defaultView;
  } else if (window.opener) {
    return window.opener;
  } else {
    return Cc["@mozilla.org/appshell/window-mediator;1"].
           getService().QueryInterface(Ci.nsIWindowMediator).
           getMostRecentWindow("navigator:browser")
  }
}

function readFromClipboard() {
//http://mxr.mozilla.org/mozilla2.0/source/browser/base/content/browser.js#2299
  var string;
  try {
      var clipboard = Cc["@mozilla.org/widget/clipboard;1"].
                      getService(Ci.nsIClipboard);
      var trans = Cc["@mozilla.org/widget/transferable;1"].
                  createInstance(Ci.nsITransferable);
      trans.addDataFlavor("text/unicode");
      if (clipboard.supportsSelectionClipboard()) {
        clipboard.getData(trans, clipboard.kSelectionClipboard);
      } else {
        clipboard.getData(trans, clipboard.kGlobalClipboard);
      }
      var data = {};
      var dataLen = {};
      trans.getTransferData("text/unicode", data, dataLen);
      if (data) {
        data = data.value.QueryInterface(Ci.nsISupportsString);
        string = data.data.substring(0, dataLen.value / 2);
      }
  } catch (ex) {
  }
  return string;
}

function loadFromClipboard() {
  var string = readFromClipboard();
  if (gTextbox.value != string) {
    if (!string) {
      gTextbox.value = "";
    } else {
      gTextbox.value = string;
    }
  }
  gTextbox.selectionStart = 0;
  gTextbox.selectionEnd = 0;
  //gTextbox.scrollTop = 0;
}

function copyToClipboard(aString) {
  let clipboardHelper = Cc["@mozilla.org/widget/clipboardhelper;1"].
                        getService(Ci.nsIClipboardHelper);
  clipboardHelper.copyString(aString);
}

function clearClipboard() {
  copyToClipboard("");
  gTextbox.value = "";
}

function edit() {
  edittarget(gTextbox);
}

function closeDialog() {
  getMainwin().gCBClipboardViewer.opened = false;
  if (window.frameElement) {
    switch (window.frameElement.id) {
    case "sidebar":
      getMainwin().gCBClipboardViewer.toggleSidebar();
      break;
    default:
      getMainwin().gCBClipboardViewer.togglePanel();
    }
  } else {
    window.close();
  }
}

function popupShowing(aEvent) {
  var children = aEvent.target.childNodes;
  for (var i = 0; i &lt; children.length; i++) {
    var command = children[i].getAttribute("cmd");
    if (command) {
      var controller = document.commandDispatcher
                               .getControllerForCommand(command);
      var enabled = controller.isCommandEnabled(command);
      if (enabled) {
        children[i].removeAttribute("disabled");
      } else {
        children[i].setAttribute("disabled", "true");
      }
    }
  }
}

/////////////////////////////////////////////////////////////////////////////
////////////////////////////// External Editor //////////////////////////////
/////////////////////////////////////////////////////////////////////////////

var _tmpdir=null,_dir_separator,_os;
var _ext,_encode,_target=[];

function editinit() {
  if (window.navigator.platform.toLowerCase().indexOf("win") != -1) {
    // Windows OS
    _dir_separator = "\\";
    _os = "win";
  } else {
    // UNIX/Linux OS
    _dir_separator = "/";
    _os = "unix";
  }

  _ext = "txt";
  _encode = "UTF-8";
  _target = [];

  window.addEventListener("unload", edituninit, false);
  window.addEventListener("unload", function() {
    document.removeEventListener("focus", checkfocus_window, true);
  }, false);
}

function getEditor() {
  let pref = Cc["@mozilla.org/preferences-service;1"].
             getService(Ci.nsIPrefService).
             getBranch("custombuttons.ClipboardViewer.");
  let editor = null;
  try {
    editor = pref.getCharPref("external_editor");
  } catch(ex) {
    let prompts = Cc["@mozilla.org/embedcomp/prompt-service;1"].
                  getService(Ci.nsIPromptService);

    let ask = prompts.confirm(null, "Clipboard Viewer",
                              "You must choose a text editor before " +
                              "using this feature.\nClick OK to continue.");
    if (!ask) return false;

    let nsIFilePicker = Ci.nsIFilePicker;
    let filePicker = Cc["@mozilla.org/filepicker;1"].
                     createInstance(nsIFilePicker);
    filePicker.init(window, "Select editor", nsIFilePicker.modeOpen);
    filePicker.appendFilters(nsIFilePicker.filterApplication);
    filePicker.appendFilters(nsIFilePicker.filterAll);
    if (filePicker.show() == nsIFilePicker.returnOK) {
      if (filePicker.file.exists() &amp;&amp; filePicker.file.isExecutable()) {
        pref.setCharPref("external_editor", filePicker.file.path);
        editor = filePicker.file.path;
      }
    }
  }
  return editor;
}

function edituninit() {
  if (_tmpdir == null) return;
  var windowType = "navigator:browser";
  var windowManager = Cc["@mozilla.org/appshell/window-mediator;1"].
                      getService();
  var windowManagerInterface = windowManager.
                               QueryInterface(Ci.nsIWindowMediator);
  var enumerator = windowManagerInterface.getEnumerator(windowType);
  if (enumerator.hasMoreElements()) {
    return;
  }

  var file = Cc["@mozilla.org/file/local;1"].
             createInstance(Ci.nsILocalFile);
  file.initWithPath(_tmpdir);
  var entries = file.directoryEntries;
  while (entries.hasMoreElements()) {
    var entry = entries.getNext().QueryInterface(Ci.nsIFile);
    if (/^custombuttons\./i.test(entry.leafName)) {
      try {
        entry.remove(false);
      } catch(e) {
      }
    }
  }

  try {
    if (file.exists() == true ) {
      file.remove(false);
    }
  } catch(e) {
  }

  _tmpdir = null;
}

function gmon_edit_mouseclick(e) {
  if (e.button != 1) return;
  var target = e.target;
  edittarget(target);
}

function checkfocus_window() {
  var target, filename, timestamp, encode,
      file, inst, sstream, utf, textBoxText;

  if (_target.length&lt;=0) return;

  file = Cc["@mozilla.org/file/local;1"].createInstance(Ci.nsILocalFile);
  istr = Cc["@mozilla.org/network/file-input-stream;1"].
         createInstance(Ci.nsIFileInputStream);

  // FileInputStream's read is [noscript].
  sstream = Cc["@mozilla.org/scriptableinputstream;1"].
            createInstance(Ci.nsIScriptableInputStream);
  utf = Cc["@mozilla.org/intl/utf8converterservice;1"].
        createInstance(Ci.nsIUTF8ConverterService);

  for (var i=0; i &lt; _target.length;i++) {
    target = _target[i];
    if (!target.hasAttribute("filename")) continue;
    filename = target.getAttribute("filename");
    timestamp = target.getAttribute("timestamp");
    file.initWithPath(filename);
    if (!file.exists() || !file.isReadable()) continue;
    if (file.lastModifiedTime &lt;= timestamp) continue;

    target.setAttribute("timestamp", file.lastModifiedTime);

    istr.init(file, 1, 0x400, false);
    sstream.init(istr);

    textBoxText  = sstream.read(sstream.available());
    encode = target.getAttribute("encode");
    if (textBoxText.length) {
      copyToClipboard(utf.convertStringToUTF8(textBoxText, encode, true));
      target.value = utf.convertStringToUTF8(textBoxText, encode, true);
    } else {
      clearClipboard();
      target.value = "";
    }
    sstream.close();
    istr.close();
    try {
      file.remove(false);
    } catch(e) {
    }
  }
}

function editfile(target,filename) {
  // Figure out what editor to use.
  var editor = getEditor();
  if (!editor) return false;

  var file = Cc["@mozilla.org/file/local;1"].createInstance(Ci.nsILocalFile);
  file.initWithPath(editor);
  if (!file.exists()) {
    alert("Error_invalid_Editor_file");
    return false;
  }
  if (!file.isExecutable()) {
    alert("Error_Editor_not_executable");
    return false;
  }
  target.setAttribute("filename", filename);
  target.setAttribute("timestamp", file.lastModifiedTime);

  // Run the editor.
  var process = Cc["@mozilla.org/process/util;1"].
                createInstance(Ci.nsIProcess);
  process.init(file);
  var args = [filename];
  process.run(false, args, args.length);  // don't block
  document.addEventListener("focus", checkfocus_window, true);
  return true;
}

function edittarget(target) {
  var textBoxText = target.value;
  // Get filename.
  var file = Cc["@mozilla.org/file/local;1"].createInstance(Ci.nsILocalFile);
  if (target.hasAttribute("filename")) {
    var filename = target.getAttribute("filename");
    file.initWithPath(filename);
    try {
      if(file.exists()) file.remove(false);
    } catch(e) {
    }
  } else {
    var filename = TmpFilenameTextarea();
  }
  file.initWithPath(filename);    
  file.create(file.NORMAL_FILE_TYPE, 0600);

  // Write the data to the file.
  var ostr = Cc["@mozilla.org/network/file-output-stream;1"].
             createInstance(Ci.nsIFileOutputStream);
  ostr.init(file, 2, 0x200, false);

  if(navigator.platform == "Win32") {
    // Convert Unix newlines to standard network newlines
    textBoxText = textBoxText.replace(/\n/g, "\r\n");
  }
  var conv = Cc["@mozilla.org/intl/saveascharset;1"].
             createInstance(Ci.nsISaveAsCharset);
  try {
    conv.Init(_encode, 0, 0);
    textBoxText = conv.Convert(textBoxText);
  } catch(e) {
    textBoxText = "";
  }
  ostr.write(textBoxText, textBoxText.length);

  ostr.flush();
  ostr.close();

  // setup target info
  target.setAttribute("encode", _encode);

  // Edit the file.
  if (editfile(target,file.path)) {
    _target.push(target);  // Editting target array
  }
}

//Compose temporary filename out of
//    - tmpdir setting
//    - document url
//    - textarea name
//    - ext suffix
function TmpFilenameTextarea() {
  var TmpFilename;
  _tmpdir = gettmpDir();
  do {
    TmpFilename = _tmpdir + _dir_separator + "clipboard." +
                  Math.floor(Math.random() * 100000) + "." + _ext;
  } while (!ExistsFile(TmpFilename))
    return TmpFilename;
}

//Function returns true if given filename exists
function ExistsFile(filename) {
  try {
    var file = Cc["@mozilla.org/file/local;1"].
               createInstance(Ci.nsILocalFile);
    file.initWithPath(filename);
    return true;
  } catch(e) {
    return false;
  }
}

/**
* Returns the directory where we put files to edit.
* @returns nsILocalFile The location where we should write editable files.
*/
function gettmpDir() {
  /* Where is the directory that we use. */
  var fobj = Cc["@mozilla.org/file/directory_service;1"].
             getService(Ci.nsIProperties).get("TmpD", Ci.nsIFile);
  fobj.append("Clipboard_Viewer");
  if (!fobj.exists()) {
    fobj.create(Ci.nsIFile.DIRECTORY_TYPE, parseInt("0700", 8));
  }
  if (!fobj.isDirectory()) {
    // the string will be replaced locale properties in the future
    alert("Having a problem finding or creating directory: "+ fobj.path);
  }
  return fobj.path;
}

//////////////////////////////////////////////

function onLoad() {
  getMainwin().gCBClipboardViewer.opened = true;
  editinit();
}

window.addEventListener("load", onLoad, false);
window.removeEventListener("unload", onLoad, false);

  ]]&gt;&lt;/script&gt;

&lt;/dialog&gt;</help>
  <attributes/>
</custombutton>