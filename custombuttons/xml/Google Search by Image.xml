<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Google Search by Image]]></html:title>
    <html:link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAPCAYAAADphp8SAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADpwBB5RT3QAAABZ0RVh0Q3JlYXRpb24gVGltZQAwMi8yNS8xMapAVMwAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAABjklEQVQ4jZWTwWoTURSGv5lMp1OmxUIUXISCCbW06daNtGuh7uMbCHaeoOBSzBMEN92LXXThohVtoAshOyuKJQkaXWRjKi7aBjPT9v6uEsbpTGp/OHDPvf/5zjmLa0niCo0zWMODA2BZVqZTEkG1RdwhoLaxMKqTBJKWJO1JOpN0Iek8EQqeNxVXLP8jqS7pniXpe+1V9+yw058ft19yoqHKJb+9XikcOcDcYadvj4Mki+P68q1/F5hz4s1qGwsABNUWszMOD+7nWS75THk5wshw0DzhbeM3x/3zJG/CiWdBtTU6r63kuZ2f5NnmD8LI4Lk2TyoFHq7mefnm56XJMldaLE5T2+oSRgaAQWR4sdWlXJpO9WeCbvi5EWSoQWSYmkwvyQRdGOG5/z57rn0JfiWo8emY4FFhBPNcm/VKgQ/Nk1S/k3oLvN4/Ym31Jk8f38FzbQah4fPXU3be/8oEGSCXfBhEhu16j+16L6tXXKENfFwq+u3/caepXPLbwDsk3ZK0G/tr14lTSTuSin8BUMr8td343bwAAAAASUVORK5CYII="/>
    <html:style type="text/css"><![CDATA[body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
} 
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-image: -moz-linear-gradient(center top, rgb(147, 200, 94) 30%, rgb(85, 168, 2) 55%);
  border: 1px outset rgb(58, 116, 4);
  border-radius: 1em;
  -moz-border-radius: 1em;
  padding: 0;
  text-shadow: 0pt -1px 0pt rgb(58, 116, 4);
  margin-bottom: 1em;
}
#button a {
  color: rgb(255, 255, 255);
  padding: 1em;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3EGoogle%20Search%20by%20Image%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bdata%3Aimage/png%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABIAAAAPCAYAAADphp8SAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADpwBB5RT3QAAABZ0RVh0Q3JlYXRpb24gVGltZQAwMi8yNS8xMapAVMwAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAABjklEQVQ4jZWTwWoTURSGv5lMp1OmxUIUXISCCbW06daNtGuh7uMbCHaeoOBSzBMEN92LXXThohVtoAshOyuKJQkaXWRjKi7aBjPT9v6uEsbpTGp/OHDPvf/5zjmLa0niCo0zWMODA2BZVqZTEkG1RdwhoLaxMKqTBJKWJO1JOpN0Iek8EQqeNxVXLP8jqS7pniXpe+1V9+yw058ft19yoqHKJb+9XikcOcDcYadvj4Mki+P68q1/F5hz4s1qGwsABNUWszMOD+7nWS75THk5wshw0DzhbeM3x/3zJG/CiWdBtTU6r63kuZ2f5NnmD8LI4Lk2TyoFHq7mefnm56XJMldaLE5T2+oSRgaAQWR4sdWlXJpO9WeCbvi5EWSoQWSYmkwvyQRdGOG5/z57rn0JfiWo8emY4FFhBPNcm/VKgQ/Nk1S/k3oLvN4/Ym31Jk8f38FzbQah4fPXU3be/8oEGSCXfBhEhu16j+16L6tXXKENfFwq+u3/caepXPLbwDsk3ZK0G/tr14lTSTuSin8BUMr8td343bwAAAAASUVORK5CYII%3D%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5Bfunction%20saveImage%28aImage%29%20%7B%0A%20%20let%20imageString%20%3D%20Cc%5B%27@mozilla.org/supports-string%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsISupportsString%29%3B%0A%20%20imageString.data%20%3D%20aImage%3B%0A%20%20cbu.ps.setComplexValue%28%22custombuttons.searchImageURL.image_preview%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ci.nsISupportsString%2C%20imageString%29%3B%0A%7D%0A%0Afunction%20addParamsToForm%28form%2C%20key%2C%20value%29%20%7B%0A%20%20let%20hiddenField%20%3D%20content.document.createElement%28%22input%22%29%3B%0A%20%20hiddenField.setAttribute%28%22type%22%2C%20%22hidden%22%29%3B%0A%20%20hiddenField.setAttribute%28%22name%22%2C%20key%29%3B%0A%20%20hiddenField.setAttribute%28%22value%22%2C%20value%29%3B%0A%20%20form.appendChild%28hiddenField%29%3B%0A%7D%0A%0Afunction%20searchImage%28aImageURL%29%20%7B%0A%20%20if%20%28aImageURL.indexOf%28%22data%3A%22%29%20%3D%3D%200%29%20%7B%0A%20%20%20%20let%20base64Offset%20%3D%20aImageURL.indexOf%28%22%2C%22%29%3B%0A%20%20%20%20if%20%28base64Offset%20%21%3D%20-1%29%20%7B%0A%20%20%20%20%20%20let%20inlineImage%20%3D%20aImageURL.substring%28base64Offset%20+%201%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.replace%28/%5C+/g%2C%20%22-%22%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.replace%28/%5C//g%2C%20%22_%22%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.replace%28/%5C./g%2C%20%22%3D%22%29%3B%0A%20%20%20%20%20%20saveImage%28aImageURL%29%3B%0A%0A%20%20%20%20%20%20let%20form%20%3D%20content.document.createElement%28%22form%22%29%3B%0A%20%20%20%20%20%20form.setAttribute%28%22method%22%2C%20%22POST%22%29%3B%0A%20%20%20%20%20%20form.setAttribute%28%22action%22%2C%20%22http%3A//www.google.com/searchbyimage/upload%22%29%3B%0A%20%20%20%20%20%20form.setAttribute%28%22enctype%22%2C%20%22multipart/form-data%22%29%3B%0A%20%20%20%20%20%20form.setAttribute%28%22target%22%2C%20%22_blank%22%29%3B%0A%20%20%20%20%20%20addParamsToForm%28form%2C%20%22image_content%22%2C%20inlineImage%29%3B%0A%20%20%20%20%20%20addParamsToForm%28form%2C%20%22filename%22%2C%20%22%22%29%3B%0A%20%20%20%20%20%20addParamsToForm%28form%2C%20%22image_url%22%2C%20%22%22%29%3B%0A%20%20%20%20%20%20content.document.body.appendChild%28form%29%3B%0A%20%20%20%20%20%20form.submit%28%29%3B%0A%20%20%20%20%7D%0A%20%20%7D%20else%20%7B%0A%20%20%20%20gBrowser.loadOneTab%28%22http%3A//www.google.com/searchbyimage%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%3Fimage_url%3D%22%20+%20encodeURIComponent%28aImageURL%29%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20null%2C%20null%2C%20null%2C%20false%29%3B%0A%20%20%7D%0A%7D%0A%0Athis.showHelp%20%3D%20function%20showHelp%28%29%20%7B%0A%20%20var%20pref%20%3D%20cbu.ps.getBranch%28%22custombuttons.searchImageURL.%22%29%3B%0A%20%20var%20firstTime%20%3D%20true%3B%0A%20%20try%20%7B%0A%20%20%20%20firstTime%20%3D%20pref.getBoolPref%28%22firstTime%22%29%3B%0A%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%7D%0A%20%20if%20%28%21firstTime%29%20return%3B%0A%20%20custombuttons.uChelpButton%28this%29%3B%0A%20%20pref.setBoolPref%28%22firstTime%22%2C%20false%29%3B%0A%7D%0A%0Athis.onclick%20%3D%20function%20checkForMiddleClick%28aEvent%29%20%7B%0A%20%20if%20%28aEvent.button%20%21%3D%201%29%20return%3B%0A%20%20new%20Function%28%22event%22%2C%20this.getAttribute%28%22cb-oncommand%22%29%29.call%28this%2C%20aEvent%29%3B%0A%7D%0A%0Athis.dndObserver%20%3D%20%7B%0A%20%20onDrop%3A%20function%28aEvent%2C%20aXferData%2C%20aDragSession%29%20%7B%0A%20%20%20%20var%20split%20%3D%20aXferData.data.split%28%22%5Cn%22%29%3B%0A%20%20%20%20var%20url%20%3D%20split%5B0%5D%3B%0A%20%20%20%20if%20%28url%20%21%3D%20aXferData.data%29%20%7B%0A%20%20%20%20%20%20var%20dialogArgs%20%3D%20%7Bname%3Asplit%5B1%5D%2C%20url%3Aurl%7D%3B%0A%20%20%20%20%20%20//Application.console.log%28this%29%3B%0A%20%20%20%20%20%20searchImage%28dialogArgs.url%29%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20split%20%3D%20aXferData.data.split%28%22%20%22%29%3B%0A%20%20%20%20%20%20url%20%3D%20split%5B0%5D%3B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20searchImage%28makeURI%28url%29.spec%29%3B%0A%20%20%20%20%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20%20%20%20%20custombuttons.alertBox%28aEvent.target.name%2C%20%22Invalid%20image%20URL%21%22%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%0A%20%20onDragOver%3A%20function%28aEvent%2C%20aFlavour%2C%20aDragSession%29%20%7B%0A%20%20%20%20document.getElementById%28%22statusbar-display%22%29.label%20%3D%20%22Drop%20it%21%22%3B%0A%20%20%20%20aDragSession.dragAction%20%3D%20Ci.nsIDragService.DRAGDROP_ACTION_LINK%3B%0A%20%20%7D%2C%0A%0A%20%20onDragExit%3A%20function%28aEvent%2C%20aDragSession%29%20%7B%0A%20%20%20%20document.getElementById%28%22statusbar-display%22%29.label%20%3D%20%22%22%3B%0A%20%20%7D%2C%0A%0A%20%20getSupportedFlavours%3A%20function%28%29%20%7B%0A%20%20%20%20//@https%3A//addons.mozilla.org/en-US/firefox/files/browse/122222/file/chrome/content/openInBrowser.js%23L37%0A%20%20%20%20//%20For%20image%20mime%20types%2C%20it%20relies%20on%20the%20fact%20that%20Gecko%20will%20correctly%0A%20%20%20%20//%20display%20an%20image%20even%20if%20the%20server%20sent%20it%20with%20a%20mime%20type%20that%0A%20%20%20%20//%20does%20not%20match%20the%20real%20image%20type.%20For%20instance%2C%20a%20PNG%20image%20sent%20with%0A%20%20%20%20//%20image/jpeg%20Content-Type%20will%20still%20be%20displayed%20properly.%0A%20%20%20%20var%20flavourSet%20%3D%20new%20FlavourSet%3B%0A%20%20%20%20flavourSet.appendFlavour%28%22image/jpeg%22%29%3B%0A%20%20%20%20flavourSet.appendFlavour%28%22application/x-moz-file%22%2C%20%22nsIFile%22%29%3B%20%20%20%20%0A%20%20%20%20flavourSet.appendFlavour%28%22text/unicode%22%29%3B%0A%20%20%20%20return%20flavourSet%3B%0A%20%20%7D%0A%7D%0A%0Athis.setAttribute%28%22ondragover%22%2C%20%22nsDragAndDrop.dragOver%28event%2C%20this.dndObserver%29%3B%22%29%3B%0Athis.setAttribute%28%22ondragdrop%22%2C%20%22nsDragAndDrop.drop%28event%2C%20this.dndObserver%29%3B%22%29%3B%0Athis.setAttribute%28%22ondragexit%22%2C%20%22nsDragAndDrop.dragExit%28event%2C%20this.dndObserver%29%3B%22%29%3B%0A%0A%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5Bthis.showHelp%28%29%3B%0AopenUILink%28%22http%3A//www.google.com/imghp%3Fsbi%3D1%22%2C%20event%2C%20false%2C%20true%29%3B%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5BDrag%20image%20on%20the%20web%20page%20onto%20this%20button%0Ato%20search%20the%20image%20on%20the%20web.%0A%0AImage%20must%20be%20larger%20than%2020%20bytes.%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Google Search by Image">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.mozdev.org/drupal/node/484">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>

  <name>Google Search by Image</name>
  <image><![CDATA[data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAPCAYAAADphp8SAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADpwBB5RT3QAAABZ0RVh0Q3JlYXRpb24gVGltZQAwMi8yNS8xMapAVMwAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAABjklEQVQ4jZWTwWoTURSGv5lMp1OmxUIUXISCCbW06daNtGuh7uMbCHaeoOBSzBMEN92LXXThohVtoAshOyuKJQkaXWRjKi7aBjPT9v6uEsbpTGp/OHDPvf/5zjmLa0niCo0zWMODA2BZVqZTEkG1RdwhoLaxMKqTBJKWJO1JOpN0Iek8EQqeNxVXLP8jqS7pniXpe+1V9+yw058ft19yoqHKJb+9XikcOcDcYadvj4Mki+P68q1/F5hz4s1qGwsABNUWszMOD+7nWS75THk5wshw0DzhbeM3x/3zJG/CiWdBtTU6r63kuZ2f5NnmD8LI4Lk2TyoFHq7mefnm56XJMldaLE5T2+oSRgaAQWR4sdWlXJpO9WeCbvi5EWSoQWSYmkwvyQRdGOG5/z57rn0JfiWo8emY4FFhBPNcm/VKgQ/Nk1S/k3oLvN4/Ym31Jk8f38FzbQah4fPXU3be/8oEGSCXfBhEhu16j+16L6tXXKENfFwq+u3/caepXPLbwDsk3ZK0G/tr14lTSTuSin8BUMr8td343bwAAAAASUVORK5CYII=]]></image>
  <mode>0</mode>
  <initcode><![CDATA[function saveImage(aImage) {
  let imageString = Cc['@mozilla.org/supports-string;1'].
                    createInstance(Ci.nsISupportsString);
  imageString.data = aImage;
  cbu.ps.setComplexValue("custombuttons.searchImageURL.image_preview",
                         Ci.nsISupportsString, imageString);
}

function addParamsToForm(form, key, value) {
  let hiddenField = content.document.createElement("input");
  hiddenField.setAttribute("type", "hidden");
  hiddenField.setAttribute("name", key);
  hiddenField.setAttribute("value", value);
  form.appendChild(hiddenField);
}

function searchImage(aImageURL) {
  if (aImageURL.indexOf("data:") == 0) {
    let base64Offset = aImageURL.indexOf(",");
    if (base64Offset != -1) {
      let inlineImage = aImageURL.substring(base64Offset + 1)
                                 .replace(/\+/g, "-")
                                 .replace(/\//g, "_")
                                 .replace(/\./g, "=");
      saveImage(aImageURL);

      let form = content.document.createElement("form");
      form.setAttribute("method", "POST");
      form.setAttribute("action", "http://www.google.com/searchbyimage/upload");
      form.setAttribute("enctype", "multipart/form-data");
      form.setAttribute("target", "_blank");
      addParamsToForm(form, "image_content", inlineImage);
      addParamsToForm(form, "filename", "");
      addParamsToForm(form, "image_url", "");
      content.document.body.appendChild(form);
      form.submit();
    }
  } else {
    gBrowser.loadOneTab("http://www.google.com/searchbyimage" +
                        "?image_url=" + encodeURIComponent(aImageURL),
                        null, null, null, false);
  }
}

this.showHelp = function showHelp() {
  var pref = cbu.ps.getBranch("custombuttons.searchImageURL.");
  var firstTime = true;
  try {
    firstTime = pref.getBoolPref("firstTime");
  } catch(ex) {
  }
  if (!firstTime) return;
  custombuttons.uChelpButton(this);
  pref.setBoolPref("firstTime", false);
}

this.onclick = function checkForMiddleClick(aEvent) {
  if (aEvent.button != 1) return;
  new Function("event", this.getAttribute("cb-oncommand")).call(this, aEvent);
}

this.dndObserver = {
  onDrop: function(aEvent, aXferData, aDragSession) {
    var split = aXferData.data.split("\n");
    var url = split[0];
    if (url != aXferData.data) {
      var dialogArgs = {name:split[1], url:url};
      //Application.console.log(this);
      searchImage(dialogArgs.url);
    } else {
      split = aXferData.data.split(" ");
      url = split[0];
      try {
        searchImage(makeURI(url).spec);
      } catch(ex) {
        custombuttons.alertBox(aEvent.target.name, "Invalid image URL!");
      }
    }
  },

  onDragOver: function(aEvent, aFlavour, aDragSession) {
    document.getElementById("statusbar-display").label = "Drop it!";
    aDragSession.dragAction = Ci.nsIDragService.DRAGDROP_ACTION_LINK;
  },

  onDragExit: function(aEvent, aDragSession) {
    document.getElementById("statusbar-display").label = "";
  },

  getSupportedFlavours: function() {
    //@https://addons.mozilla.org/en-US/firefox/files/browse/122222/file/chrome/content/openInBrowser.js#L37
    // For image mime types, it relies on the fact that Gecko will correctly
    // display an image even if the server sent it with a mime type that
    // does not match the real image type. For instance, a PNG image sent with
    // image/jpeg Content-Type will still be displayed properly.
    var flavourSet = new FlavourSet;
    flavourSet.appendFlavour("image/jpeg");
    flavourSet.appendFlavour("application/x-moz-file", "nsIFile");    
    flavourSet.appendFlavour("text/unicode");
    return flavourSet;
  }
}

this.setAttribute("ondragover", "nsDragAndDrop.dragOver(event, this.dndObserver);");
this.setAttribute("ondragdrop", "nsDragAndDrop.drop(event, this.dndObserver);");
this.setAttribute("ondragexit", "nsDragAndDrop.dragExit(event, this.dndObserver);");

]]></initcode>
  <code><![CDATA[this.showHelp();
openUILink("http://www.google.com/imghp?sbi=1", event, false, true);
]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[Drag image on the web page onto this button
to search the image on the web.

Image must be larger than 20 bytes.]]></help>
  <attributes/>
</custombutton>