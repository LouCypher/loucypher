<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Function Viewer]]></html:title>
    <html:link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9IMBAsvDiBBl1kAAAFHSURBVHjaxdI9Sx5REAXgR9FE0RQStVJLESGFQZAIWhiCi4jFFouFpZVgI/4HSyGxlJgiIGyxnbAoFgYJKIL+AsHmbbQRxSgETDPCIm+IFsFpZu49zJkzH/wHG8AmarjD4nMJNnGPaazg+DnJXbjB2VMTGh+9Z9CKn9XPLE3G/0bQVIkv8DbiWUxmaTKKH3gTxFXSWyxUFXTiMOJPWZr04AgnaKtTfAOfGx6puUILurI0WcNEXpTdWZrUQl0HvkWr3bisKhiM5Fq0M4UvgfXFSvewnhdlSxDeVwnehz8I347vkBflb+zjNC/K7cDncF2PYDd8A85jYP2x4pksTV4Fvoit6gz28QG9qGVpcoOvmI9j+ojLmNMxRtD5sMZmDGEnZgDLWM2L8nWlSHOWJr/wDsN5Ud4+AGNxvhP/urx6R3USspa8hP0BYGVPFHuclKkAAAAASUVORK5CYII="/>
    <html:style type="text/css"><![CDATA[body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
}
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-color: rgb(85, 168, 2);
  background-image: linear-gradient(to bottom, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -moz-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -o-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  background-image: -webkit-linear-gradient(top, rgb(147, 200, 94), rgb(85, 168, 2));
  border: 1px solid rgb(58, 116, 4);
  border-radius: .5em;
  -moz-border-radius: .5em;
  -webkit-border-radius: .5em;
  padding: 0;
  margin-bottom: 1em;
  box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -moz-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -o-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
  -webkit-box-shadow: 1px 2px 3px rgba(0, 0, 0, .25);
}
#button a {
  color: #000;
  text-shadow: -1pt -1px 0pt rgba(255, 255, 255, .5);
  padding: 1em;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
date, image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3EFunction%20Viewer%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bdata%3Aimage/png%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9IMBAsvDiBBl1kAAAFHSURBVHjaxdI9Sx5REAXgR9FE0RQStVJLESGFQZAIWhiCi4jFFouFpZVgI/4HSyGxlJgiIGyxnbAoFgYJKIL+AsHmbbQRxSgETDPCIm+IFsFpZu49zJkzH/wHG8AmarjD4nMJNnGPaazg+DnJXbjB2VMTGh+9Z9CKn9XPLE3G/0bQVIkv8DbiWUxmaTKKH3gTxFXSWyxUFXTiMOJPWZr04AgnaKtTfAOfGx6puUILurI0WcNEXpTdWZrUQl0HvkWr3bisKhiM5Fq0M4UvgfXFSvewnhdlSxDeVwnehz8I347vkBflb+zjNC/K7cDncF2PYDd8A85jYP2x4pksTV4Fvoit6gz28QG9qGVpcoOvmI9j+ojLmNMxRtD5sMZmDGEnZgDLWM2L8nWlSHOWJr/wDsN5Ud4+AGNxvhP/urx6R3USspa8hP0BYGVPFHuclKkAAAAASUVORK5CYII%3D%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5Bvar%20Cc%20%3D%20Components.classes%2C%20Ci%20%3D%20Components.interfaces%3B%0A%0Avar%20prefService%20%3D%20Cc%5B%22@mozilla.org/preferences-service%3B1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getService%28Ci.nsIPrefBranch2%29%3B%0A%0Afunction%20getPref%28%29%20%7B%0A%20%20try%20%7B%0A%20%20%20%20return%20prefService.getCharPref%28%22custombuttons.functionViewer%22%29%3B%0A%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20return%20%22%22%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20selectItems%28aText%2C%20aItems%2C%20aTitle%29%20%7B%0A%20%20var%20promptService%20%3D%20Cc%5B%22@mozilla.org/embedcomp/prompt-service%3B1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getService%28Ci.nsIPromptService%29%3B%0A%0A%20%20var%20selected%20%3D%20%7B%7D%3B%0A%20%20var%20result%20%3D%20promptService.select%28null%2C%20aTitle%2C%20aText%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20aItems.length%2C%20aItems%2C%20selected%29%3B%0A%20%20if%20%28result%29%20return%20aItems%5Bselected.value%5D%3B%0A%20%20return%3B%0A%7D%0A%0Athis.copyToClipboard%20%3D%20function%28aString%29%20%7B%0A%20%20var%20clipboard%20%3D%20Cc%5B%22@mozilla.org/widget/clipboardhelper%3B1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getService%28Ci.nsIClipboardHelper%29%3B%0A%20%20clipboard.copyString%28aString%29%3B%0A%7D%0A%0Athis.loadOneTab%20%3D%20function%28aSource%2C%20aName%29%20%7B%0A%20%20var%20url%20%3D%20%22data%3Aapplication/x-javascript%2C%20%22%20+%20encodeURIComponent%28aSource%29%3B%0A%20%20var%20tab%20%3D%20gBrowser.mCurrentTab%3B%0A%20%20if%20%28gBrowser.currentURI.spec%20%3D%3D%20%22about%3Ablank%22%29%20%7B%0A%20%20%20%20gBrowser.loadURI%28url%29%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20tab%20%3D%20gBrowser.loadOneTab%28url%2C%20null%2C%20null%2C%20null%2C%20false%29%3B%0A%20%20%7D%0A%20%20tab.linkedBrowser.addEventListener%28%22DOMContentLoaded%22%2C%20function%28e%29%20%7B%0A%20%20%20%20tab.setAttribute%28%22label%22%2C%20aName%29%3B%0A%20%20%7D%2C%20false%29%3B%0A%7D%0A%0Athis.viewFunction%20%3D%20function%28aPrompt%29%20%7B%0A%20%20if%20%28aPrompt%29%20%7B%0A%20%20%20%20var%20functionName%20%3D%20getPref%28%29%3B%0A%20%20%20%20var%20isClipboard%20%3D%20readFromClipboard%28%29%3B%0A%20%20%20%20if%20%28isClipboard%29%20%7B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20if%20%28typeof%20eval%28isClipboard%29%20%3D%3D%20%22function%22%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20functionName%20%3D%20isClipboard%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20var%20text%20%3D%20%22Enter%20function%20name%20%28case%20sensitive%29%5Cn%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22For%20example%3A%20openUILink%2C%20gBrowser.loadOneTab%22%3B%0A%20%20%20%20var%20funcStr%20%3D%20prompt%28text%2C%20functionName%2C%20%22Function%20Viewer%22%29%3B%0A%20%20%20%20if%20%28%21funcStr%29%20return%3B%0A%20%20%20%20prefService.setCharPref%28%22custombuttons.functionViewer%22%2C%20funcStr%29%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20if%20%20%28typeof%20eval%28funcStr%29%20%3D%3D%20%22function%22%29%20%7B%0A%20%20%20%20%20%20%20%20//alert%28eval%28funcStr%29%29%3B%0A%20%20%20%20%20%20%20%20//this.copyToClipboard%28eval%28funcStr%29%29%3B%0A%20%20%20%20%20%20%20%20this.loadOneTab%28eval%28funcStr%29%2C%20funcStr%29%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20alert%28funcStr%20+%20%22%20is%20not%20a%20function.%22%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20%20%20alert%28funcStr%20+%20%22%20is%20not%20defined.%22%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%3B%0A%20%20%7D%0A%0A%20%20var%20funcArray%20%3D%20%5B%5D%3B%0A%20%20for%20%28var%20i%20in%20window%29%20%7B%0A%20%20%20%20if%20%28typeof%20eval%28i%29%20%3D%3D%20%22function%22%29%20funcArray.push%28i%29%3B%0A%20%20%7D%0A%20%20if%20%28%21funcArray.length%29%20return%3B%0A//funcArray.sort%28%29%3B%0A%20%20funcArray.sort%28function%28a%2Cb%29%20%7B%0A%20%20%20%20a%20%3D%20a.toLowerCase%28%29%3B%0A%20%20%20%20b%20%3D%20b.toLowerCase%28%29%3B%0A%20%20%20%20if%20%28a%20%3C%20b%29%20return%20-1%3B%0A%20%20%20%20if%20%28a%20%3E%20b%29%20return%201%3B%0A%20%20%20%20return%200%3B%0A%20%20%7D%29%0A%20%20var%20func%20%3D%20selectItems%28funcArray.length%20+%20%22%20functions%20found%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20funcArray%2C%20%22Function%20Viewer%22%29%3B%0A%20%20if%20%28func%29%20%7B%0A%20%20%20%20//eval%28%22alert%28%22%20+%20func%20+%20%22%29%22%29%3B%0A%20%20%20%20//eval%28%22this.copyToClipboard%28%22%20+%20func%20+%20%22%29%22%29%3B%0A%20%20%20%20eval%28%22this.loadOneTab%28%22%20+%20func%20+%20%22%2C%20func.toString%28%29%29%22%29%3B%0A%20%20%7D%0A%7D%0A%0Athis.setAttribute%28%22onclick%22%2C%20%22if%20%28event.button%20%3D%3D%201%29%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22this.viewFunction%28true%29%3B%22%29%3B%0A%0A%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5Bthis.viewFunction%28true%29%3B%0A%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Install Function Viewer">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/?src=custom-buttons-xml">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.sourceforge.net/forum/viewtopic.php?t=78#p197">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>
  <date id="date" value="20120329"/>
  <name>Function Viewer</name>
  <image><![CDATA[data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9IMBAsvDiBBl1kAAAFHSURBVHjaxdI9Sx5REAXgR9FE0RQStVJLESGFQZAIWhiCi4jFFouFpZVgI/4HSyGxlJgiIGyxnbAoFgYJKIL+AsHmbbQRxSgETDPCIm+IFsFpZu49zJkzH/wHG8AmarjD4nMJNnGPaazg+DnJXbjB2VMTGh+9Z9CKn9XPLE3G/0bQVIkv8DbiWUxmaTKKH3gTxFXSWyxUFXTiMOJPWZr04AgnaKtTfAOfGx6puUILurI0WcNEXpTdWZrUQl0HvkWr3bisKhiM5Fq0M4UvgfXFSvewnhdlSxDeVwnehz8I347vkBflb+zjNC/K7cDncF2PYDd8A85jYP2x4pksTV4Fvoit6gz28QG9qGVpcoOvmI9j+ojLmNMxRtD5sMZmDGEnZgDLWM2L8nWlSHOWJr/wDsN5Ud4+AGNxvhP/urx6R3USspa8hP0BYGVPFHuclKkAAAAASUVORK5CYII=]]></image>
  <mode>0</mode>
  <initcode><![CDATA[var Cc = Components.classes, Ci = Components.interfaces;

var prefService = Cc["@mozilla.org/preferences-service;1"]
                    .getService(Ci.nsIPrefBranch2);

function getPref() {
  try {
    return prefService.getCharPref("custombuttons.functionViewer");
  } catch(ex) {
    return "";
  }
}

function selectItems(aText, aItems, aTitle) {
  var promptService = Cc["@mozilla.org/embedcomp/prompt-service;1"]
                        .getService(Ci.nsIPromptService);

  var selected = {};
  var result = promptService.select(null, aTitle, aText,
                              aItems.length, aItems, selected);
  if (result) return aItems[selected.value];
  return;
}

this.copyToClipboard = function(aString) {
  var clipboard = Cc["@mozilla.org/widget/clipboardhelper;1"]
                    .getService(Ci.nsIClipboardHelper);
  clipboard.copyString(aString);
}

this.loadOneTab = function(aSource, aName) {
  var url = "data:application/x-javascript, " + encodeURIComponent(aSource);
  var tab = gBrowser.mCurrentTab;
  if (gBrowser.currentURI.spec == "about:blank") {
    gBrowser.loadURI(url);
  } else {
    tab = gBrowser.loadOneTab(url, null, null, null, false);
  }
  tab.linkedBrowser.addEventListener("DOMContentLoaded", function(e) {
    tab.setAttribute("label", aName);
  }, false);
}

this.viewFunction = function(aPrompt) {
  if (aPrompt) {
    var functionName = getPref();
    var isClipboard = readFromClipboard();
    if (isClipboard) {
      try {
        if (typeof eval(isClipboard) == "function") {
          functionName = isClipboard;
        }
      } catch(ex) {
      }
    }

    var text = "Enter function name (case sensitive)\n" +
               "For example: openUILink, gBrowser.loadOneTab";
    var funcStr = prompt(text, functionName, "Function Viewer");
    if (!funcStr) return;
    prefService.setCharPref("custombuttons.functionViewer", funcStr)
    try {
      if  (typeof eval(funcStr) == "function") {
        //alert(eval(funcStr));
        //this.copyToClipboard(eval(funcStr));
        this.loadOneTab(eval(funcStr), funcStr);
      } else {
        alert(funcStr + " is not a function.");
      }
    } catch(ex) {
      alert(funcStr + " is not defined.");
    }
    return;
  }

  var funcArray = [];
  for (var i in window) {
    if (typeof eval(i) == "function") funcArray.push(i);
  }
  if (!funcArray.length) return;
//funcArray.sort();
  funcArray.sort(function(a,b) {
    a = a.toLowerCase();
    b = b.toLowerCase();
    if (a < b) return -1;
    if (a > b) return 1;
    return 0;
  })
  var func = selectItems(funcArray.length + " functions found",
                        funcArray, "Function Viewer");
  if (func) {
    //eval("alert(" + func + ")");
    //eval("this.copyToClipboard(" + func + ")");
    eval("this.loadOneTab(" + func + ", func.toString())");
  }
}

this.setAttribute("onclick", "if (event.button == 1) " +
                             "this.viewFunction(true);");

]]></initcode>
  <code><![CDATA[this.viewFunction(true);

]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[]]></help>
  <attributes/>
</custombutton>