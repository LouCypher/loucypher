<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Custom Buttons XML Exporter/Importer]]></html:title>
    <html:link rel="shortcut icon" href="data:image/gif;base64,R0lGODlhGAAQALMAAH9AAP+AAP/AgP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAQAAAEUFDISaudIevNu/9gKH5SVmIBVnLDILVBO2RyPHOAPAC2K9SwTm5H0wFvnJ+raJwFN8qWwDYc2lZFgBXGddY02kx4zCOHR+i0eg3Wut/wuDsCADs="/>
    <html:style type="text/css"><![CDATA[body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
} 
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-image: -moz-linear-gradient(center top, rgb(147, 200, 94) 30%, rgb(85, 168, 2) 55%);
  border: 1px outset rgb(58, 116, 4);
  border-radius: 1em;
  -moz-border-radius: 1em;
  padding: 0;
  text-shadow: 0pt -1px 0pt rgb(58, 116, 4);
  margin-bottom: 1em;
}
#button a {
  color: rgb(255, 255, 255);
  padding: 1em;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3ECustom%20Buttons%20XML%20Exporter/Importer%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bdata%3Aimage/gif%3Bbase64%2CR0lGODlhGAAQALMAAH9AAP+AAP/AgP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAQAAAEUFDISaudIevNu/9gKH5SVmIBVnLDILVBO2RyPHOAPAC2K9SwTm5H0wFvnJ+raJwFN8qWwDYc2lZFgBXGddY02kx4zCOHR+i0eg3Wut/wuDsCADs%3D%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E/*%20*****%20BEGIN%20LICENSE%20BLOCK%20*****%0A%20*%20Version%3A%20MPL%201.1/GPL%202.0/LGPL%202.1%0A%20*%0A%20*%20The%20contents%20of%20this%20file%20are%20subject%20to%20the%20Mozilla%20Public%20License%0A%20*%20Version%201.1%20%28the%20%22License%22%29%3B%20you%20may%20not%20use%20this%20file%20except%20in%0A%20*%20compliance%20with%20the%20License.%20You%20may%20obtain%20a%20copy%20of%20the%20License%20at%0A%20*%20http%3A//www.mozilla.org/MPL/%0A%20*%0A%20*%20Software%20distributed%20under%20the%20License%20is%20distributed%20on%20an%20%22AS%20IS%22%20basis%2C%0A%20*%20WITHOUT%20WARRANTY%20OF%20ANY%20KIND%2C%20either%20express%20or%20implied.%20See%20the%20License%0A%20*%20for%20the%20specific%20language%20governing%20rights%20and%20limitations%20under%20the%0A%20*%20License.%0A%20*%0A%20*%20Original%20code%20is%20Export%20Button%20to%20XML%20File/Import%20XML%20File%20As%20New%20Button%0A%20*%20for%20Custom%20Buttons%20extension%0A%20*%0A%20*%20The%20Initial%20Developer%20of%20the%20Original%20Code%20is%20LouCypher.%0A%20*%20Portions%20created%20by%20the%20Initial%20Developer%20are%20Copyright%20%28C%29%202011%0A%20*%20the%20Initial%20Developer.%20All%20Rights%20Reserved.%0A%20*%0A%20*%20Contributor%28s%29%3A%0A%20*%20-%20LouCypher%3A%20original%20code%0A%20*%20-%20Morat%3A%20onDestroy%20event%2C%20bug%20report%0A%20*%0A%20*%20Alternatively%2C%20the%20contents%20of%20this%20file%20may%20be%20used%20under%20the%20terms%20of%0A%20*%20either%20the%20GNU%20General%20Public%20License%20Version%202%20or%20later%20%28the%20%22GPL%22%29%2C%0A%20*%20in%20which%20case%20the%20provisions%20of%20the%20GPL%20are%20applicable%20instead%20of%20those%0A%20*%20above.%0A%20*%0A%20*%20*****%20END%20LICENSE%20BLOCK%20*****%20*/%0A%0Aconst%20nsIFilePicker%20%3D%20Ci.nsIFilePicker%3B%0Aconst%20nsILocalFile%20%3D%20Ci.nsILocalFile%3B%0A%0Afunction%20%24%28aId%29%20%7B%0A%20%20return%20document.getElementById%28aId%29%3B%0A%7D%0A%0Avar%20lastDirectory%20%3D%20%7B%0A%20%20_lastDir%3A%20null%2C%0A%0A%20%20get%20path%28%29%20%7B%0A%20%20%20%20if%20%28%21this._lastDir%20%7C%7C%20%21this._lastDir.exists%28%29%29%20%7B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20this._lastDir%20%3D%20cbu.ps.getComplexValue%28%22custombuttons.XML.lastDir%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20nsILocalFile%29%3B%0A%20%20%20%20%20%20%20%20if%20%28%21this._lastDir.exists%28%29%29%0A%20%20%20%20%20%20%20%20%20%20this._lastDir%20%3D%20null%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20catch%28e%29%20%7B%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20this._lastDir%3B%0A%20%20%7D%2C%0A%0A%20%20set%20path%28val%29%20%7B%0A%20%20%20%20if%20%28%21val%20%7C%7C%20%21val.exists%28%29%20%7C%7C%20%21val.isDirectory%28%29%29%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20this._lastDir%20%3D%20val.clone%28%29%3B%0A%20%20%20%20cbu.ps.setComplexValue%28%22custombuttons.XML.lastDir%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20nsILocalFile%2C%20this._lastDir%29%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20saveFile%28aFileName%2C%20aStrData%29%20%7B%0A%20%20var%20fp%20%3D%20Cc%5B%22@mozilla.org/filepicker%3B1%22%5D.createInstance%28nsIFilePicker%29%3B%0A%20%20fp.appendFilters%28nsIFilePicker.filterXML%29%3B%0A%20%20fp.init%28window%2C%20%22Export%20button%20to%20XML%20file%22%2C%20nsIFilePicker.modeSave%29%3B%0A%20%20fp.defaultString%20%3D%20aFileName%3B%0A%20%20fp.displayDirectory%20%3D%20lastDirectory.path%3B%0A%20%20var%20res%20%3D%20fp.show%28%29%3B%0A%20%20if%20%28res%20%3D%3D%20nsIFilePicker.returnOK%20%7C%7C%20res%20%3D%3D%20nsIFilePicker.returnReplace%29%20%7B%0A%20%20%20%20lastDirectory.path%20%3D%20fp.file.parent.QueryInterface%28nsILocalFile%29%3B%0A%20%20%20%20var%20ostream%20%3D%20Cc%5B%22@mozilla.org/network/file-output-stream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIFileOutputStream%29%3B%0A%20%20%20%20ostream.init%28fp.file%2C%200x02%20%7C%200x08%20%7C%200x20%2C%200664%2C%200%29%3B%0A%20%20%20%20var%20charset%20%3D%20%22UTF-8%22%3B%0A%20%20%20%20var%20os%20%3D%20Cc%5B%22@mozilla.org/intl/converter-output-stream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIConverterOutputStream%29%3B%0A%20%20%20%20os.init%28ostream%2C%20charset%2C%204096%2C%200x0000%29%3B%0A%20%20%20%20os.writeString%28aStrData%29%3B%0A%20%20%20%20os.close%28%29%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20readFile%28file%29%20%7B%0A%20%20var%20data%20%3D%20%22%22%3B%0A%20%20var%20fstream%20%3D%20Cc%5B%22@mozilla.org/network/file-input-stream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIFileInputStream%29%3B%0A%20%20fstream.init%28file%2C%20-1%2C%200%2C%200%29%3B%0A%20%20var%20charset%20%3D%20%22UTF-8%22%3B%0A%20%20const%20replacementChar%20%3D%20Ci.nsIConverterInputStream%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.DEFAULT_REPLACEMENT_CHARACTER%3B%0A%20%20var%20is%20%3D%20Cc%5B%22@mozilla.org/intl/converter-input-stream%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIConverterInputStream%29%3B%0A%20%20is.init%28fstream%2C%20charset%2C%201024%2C%20replacementChar%29%3B%0A%20%20var%20str%20%3D%20%7B%7D%3B%0A%20%20while%20%28is.readString%284096%2C%20str%29%20%21%3D%200%29%20%7B%0A%20%20%20%20data%20+%3D%20str.value%3B%0A%20%20%7D%0A%20%20is.close%28%29%3B%0A%0A%20%20return%20data%3B%0A%7D%0A%0Afunction%20stringToDOM%28aString%29%20%7B%0A//%20https%3A//developer.mozilla.org/en/Parsing_and_serializing_XML%0A%20%20var%20parser%20%3D%20new%20DOMParser%28%29%3B%0A%20%20var%20dom%20%3D%20parser.parseFromString%28aString%2C%20%22text/xml%22%29%3B%0A%20%20if%20%28dom.documentElement.nodeName%20%3D%3D%20%22parsererror%22%29%20%7B%0A%20%20%20%20return%20null%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20return%20dom.documentElement%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20importXMLtoButton%28aStrXMLData%29%20%7B%0A%20%20loadURI%28%22custombutton%3A//%22%20+%20escape%28aStrXMLData%29%29%3B%0A%7D%0A%0Athis.checkDocumentForCBXML%20%3D%20function%28aDocument%29%20%7B%0A%20%20if%20%28%28%28aDocument.contentType%20%3D%3D%20%22text/xml%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%28aDocument.contentType%20%3D%3D%20%22application/xml%22%29%29%26amp%3B%26amp%3B%0A%20%20%20%20%20%20%28aDocument.documentElement.localName%20%3D%3D%20%22custombutton%22%29%29%20%7B%0A%20%20%20%20var%20serializer%20%3D%20new%20XMLSerializer%28%29%3B%0A%20%20%20%20var%20xml%20%3D%20serializer.serializeToString%28aDocument%29%3B%0A%20%20%20%20importXMLtoButton%28xml%29%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20this.loadXML%28%29%3B%0A%20%20%7D%0A%7D%0A%0Athis.saveXML%20%3D%20function%28aStrURI%29%20%7B%0A%20%20var%20cbURI%20%3D%20%28aStrURI%20%21%3D%20undefined%29%20%3F%20aStrURI%20%3A%20readFromClipboard%28%29%3B%0A%20%20if%20%28%21cbURI%20%7C%7C%20%21/%5Ecustombutton%5C%3A%5C/%5C//.test%28cbURI%29%29%20%7B%0A%20%20%20%20custombuttons.uChelpButton%28this%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%0A%20%20var%20cbXML%20%3D%20cbURI.replace%28/%5Ecustombutton%5C%3A%5C/%5C//%2C%20%22%22%29%3B%0A%20%20var%20decodeXML%20%3D%20unescape%28cbXML%29%3B%0A%20%20var%20btnName%20%3D%20decodeXML.match%28/%5C%26lt%3Bname%5C/%3F.+/%29.toString%28%29%3B%0A%20%20var%20name%20%3D%20%22untitled%22%3B%0A%20%20if%20%28%21/%5C%26lt%3Bname%5C/%5C%26gt%3B/.test%28btnName%29%29%20%7B%0A%20%20%20%20name%20%3D%20btnName.replace%28/%5C%26lt%3B%5C/%3F%5Cw+%5C%26gt%3B/g%2C%20%22%22%29.toString%28%29%3B%0A%20%20%7D%0A%20%20var%20image%20%3D%20decodeXML.match%28/%5C%26lt%3Bimage%5C/%3F.+/%29.toString%28%29%3B%0A%20%20var%20icon%20%3D%20%22%22%3B%0A%20%20if%20%28%21/%5C%26lt%3B%5Cimage.*%5C%5B%5C%5D.*%5C%26gt%3B%24/.test%28image%29%29%20%7B%0A%20%20%20%20icon%20%3D%20image.match%28/%5B%5E%5C%5B%5C%5D%5D+/g%29%5B2%5D.toString%28%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.replace%28/custombuttons%5C-stdicon%5C-%5Cd/%2C%20%22%22%29.toString%28%29%3B%0A%20%20%7D%0A%20%20%0A%20%20var%20xmlTemplate%20%3D%20%22custombuttons/%5C%22%5Cn%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20xmlns%3Ahtml%3D%5C%22http%3A//www.w3.org/1999/xhtml%5C%22%26gt%3B%5Cn%5C%0A%20%20%26lt%3Bhtml%3Ahead%26gt%3B%5Cn%5C%0A%20%20%20%20%26lt%3Bhtml%3Atitle%26gt%3B%26lt%3B%21%5BCDATA%5B%22%20+%20name%20+%20%22%5D%5D%26gt%3B%26lt%3B/html%3Atitle%26gt%3B%5Cn%5C%0A%20%20%20%20%26lt%3Bhtml%3Alink%20rel%3D%5C%22shortcut%20icon%5C%22%20href%3D%5C%22%22%20+%20icon%20+%20%22%5C%22/%26gt%3B%5Cn%5C%0A%20%20%20%20%26lt%3Bhtml%3Astyle%20type%3D%5C%22text/css%5C%22%26gt%3B%26lt%3B%21%5BCDATA%5B%5C%0Abody%20%7B%20font-size%3A%20medium%3B%20margin%3A%200%3B%20%7D%5Cn%5C%0Abody%2C%20code%3Abefore%2C%20help%3Abefore%2C%20initcode%3Abefore%20%7B%5Cn%5C%0A%20%20font-family%3A%20%5C%22Verdana%5C%22%2C%20sans-serif%3B%5Cn%5C%0A%7D%20%5Cn%5C%0A%23wrapper%20%7B%20position%3A%20fixed%3B%20top%3A%201em%3B%20right%3A%201em%3B%20text-align%3A%20center%3B%20%7D%5Cn%5C%0Ap%20%7B%20font-size%3A%20small%3B%20text-align%3A%20center%3B%20%7D%5Cn%5C%0A%23button%20%7B%5Cn%5C%0A%20%20background-image%3A%20-moz-linear-gradient%28center%20top%2C%20rgb%28147%2C%20200%2C%2094%29%2030%25%2C%5C%0A%20rgb%2885%2C%20168%2C%202%29%2055%25%29%3B%5Cn%5C%0A%20%20border%3A%201px%20outset%20rgb%2858%2C%20116%2C%204%29%3B%5Cn%5C%0A%20%20border-radius%3A%201em%3B%5Cn%5C%0A%20%20-moz-border-radius%3A%201em%3B%5Cn%5C%0A%20%20padding%3A%200%3B%5Cn%5C%0A%20%20text-shadow%3A%200pt%20-1px%200pt%20rgb%2858%2C%20116%2C%204%29%3B%5Cn%5C%0A%20%20margin-bottom%3A%201em%3B%5Cn%5C%0A%7D%5Cn%5C%0A%23button%20a%20%7B%5Cn%5C%0A%20%20color%3A%20rgb%28255%2C%20255%2C%20255%29%3B%5Cn%5C%0A%20%20padding%3A%201em%3B%5Cn%5C%0A%20%20text-decoration%3A%20none%3B%5Cn%5C%0A%7D%5Cn%5C%0A%23button%20a%2C%20code%2C%20code%3Abefore%2C%20initcode%2C%20initcode%3Abefore%2C%20help%2C%20help%3Abefore%20%7B%5C%0A%5Cn%20%20display%3A%20block%3B%5Cn%5C%0A%7D%5Cn%5C%0A%23credits%20%7B%20position%3A%20fixed%3B%20bottom%3A%201em%3B%20right%3A%201em%3B%20font-size%3A%20small%3B%20%7D%5Cn%5C%0Acustombutton%20%7B%20background-color%3A%20rgb%28171%2C%20171%2C%20171%29%3B%20margin%3A%201em%3B%20%7D%5Cn%5C%0Aimage%2C%20mode%2C%20accelkey%20%7B%20display%3A%20none%3B%20%7D%5Cn%5C%0Aname%20%7B%20font-weight%3A%20bold%3B%20font-size%3A%20x-large%3B%20%7D%5Cn%5C%0Acode%3Abefore%2C%20help%3Abefore%2C%20initcode%3Abefore%20%7B%5Cn%5C%0A%20%20font-weight%3A%20bold%3B%5Cn%5C%0A%20%20font-size%3A%20large%3B%5Cn%5C%0A%20%20margin%3A%200%200%201em%3B%5Cn%5C%0A%20%20padding%3A%20.5em%3B%5Cn%5C%0A%7D%5Cn%5C%0Acode%3Abefore%20%7B%20content%3A%20%5C%22CODE%5C%22%3B%20%7D%5Cn%5C%0Ahelp%3Abefore%20%7B%20content%3A%20%5C%22Help%5C%22%3B%20%7D%5Cn%5C%0Ainitcode%3Abefore%20%7B%20content%3A%20%5C%22Initialization%20Code%5C%22%3B%20%7D%5Cn%5C%0Acode%2C%20initcode%2C%20help%20%7B%5Cn%5C%0A%20%20background-color%3A%20rgb%28255%2C%20255%2C%20255%29%3B%5Cn%5C%0A%20%20border%3A%201px%20inset%20rgb%28170%2C%20170%2C%20170%29%3B%5Cn%5C%0A%20%20font%3A%20medium%20monospace%3B%5Cn%5C%0A%20%20margin%3A%201em%201em%202em%200%3B%5Cn%5C%0A%20%20padding%3A%201em%3B%5Cn%5C%0A%20%20text-align%3A%20left%3B%5Cn%5C%0A%20%20width%3A%20840px%3B%5Cn%5C%0A%20%20white-space%3A%20pre-wrap%3B%5Cn%5C%0A%20%20word-wrap%3A%20break-word%3B%5Cn%5C%0A%7D%5Cn%5C%0A.clear%20%7B%20clear%3A%20both%3B%20%7D%5Cn%5C%0A%5D%5D%26gt%3B%26lt%3B/html%3Astyle%26gt%3B%5Cn%5C%0A%20%20%26lt%3B/html%3Ahead%26gt%3B%5Cn%5C%0A%20%20%26lt%3Bhtml%3Abody%26gt%3B%5Cn%5C%0A%20%20%20%20%26lt%3Bhtml%3Adiv%20id%3D%5C%22wrapper%5C%22%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%26lt%3Bhtml%3Adiv%20id%3D%5C%22button%5C%22%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%26lt%3Bhtml%3Aa%20href%3D%5C%22%22%20+%20cbURI%20+%20%22%5C%22%20rel%3D%5C%22nofollow%5C%22%20title%3D%5C%22%22%20+%0A%20%20%20%20%20%20%20%20name%20+%22%5C%22%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%26lt%3B%21%5BCDATA%5BInstall%20this%20button%5D%5D%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%26lt%3B/html%3Aa%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%26lt%3B/html%3Adiv%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%26lt%3Bhtml%3Aa%20href%3D%5C%22https%3A//addons.mozilla.org/addon/custom-buttons/%5C%22%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%26lt%3B%21%5BCDATA%5BWhat%27s%20this%3F%5D%5D%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%26lt%3B/html%3Aa%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%26lt%3Bhtml%3Adiv%20id%3D%5C%22credits%5C%22%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%26lt%3Bhtml%3Aa%20href%3D%5C%22http%3A//custombuttons.mozdev.org/drupal/node/484%5C%22%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%20%20%26lt%3B%21%5BCDATA%5BCustom%20Buttons%20XML%5D%5D%26gt%3B%26lt%3Bhtml%3Abr/%26gt%3B%5C%0A%26lt%3B%21%5BCDATA%5BExporter/Importer%5D%5D%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%20%20%26lt%3B/html%3Aa%26gt%3B%5Cn%5C%0A%20%20%20%20%20%20%26lt%3B/html%3Adiv%26gt%3B%5Cn%5C%0A%20%20%20%20%26lt%3B/html%3Adiv%26gt%3B%5Cn%5C%0A%20%20%26lt%3B/html%3Abody%26gt%3B%5Cn%22%3B%0A%0A%20%20decodeXML%20%3D%20decodeXML.replace%28/custombuttons%5C/%5C%22%5C%26gt%3B/%2C%20xmlTemplate%29%3B%0A%0A%20%20name%20+%3D%20%22.xml%22%3B%0A%20%20saveFile%28name%2C%20decodeXML%29%3B%0A%7D%0A%0Athis.loadXML%20%3D%20function%28%29%20%7B%0A%20%20var%20fp%20%3D%20Cc%5B%22@mozilla.org/filepicker%3B1%22%5D.createInstance%28nsIFilePicker%29%3B%0A%20%20fp.init%28window%2C%0A%20%20%20%20%20%20%20%20%20%20%22Import%20an%20XML%20file%20and%20install%20it%20as%20a%20new%20button%22%2C%0A%20%20%20%20%20%20%20%20%20%20nsIFilePicker.modeOpen%29%3B%0A%20%20fp.appendFilters%28nsIFilePicker.filterXML%29%3B%0A%20%20fp.appendFilter%28%22All%20Files%22%2C%20%22*.*%22%29%3B%0A%20%20fp.displayDirectory%20%3D%20lastDirectory.path%3B%0A%20%20if%20%28fp.show%28%29%20%3D%3D%20nsIFilePicker.returnOK%29%20%7B%0A%20%20%20%20if%20%28fp.file%20%26amp%3B%26amp%3B%20fp.file.exists%28%29%29%20%7B%0A%20%20%20%20%20%20lastDirectory.path%20%3D%20fp.file.parent.QueryInterface%28nsILocalFile%29%3B%0A%20%20%20%20%7D%0A%20%20%7D%20else%20%7B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20var%20xmlData%20%3D%20readFile%28fp.file%29%3B%0A%20%20var%20xmlDOM%20%3D%20stringToDOM%28xmlData%29%3B%0A%20%20if%20%28%21xmlDOM%29%20%7B%0A%20%20%20%20//Application.console.log%28xmlDOM%29%3B%0A%20%20%20%20custombuttons.alertBox%28%22Import%20Fail%22%2C%20%22Not%20an%20XML%20file%21%22%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%0A%20%20if%20%28%28xmlDOM.localName%20%3D%3D%20%22custombutton%22%29%20%26amp%3B%26amp%3B%0A%20%20%20%20%20%20%28%28xmlDOM.getAttribute%28%22xmlns%3Acb%22%29%20%3D%3D%20%22http%3A//xsms.nm.ru/custombuttons/%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%28xmlDOM.getAttribute%28%22xmlns%3Acb%22%29%20%3D%3D%20%22http%3A//xsms.nm.ru/custombuttons%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%28xmlDOM.getAttribute%28%22xmlns%22%29%20%3D%3D%20%22http%3A//xsms.nm.ru/custombuttons/%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%28xmlDOM.getAttribute%28%22xmlns%22%29%20%3D%3D%20%22http%3A//xsms.nm.ru/custombuttons%22%29%29%29%20%7B%0A%20%20%20%20importXMLtoButton%28xmlData%29%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20custombuttons.alertBox%28%22Import%20Fail%22%2C%20%22Not%20a%20valid%20Custom%20Buttons%20XML%21%22%29%3B%0A%20%20%7D%0A%7D%0A%0A////////////////////////////////////////////////////////////////////////////%0A///////////////////////////%20Init%20CB%20Contextmenu%20////////////////////////////%0A////////////////////////////////////////////////////////////////////////////%0A%0Afunction%20addMenuItem%28aNewIDs%2C%20aNodeIDs%2C%20aLabel%2C%20aIcon%2C%20aCommand%29%20%7B%0A%20%20for%20%28var%20i%20%3D%200%3B%20i%20%26lt%3B%20aNewIDs.length%3B%20i++%29%20%7B%0A%20%20%20%20//%20Remove%20previously%20created%20menuitems%20if%20any%0A%20%20%20%20if%20%28%24%28aNewIDs%5Bi%5D%29%29%20%24%28aNewIDs%5Bi%5D%29.parentNode.removeChild%28%24%28aNewIDs%5Bi%5D%29%29%3B%0A%0A%20%20%20%20//%20Added%20%27Export%20to%20XML%27%20menuitem%20to%20CB%20contextmenu%0A%20%20%20%20let%20mi%20%3D%20cbu.makeXML%28%26lt%3Bmenuitem%20xmlns%3D%7Bxulns%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7BaNewIDs%5Bi%5D%7D%20class%3D%22menuitem-iconic%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20image%3D%7BaIcon%7D%20label%3D%7BaLabel%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%7BaCommand%7D/%26gt%3B%29%3B%0A%0A%20%20%20%20if%20%28i%20%3D%3D%200%29%20%7B%0A%20%20%20%20%20%20mi.setAttribute%28%22observes%22%2C%20%22custombuttons-contextbroadcaster-primary%22%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20%24%28aNodeIDs%5Bi%5D%29.parentNode.insertBefore%28mi%2C%20%24%28aNodeIDs%5Bi%5D%29.nextSibling%29%3B%0A%20%20%7D%0A%7D%0A%0Avar%20saveImg%20%3D%20%22data%3Aimage/x-icon%3Bbase64%2C%5C%0AAAABAAEAEBAAAAAAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAQAQAAAAAAAAAAAAAAAAA%5C%0AAAAAAAD///8B////Af///wH///8BAAAAHQAAACUXaE1dE55y/xOecv8XaE1dAAAAJQAAAB3///8B%5C%0A////Af///wH///8B////Af///wH///8B////Af///wEmrX85F6J2/xHEj/8RxI//GKF2/yatfzn/%5C%0A//8B////Af///wH///8B////Af///wH///8B////Af///wEmrX85Hqd6/xHHkv8Rx5L/EceS/xHH%5C%0Akv8ep3r/Jq1/Of///wH///8B////Af///wH///8B////Af///wEhs4RJJq1//xHHkv8Rx5L/EceS%5C%0A/xHHkv8Rx5L/EciT/yatgP8mrX85////Af///wH///8B////Af///wEjsYJBLLKE/xHNlv8RyJP/%5C%0AEciT/xHIk/8RyJP/EciT/xHKlf8Rzpn/LLOE/yatfzn///8B////Af///wEmrX85MbaH/xTcqP8V%5C%0A3qv/Fd2q/xHKlf8RypX/EcqV/xHKlf8W4a7/Fd6r/xTZpf8xtof/Jq1/Of///wEmrX1pMbaH/zG3%5C%0AiP8xt4j/MbeI/xfWov8RzJj/EcyY/xHMmP8RzJj/H8SR/zG3iP8xt4j/MbeI/zG2h/8mrX85////%5C%0AAf///wH///8B////Af///wEuuov/Ec+a/xHPmv8Rz5r/FNCc/xbUoPEisH7v////Af///wH///8B%5C%0A////Af///wH///8B////Af///wH///8BLrqL/xHTnv8R057/EdOe/xXUoP8a2KT3H7J/4ymaaSUp%5C%0AmmklKZppJSmaaSX///8B////Af///wH///8B////AS66i/8R1aH/EdWh/xHVof8U1qL/Idyp/ySh%5C%0Ab+0koW/tJKJw6ySlc+0noG/5////Af///wH///8B////Af///wEuuov/Edej/xHXo/8R16P/Edej%5C%0A/yzgsP8ZsH//GrOB/xm6hv8ZwI3/JqFw6////wH///8B////Af///wH///8BLrqL/xHapf8R2qX/%5C%0AEdql/xHapf895bf/KbCC/yCpef8gsH7/Hb6M/yidbNP///8B////Af///wH///8B////ASPNmv8Y%5C%0A3ar/Edyn/xHcp/8V3aj/VerA/1DNpP8moHH/JqJz/yG7ifsvv5L/////Af///wH///8B////Af//%5C%0A/wEizJn1b+/J/2nux/9k7cX/b+/J/3Dvyf9r7cb/MJ9x/yype/8jt4XzL7+S/////wH///8B////%5C%0AAf///wH///8BFL+KOTjWp/9B6Lv/Oea4/zjmuP9G6Lz/WuzD/1rcs/9B0aT7L7+S/////wH///8B%5C%0A////Af///wH///8B////Af///wEXwo5lFMWQzxPFkNUTxZDZE8WQ0xXEkNcmxJPVQsie/////wH/%5C%0A//8BAAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA%5C%0A//8AAP//AAD//w%3D%3D%22%3B%0A%0Alet%20cIDs%20%3D%20%5B%22custombuttons-contextpopup-exportXML%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22custombuttons-contextpopup-exportXML-sub%22%5D%3B%0Alet%20bIDs%20%3D%20%5B%22custombuttons-contextpopup-bookmarkButton%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22custombuttons-contextpopup-bookmarkButton-sub%22%5D%3B%0Alet%20kIDs%20%3D%20%5Bthis.id%20+%20%22-checkForUpdate%22%2C%20this.id%20+%20%22-checkForUpdate-sub%22%5D%3B%0Alet%20uIDs%20%3D%20%5B%22custombuttons-contextpopup-updateButton%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22custombuttons-contextpopup-updateButton-sub%22%5D%3B%0A%0A//%20Add%20%27Export%20to%20XML%27%20menuitem%20to%20CB%20contextmenu%0AaddMenuItem%28cIDs%2C%20bIDs%2C%20%22Export%20to%20XML%22%2C%20saveImg%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22document.getElementById%28%27%22%20+%20this.id%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%27%29.saveXML%28document.popupNode.URI%29%3B%22%29%3B%0A%0A//%20Add%20%27Check%20for%20Update...%27%20menuitem%20to%20CB%20contextmenu%0AaddMenuItem%28kIDs%2C%20uIDs%2C%20%22Check%20for%20Updates%20for%20this%20button%22%2C%20this.image%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22var%20btn%20%3D%20document.getElementById%28%27%22%20+%20this.id%20+%20%22%27%29%3B%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%22btn.updater.checkForUpdate%28btn.updater.getUpdate%29%3B%22%29%3B%0A%0Afunction%20initCbPopup%28%29%20%7B%0A%20%20%24%28Button.id%20+%20%22-checkForUpdate%22%29.hidden%20%3D%20%28document.popupNode%20%21%3D%20Button%29%3B%0A%7D%0A%0A%24%28bIDs%5B0%5D%29.parentNode.addEventListener%28%22popupshowing%22%2C%20initCbPopup%2C%20false%29%3B%0A%24%28bIDs%5B0%5D%29.parentNode.removeEventListener%28%22popuphiding%22%2C%20initCbPopup%2C%20false%29%3B%0A%0A//%20Remove%20contextmenu%20items%20when%20this%20button%20is%20deleted%0Athis.onDestroy%20%3D%20function%28%29%20%7B%0A%20%20%24%28kIDs%5B0%5D%29.parentNode.removeEventListener%28%22popupshowing%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20initCbPopup%2C%20false%29%3B%0A%20%20for%20%28var%20i%20%3D%200%3B%20i%20%26lt%3B%202%3B%20i++%29%20%7B%0A%20%20%20%20%24%28cIDs%5Bi%5D%29%20%26amp%3B%26amp%3B%20%24%28cIDs%5Bi%5D%29.parentNode.removeChild%28%24%28cIDs%5Bi%5D%29%29%3B%0A%20%20%20%20%24%28kIDs%5Bi%5D%29%20%26amp%3B%26amp%3B%20%24%28kIDs%5Bi%5D%29.parentNode.removeChild%28%24%28kIDs%5Bi%5D%29%29%3B%0A%20%20%7D%0A%7D%0A%0A//----------%20Remove%20old%20traces%20if%20any%20----------//%0Alet%20tbitem%20%3D%20%24%28this.id%20+%20%22-toolbaritem%22%29%3B%0Atbitem%20%26amp%3B%26amp%3B%20tbitem.parentNode.removeChild%28tbitem%29%3B%0Alet%20css%20%3D%20%22%5C%0A@namespace%20url%28http%3A//www.mozilla.org/keymaster/gatekeeper/there.is.only.xul%29%3B%5C%0A%23navigator-toolbox%3Anot%28%5Bcustomizing%3D%5C%22true%5C%22%5D%29%20%23%22%20+%20this.id%20+%20%22%2C%5C%0A%23navigator-toolbox%5Bcustomizing%3D%5C%22true%5C%22%5D%20%23%22%20+%20this.id%20+%20%22-toolbaritem%5C%0A%7B%20display%3A%20none%3B%20%7D%22%3B%0Alet%20sss%20%3D%20Cc%5B%22@mozilla.org/content/style-sheet-service%3B1%22%5D.%0A%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIStyleSheetService%29%3B%0Alet%20uri%20%3D%20makeURI%28%22data%3Atext/css%2C%22%20+%20encodeURIComponent%28css%29%2C%20null%2C%20null%29%3B%0Aif%20%28sss.sheetRegistered%28uri%2C%20sss.USER_SHEET%29%29%20%7B%0A%20%20sss.unregisterSheet%28uri%2C%20sss.USER_SHEET%29%3B%0A%7D%0A%0A////////////////////////////////////////////////////////////////////////////%0A//////////////////////////////%20Button%20updater%20//////////////////////////////%0A////////////////////////////////////////////////////////////////////////////%0A%0Athis.updateURL%20%3D%20%22http%3A//loucypher.googlecode.com/svn/custombuttons/xml/%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Custom%2520Buttons%2520XML%2520Exporter-Importer.xml%22%3B%0A%0Athis.onclick%20%3D%20function%28aEvent%29%20%7B%0A%20%20if%20%28%21aEvent.shiftKey%29%20return%3B%0A%20%20aEvent.preventDefault%28%29%3B%0A%20%20this.updater.checkForUpdate%28this.updater.getUpdate%29%3B%0A%7D%0A%0Avar%20btnClick%20%3D%20this.onclick%3B%0Avar%20btnIcon%20%3D%20this.image%3B%0Avar%20Button%20%3D%20this%3B%0A%0Athis.updater%20%3D%20%7B%0A%0A%20%20get%20bsyIcon%28%29%20%7B%0A%20%20%20%20return%20%20Application.name%20%3D%3D%20%22Firefox%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%3F%20Application.version%20%26gt%3B%3D%20%224%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3F%20%22chrome%3A//browser/skin/tabbrowser/connecting.png%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%22chrome%3A//global/skin/icons/loading_16.png%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%3A%20Application.name%20%3D%3D%20%22SeaMonkey%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3F%20%22chrome%3A//communicator/skin/icons/loading.gif%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%22chrome%3A//custombuttons/skin/button.png%22%3B%0A%20%20%7D%2C%0A%0A%20%20isValidCbURI%3A%20function%20isValidCbURI%28aURL%29%20%7B%0A%20%20%20%20if%20%28%21aURL%29%20return%20false%3B%0A%20%20%20%20return%20/%5Ecustombutton%5C%3A%5C/%5C//.test%28aURL%29%3B%0A%20%20%7D%2C%0A%0A%20%20convertURItoDOM%3A%20function%20convertURItoDOM%28aURL%29%20%7B%0A%20%20%20%20if%20%28%21this.isValidCbURI%28aURL%29%29%20%7B%0A%20%20%20%20%20%20custombuttons.alertBox%28Button.name%2C%20%22Not%20a%20Custom%20Buttons%20link%21%22%29%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20string%20%3D%20unescape%28aURL.replace%28/%5Ecustombutton%5C%3A%5C/%5C//%2C%20%22%22%29.toString%28%29%29%3B%0A%20%20%20%20var%20parser%20%3D%20new%20DOMParser%28%29%3B%0A%20%20%20%20var%20dom%20%3D%20parser.parseFromString%28string%2C%20%22text/xml%22%29%3B%0A%20%20%20%20if%20%28dom.documentElement.nodeName%20%3D%3D%20%22parsererror%22%29%20%7B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20return%20dom.documentElement%3B%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%0A%20%20getParamValue%3A%20function%20getParamValue%28aDocument%2C%20aNodeName%29%20%7B%0A%20%20%20%20var%20node%20%3D%20aDocument.querySelector%28aNodeName%29%3B%0A%20%20%20%20if%20%28%21node%29%20return%20%22%22%3B%0A%20%20%20%20if%20%28%21node.firstChild%20%7C%7C%20%28node.firstChild%20%26amp%3B%26amp%3B%0A%20%20%20%20%20%20%20%20%28node.firstChild.nodeType%20%3D%3D%20node.TEXT_NODE%29%29%29%20%7B%0A%20%20%20%20%20%20return%20node.textContent%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20return%20node.firstChild.textContent%3B%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%0A%20%20getButtonParameters%3A%20function%20getButtonParameters%28aButtonLink%2C%20aURL%29%20%7B%0A%20%20%20%20var%20dom%20%3D%20this.convertURItoDOM%28aURL%29%3B%0A%20%20%20%20var%20params%20%3D%20custombuttons.cbService.getButtonParameters%28aButtonLink%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.wrappedJSObject%3B%0A%20%20%20%20params.name%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22name%22%29%0A%20%20%20%20params.image%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22image%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.getParamValue%28dom%2C%20%22stdicon%22%29%3B%0A%20%20%20%20params.code%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22code%22%29%0A%20%20%20%20params.initCode%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22initcode%22%29%0A%20%20%20%20params.help%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22help%22%29%0A%20%20%20%20params.accelkey%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22accelkey%22%29%0A%20%20%20%20params.mode%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20this.getParamValue%28dom%2C%20%22mode%22%29%0A%20%20%20%20params.wrappedJSObject%20%20%3D%20params%3B%0A%20%20%20%20return%20params%3B%0A%20%20%7D%2C%0A%0A%20%20resetAttributes%3A%20function%20resetAttributes%28%29%20%7B%0A%20%20%20%20Button.image%20%3D%20btnIcon%3B%0A%20%20%20%20Button.tooltipText%20%3D%20Button.name%3B%0A%20%20%20%20Button.removeAttribute%28%22busy%22%29%3B%0A%20%20%20%20Button.onclick%20%3D%20btnClick%3B%0A%20%20%7D%2C%0A%0A%20%20checkForUpdate%3A%20function%20checkForUpdate%28aCallback%29%20%7B%0A%20%20%20%20var%20url%20%3D%20Button.updateURL%20+%20%22%3F%22%20+%20Date.now%28%29%3B%0A%20%20%20%20var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%20%20%20%20req.open%28%22GET%22%2C%20url%2C%20true%29%3B%0A%20%20%20%20if%20%28Button.hasAttribute%28%22busy%22%29%29%20%7B%0A%20%20%20%20%20%20this.resetAttributes%28%29%3B%0A%20%20%20%20%20%20return%0A%20%20%20%20%7D%0A%20%20%20%20var%20updater%20%3D%20this%3B%0A%20%20%20%20req.onreadystatechange%20%3D%20function%20%28aEvent%29%20%7B%0A%20%20%20%20%20%20Button.onclick%20%3D%20function%28aEvent%29%20%7B%0A%20%20%20%20%20%20%20%20aEvent.preventDefault%28%29%3B%0A%20%20%20%20%20%20%20%20req.abort%28%29%3B%0A%20%20%20%20%20%20%20%20this.updater.resetAttributes%28%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20Button.image%20%3D%20updater.bsyIcon%3B%0A%20%20%20%20%20%20Button.setAttribute%28%22busy%22%2C%20%22%22%29%3B%0A%20%20%20%20%20%20Button.tooltipText%20%3D%20%22Checking%20for%20update...%5CnClick%20to%20abort.%22%3B%0A%20%20%20%20%20%20if%20%28req.readyState%20%3D%3D%204%20%26amp%3B%26amp%3B%20req.status%20%3D%3D%20200%29%20%7B%0A%20%20%20%20%20%20%20%20updater.resetAttributes%28%29%3B%0A%20%20%20%20%20%20%20%20aCallback%28req.responseXML%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20req.send%28null%29%3B%0A%20%20%7D%2C%0A%0A%20%20getUpdate%3A%20function%20getUpdate%28aDocument%29%20%7B%0A%20%20%20%20if%20%28aDocument.documentElement.localName%20%21%3D%20%22custombutton%22%29%20%7B%0A%20%20%20%20%20%20alert%28%22Not%20a%20valid%20Custom%20Buttons%20XML%20file%21%22%29%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%0A%20%20%20%20let%20button%20%3D%20aDocument.getElementById%28%22button%22%29%3B%0A%20%20%20%20let%20link%20%3D%20button.getElementsByTagNameNS%28%22http%3A//www.w3.org/1999/xhtml%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22a%22%29%5B0%5D%3B%0A%20%20%20%20if%20%28link.href%20%3D%3D%20Button.URI%29%20%7B%0A%20%20%20%20%20%20let%20as%20%3D%20Cc%5B%27@mozilla.org/alerts-service%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIAlertsService%29%3B%0A%20%20%20%20%20%20as.showAlertNotification%28btnIcon%2C%20%22No%20update%20found%21%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Finish%20checking%22%2C%20false%2C%20%22%22%2C%20null%29%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%20%0A%20%20%20%20var%20install%20%3D%20custombuttons.confirmBox%28Button.name%2C%20%22Update%20found%21%20%22%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Update%20this%20button%3F%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Yes%22%2C%20%22No%22%29%3B%0A%20%20%20%20if%20%28%21install%29%20return%3B%0A%20%20%20%20let%20btnLink%20%3D%20custombuttons.makeButtonLink%28%22update%22%2C%20Button.id%29%3B%0A%20%20%20%20let%20params%20%3D%20Button.updater.getButtonParameters%28btnLink%2C%20link.href%29%3B%0A%20%20%20%20custombuttons.cbService.installButton%28params%29%3B%0A%20%20%20%20custombuttons.alertBox%28Button.name%2C%20%22Button%20updated%21%22%29%3B%0A%20%20%7D%0A%7D%0A%0A/////////////////////////////////////////////////////////////////////////////%0A%0Athis.label%20%3D%20%22Import%20XML%20File%20As%20New%20Button%22%3B%0Athis.tooltipText%20%3D%20this.Help%3B%0A%0A%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5B/*%0A%20%20Changelog%3A%0A%20%20%20%20*%202011-06-26%3A%0A%20%20%20%20%20%20%201.%20Fixed%20all%20known%20issues.%0A%20%20%20%20%20%20%202.%20No%20longer%20using%20toolbaritems%2C%20the%20cause%20of%20all%20issues.%0A%20%20%20%20*%202011-06-15%3A%0A%20%20%20%20%20%20%201.%20Includes%20button%27s%20image%20as%20XML%20favicon%0A%20%20%20%20%20%20%202.%20No%20longer%20using%20%3Cscript%3E%0A%20%20%20%20%20%20%203.%20Fixed%3A%20namespace%20bug.%0A%20%20%20%20*%202011-06-14%3A%0A%20%20%20%20%20%20%201.%20Includes%20template%20and%20CSS%20as%20you%20can%20see%20if%20you%20click%20the%20green%20button%20above.%0A%20%20%20%20%20%20%20%20%20%20I%20need%20your%20inputs%20in%20comment%20section%20about%20the%20template.%0A%20%20%20%20%20%20%202.%20Yep%21%20I%20changed%20the%20name%20again.%0A%20%20%20%20*%202011-06-12%3A%20Added%20%27Export%20to%20XML%27%20to%20CB%20contextmenu.%0A%20%20%20%20*%202011-06-11%3A%20No%20more%20third%20button%20%28dropmarker%29.%0A%20%20%20%20*%202011-06-10%3A%0A%20%20%20%20%20%20%201.%20Fixed%3A%20toolbaritem%20%282-button%29%20wasn%27t%20removed%20when%20this%20button%20was%20deleted.%0A%20%20%20%20%20%20%20%20%20%20Thanks%20to%20Morat.%0A%20%20%20%20%20%20%202.%20Fixed%3A%20toolbaritem%20%282-button%29%20wasn%27t%20removed%20when%20this%20button%20was%20moved.%0A%20%20%20%20%20%20%203.%20Import%20XML%20file%20that%20is%20opened%20in%20browser%20window.%20Open%20this%20XML%20file%20to%20test%20it.%0A%20%20%20%20%20%20%204.%20Supports%20application/xml%20content%20type%20as%20well%20as%20text/xml.%0A%20%20%20%20*%202011-06-09%3A%0A%20%20%20%20%20%20%201.%20Initial%20release%0A%20%20%20%20%20%20%202.%20Fixed%3A%20error%20with%20Cyrillic%20characters%0A%20%20%20%20%20%20%203.%20Changed%20its%20name%20from%20Save/Load%20to%20Export/Import.%0A%20%20%20%20%20%20%204.%20CB%20contextmenu%20now%20works%20with%20the%20two%20buttons.%0A%20%20%20%20%20%20%205.%20Check%20for%20valid%20CB%20XML%20before%20installing%20an%20XML%20file%20to%20a%20new%20button.%0A%0A%20%20Credits%3A%0A%20%20%20%20Contextmenu%20Icon%20by%20PixelMixer%0A%20%20%20%20%20-%20http%3A//pixelmixer.ru/%0A%20%20%20%20%20-%20http%3A//pixel-mixer.com/%0A%0A%20%20References%3A%0A%20%20-%20https%3A//addons.mozilla.org/firefox/files/browse/93414/file/content/loadsaveutils.js%0A%20%20-%20https%3A//developer.mozilla.org/en/nsIFilePicker%0A%20%20-%20https%3A//developer.mozilla.org/en/Code_snippets%3AFile_I/O%0A%20%20-%20https%3A//developer.mozilla.org/en/Parsing_and_serializing_XML%0A%20%20-%20https%3A//developer.mozilla.org/en/Using_the_Stylesheet_Service%0A%0A*/%0A%0Athis.checkDocumentForCBXML%28content.document%29%3B%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5B%0ATo%20export%3A%0A1.%20Right%20click%20on%20any%20custom%20buttons%0A2.%20Select%20%27Export%20to%20XML%27%0A%0A%0ATo%20import%3A%0A1.%20Click%20this%20button%0A2.%20Select%20a%20Custom%20Buttons%20XML%20file%0A%0Aor%20just%20open%20any%20Custom%20Buttons%20XML%20file%20to%20import.%0A%0A%0A%0AShift+click%3A%20Find%20update%20for%20this%20button.%0A%0A%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Custom Buttons XML Exporter/Importer">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.mozdev.org/drupal/node/484">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>

  <name>Custom Buttons XML Exporter/Importer</name>
  <image><![CDATA[data:image/gif;base64,R0lGODlhGAAQALMAAH9AAP+AAP/AgP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAQAAAEUFDISaudIevNu/9gKH5SVmIBVnLDILVBO2RyPHOAPAC2K9SwTm5H0wFvnJ+raJwFN8qWwDYc2lZFgBXGddY02kx4zCOHR+i0eg3Wut/wuDsCADs=]]></image>
  <mode>0</mode>
  <initcode>/* ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License
 * Version 1.1 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * Original code is Export Button to XML File/Import XML File As New Button
 * for Custom Buttons extension
 *
 * The Initial Developer of the Original Code is LouCypher.
 * Portions created by the Initial Developer are Copyright (C) 2011
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 * - LouCypher: original code
 * - Morat: onDestroy event, bug report
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"),
 * in which case the provisions of the GPL are applicable instead of those
 * above.
 *
 * ***** END LICENSE BLOCK ***** */

const nsIFilePicker = Ci.nsIFilePicker;
const nsILocalFile = Ci.nsILocalFile;

function $(aId) {
  return document.getElementById(aId);
}

var lastDirectory = {
  _lastDir: null,

  get path() {
    if (!this._lastDir || !this._lastDir.exists()) {
      try {
        this._lastDir = cbu.ps.getComplexValue("custombuttons.XML.lastDir",
                                               nsILocalFile);
        if (!this._lastDir.exists())
          this._lastDir = null;
      }
      catch(e) {}
    }
    return this._lastDir;
  },

  set path(val) {
    if (!val || !val.exists() || !val.isDirectory())
      return;
    this._lastDir = val.clone();
    cbu.ps.setComplexValue("custombuttons.XML.lastDir",
                           nsILocalFile, this._lastDir);
  }
}

function saveFile(aFileName, aStrData) {
  var fp = Cc["@mozilla.org/filepicker;1"].createInstance(nsIFilePicker);
  fp.appendFilters(nsIFilePicker.filterXML);
  fp.init(window, "Export button to XML file", nsIFilePicker.modeSave);
  fp.defaultString = aFileName;
  fp.displayDirectory = lastDirectory.path;
  var res = fp.show();
  if (res == nsIFilePicker.returnOK || res == nsIFilePicker.returnReplace) {
    lastDirectory.path = fp.file.parent.QueryInterface(nsILocalFile);
    var ostream = Cc["@mozilla.org/network/file-output-stream;1"].
                  createInstance(Ci.nsIFileOutputStream);
    ostream.init(fp.file, 0x02 | 0x08 | 0x20, 0664, 0);
    var charset = "UTF-8";
    var os = Cc["@mozilla.org/intl/converter-output-stream;1"].
             createInstance(Ci.nsIConverterOutputStream);
    os.init(ostream, charset, 4096, 0x0000);
    os.writeString(aStrData);
    os.close();
  }
}

function readFile(file) {
  var data = "";
  var fstream = Cc["@mozilla.org/network/file-input-stream;1"].
                createInstance(Ci.nsIFileInputStream);
  fstream.init(file, -1, 0, 0);
  var charset = "UTF-8";
  const replacementChar = Ci.nsIConverterInputStream
                            .DEFAULT_REPLACEMENT_CHARACTER;
  var is = Cc["@mozilla.org/intl/converter-input-stream;1"].
           createInstance(Ci.nsIConverterInputStream);
  is.init(fstream, charset, 1024, replacementChar);
  var str = {};
  while (is.readString(4096, str) != 0) {
    data += str.value;
  }
  is.close();

  return data;
}

function stringToDOM(aString) {
// https://developer.mozilla.org/en/Parsing_and_serializing_XML
  var parser = new DOMParser();
  var dom = parser.parseFromString(aString, "text/xml");
  if (dom.documentElement.nodeName == "parsererror") {
    return null;
  } else {
    return dom.documentElement;
  }
}

function importXMLtoButton(aStrXMLData) {
  loadURI("custombutton://" + escape(aStrXMLData));
}

this.checkDocumentForCBXML = function(aDocument) {
  if (((aDocument.contentType == "text/xml") ||
       (aDocument.contentType == "application/xml"))&amp;&amp;
      (aDocument.documentElement.localName == "custombutton")) {
    var serializer = new XMLSerializer();
    var xml = serializer.serializeToString(aDocument);
    importXMLtoButton(xml);
  } else {
    this.loadXML();
  }
}

this.saveXML = function(aStrURI) {
  var cbURI = (aStrURI != undefined) ? aStrURI : readFromClipboard();
  if (!cbURI || !/^custombutton\:\/\//.test(cbURI)) {
    custombuttons.uChelpButton(this);
    return;
  }

  var cbXML = cbURI.replace(/^custombutton\:\/\//, "");
  var decodeXML = unescape(cbXML);
  var btnName = decodeXML.match(/\&lt;name\/?.+/).toString();
  var name = "untitled";
  if (!/\&lt;name\/\&gt;/.test(btnName)) {
    name = btnName.replace(/\&lt;\/?\w+\&gt;/g, "").toString();
  }
  var image = decodeXML.match(/\&lt;image\/?.+/).toString();
  var icon = "";
  if (!/\&lt;\image.*\[\].*\&gt;$/.test(image)) {
    icon = image.match(/[^\[\]]+/g)[2].toString()
                .replace(/custombuttons\-stdicon\-\d/, "").toString();
  }
  
  var xmlTemplate = "custombuttons/\"\n\
              xmlns:html=\"http://www.w3.org/1999/xhtml\"&gt;\n\
  &lt;html:head&gt;\n\
    &lt;html:title&gt;&lt;![CDATA[" + name + "]]&gt;&lt;/html:title&gt;\n\
    &lt;html:link rel=\"shortcut icon\" href=\"" + icon + "\"/&gt;\n\
    &lt;html:style type=\"text/css\"&gt;&lt;![CDATA[\
body { font-size: medium; margin: 0; }\n\
body, code:before, help:before, initcode:before {\n\
  font-family: \"Verdana\", sans-serif;\n\
} \n\
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }\n\
p { font-size: small; text-align: center; }\n\
#button {\n\
  background-image: -moz-linear-gradient(center top, rgb(147, 200, 94) 30%,\
 rgb(85, 168, 2) 55%);\n\
  border: 1px outset rgb(58, 116, 4);\n\
  border-radius: 1em;\n\
  -moz-border-radius: 1em;\n\
  padding: 0;\n\
  text-shadow: 0pt -1px 0pt rgb(58, 116, 4);\n\
  margin-bottom: 1em;\n\
}\n\
#button a {\n\
  color: rgb(255, 255, 255);\n\
  padding: 1em;\n\
  text-decoration: none;\n\
}\n\
#button a, code, code:before, initcode, initcode:before, help, help:before {\
\n  display: block;\n\
}\n\
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }\n\
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }\n\
image, mode, accelkey { display: none; }\n\
name { font-weight: bold; font-size: x-large; }\n\
code:before, help:before, initcode:before {\n\
  font-weight: bold;\n\
  font-size: large;\n\
  margin: 0 0 1em;\n\
  padding: .5em;\n\
}\n\
code:before { content: \"CODE\"; }\n\
help:before { content: \"Help\"; }\n\
initcode:before { content: \"Initialization Code\"; }\n\
code, initcode, help {\n\
  background-color: rgb(255, 255, 255);\n\
  border: 1px inset rgb(170, 170, 170);\n\
  font: medium monospace;\n\
  margin: 1em 1em 2em 0;\n\
  padding: 1em;\n\
  text-align: left;\n\
  width: 840px;\n\
  white-space: pre-wrap;\n\
  word-wrap: break-word;\n\
}\n\
.clear { clear: both; }\n\
]]&gt;&lt;/html:style&gt;\n\
  &lt;/html:head&gt;\n\
  &lt;html:body&gt;\n\
    &lt;html:div id=\"wrapper\"&gt;\n\
      &lt;html:div id=\"button\"&gt;\n\
        &lt;html:a href=\"" + cbURI + "\" rel=\"nofollow\" title=\"" +
        name +"\"&gt;\n\
        &lt;![CDATA[Install this button]]&gt;\n\
        &lt;/html:a&gt;\n\
      &lt;/html:div&gt;\n\
      &lt;html:a href=\"https://addons.mozilla.org/addon/custom-buttons/\"&gt;\n\
        &lt;![CDATA[What's this?]]&gt;\n\
      &lt;/html:a&gt;\n\
      &lt;html:div id=\"credits\"&gt;\n\
        &lt;html:a href=\"http://custombuttons.mozdev.org/drupal/node/484\"&gt;\n\
          &lt;![CDATA[Custom Buttons XML]]&gt;&lt;html:br/&gt;\
&lt;![CDATA[Exporter/Importer]]&gt;\n\
        &lt;/html:a&gt;\n\
      &lt;/html:div&gt;\n\
    &lt;/html:div&gt;\n\
  &lt;/html:body&gt;\n";

  decodeXML = decodeXML.replace(/custombuttons\/\"\&gt;/, xmlTemplate);

  name += ".xml";
  saveFile(name, decodeXML);
}

this.loadXML = function() {
  var fp = Cc["@mozilla.org/filepicker;1"].createInstance(nsIFilePicker);
  fp.init(window,
          "Import an XML file and install it as a new button",
          nsIFilePicker.modeOpen);
  fp.appendFilters(nsIFilePicker.filterXML);
  fp.appendFilter("All Files", "*.*");
  fp.displayDirectory = lastDirectory.path;
  if (fp.show() == nsIFilePicker.returnOK) {
    if (fp.file &amp;&amp; fp.file.exists()) {
      lastDirectory.path = fp.file.parent.QueryInterface(nsILocalFile);
    }
  } else {
    return;
  }
  var xmlData = readFile(fp.file);
  var xmlDOM = stringToDOM(xmlData);
  if (!xmlDOM) {
    //Application.console.log(xmlDOM);
    custombuttons.alertBox("Import Fail", "Not an XML file!");
    return;
  }

  if ((xmlDOM.localName == "custombutton") &amp;&amp;
      ((xmlDOM.getAttribute("xmlns:cb") == "http://xsms.nm.ru/custombuttons/") ||
       (xmlDOM.getAttribute("xmlns:cb") == "http://xsms.nm.ru/custombuttons") ||
       (xmlDOM.getAttribute("xmlns") == "http://xsms.nm.ru/custombuttons/") ||
       (xmlDOM.getAttribute("xmlns") == "http://xsms.nm.ru/custombuttons"))) {
    importXMLtoButton(xmlData);
  } else {
    custombuttons.alertBox("Import Fail", "Not a valid Custom Buttons XML!");
  }
}

////////////////////////////////////////////////////////////////////////////
/////////////////////////// Init CB Contextmenu ////////////////////////////
////////////////////////////////////////////////////////////////////////////

function addMenuItem(aNewIDs, aNodeIDs, aLabel, aIcon, aCommand) {
  for (var i = 0; i &lt; aNewIDs.length; i++) {
    // Remove previously created menuitems if any
    if ($(aNewIDs[i])) $(aNewIDs[i]).parentNode.removeChild($(aNewIDs[i]));

    // Added 'Export to XML' menuitem to CB contextmenu
    let mi = cbu.makeXML(&lt;menuitem xmlns={xulns}
                  id={aNewIDs[i]} class="menuitem-iconic"
                  image={aIcon} label={aLabel}
                  oncommand={aCommand}/&gt;);

    if (i == 0) {
      mi.setAttribute("observes", "custombuttons-contextbroadcaster-primary");
    }
    $(aNodeIDs[i]).parentNode.insertBefore(mi, $(aNodeIDs[i]).nextSibling);
  }
}

var saveImg = "data:image/x-icon;base64,\
AAABAAEAEBAAAAAAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAQAQAAAAAAAAAAAAAAAAA\
AAAAAAD///8B////Af///wH///8BAAAAHQAAACUXaE1dE55y/xOecv8XaE1dAAAAJQAAAB3///8B\
////Af///wH///8B////Af///wH///8B////Af///wEmrX85F6J2/xHEj/8RxI//GKF2/yatfzn/\
//8B////Af///wH///8B////Af///wH///8B////Af///wEmrX85Hqd6/xHHkv8Rx5L/EceS/xHH\
kv8ep3r/Jq1/Of///wH///8B////Af///wH///8B////Af///wEhs4RJJq1//xHHkv8Rx5L/EceS\
/xHHkv8Rx5L/EciT/yatgP8mrX85////Af///wH///8B////Af///wEjsYJBLLKE/xHNlv8RyJP/\
EciT/xHIk/8RyJP/EciT/xHKlf8Rzpn/LLOE/yatfzn///8B////Af///wEmrX85MbaH/xTcqP8V\
3qv/Fd2q/xHKlf8RypX/EcqV/xHKlf8W4a7/Fd6r/xTZpf8xtof/Jq1/Of///wEmrX1pMbaH/zG3\
iP8xt4j/MbeI/xfWov8RzJj/EcyY/xHMmP8RzJj/H8SR/zG3iP8xt4j/MbeI/zG2h/8mrX85////\
Af///wH///8B////Af///wEuuov/Ec+a/xHPmv8Rz5r/FNCc/xbUoPEisH7v////Af///wH///8B\
////Af///wH///8B////Af///wH///8BLrqL/xHTnv8R057/EdOe/xXUoP8a2KT3H7J/4ymaaSUp\
mmklKZppJSmaaSX///8B////Af///wH///8B////AS66i/8R1aH/EdWh/xHVof8U1qL/Idyp/ySh\
b+0koW/tJKJw6ySlc+0noG/5////Af///wH///8B////Af///wEuuov/Edej/xHXo/8R16P/Edej\
/yzgsP8ZsH//GrOB/xm6hv8ZwI3/JqFw6////wH///8B////Af///wH///8BLrqL/xHapf8R2qX/\
Edql/xHapf895bf/KbCC/yCpef8gsH7/Hb6M/yidbNP///8B////Af///wH///8B////ASPNmv8Y\
3ar/Edyn/xHcp/8V3aj/VerA/1DNpP8moHH/JqJz/yG7ifsvv5L/////Af///wH///8B////Af//\
/wEizJn1b+/J/2nux/9k7cX/b+/J/3Dvyf9r7cb/MJ9x/yype/8jt4XzL7+S/////wH///8B////\
Af///wH///8BFL+KOTjWp/9B6Lv/Oea4/zjmuP9G6Lz/WuzD/1rcs/9B0aT7L7+S/////wH///8B\
////Af///wH///8B////Af///wEXwo5lFMWQzxPFkNUTxZDZE8WQ0xXEkNcmxJPVQsie/////wH/\
//8BAAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA\
//8AAP//AAD//w==";

let cIDs = ["custombuttons-contextpopup-exportXML",
            "custombuttons-contextpopup-exportXML-sub"];
let bIDs = ["custombuttons-contextpopup-bookmarkButton",
            "custombuttons-contextpopup-bookmarkButton-sub"];
let kIDs = [this.id + "-checkForUpdate", this.id + "-checkForUpdate-sub"];
let uIDs = ["custombuttons-contextpopup-updateButton",
            "custombuttons-contextpopup-updateButton-sub"];

// Add 'Export to XML' menuitem to CB contextmenu
addMenuItem(cIDs, bIDs, "Export to XML", saveImg,
            "document.getElementById('" + this.id +
            "').saveXML(document.popupNode.URI);");

// Add 'Check for Update...' menuitem to CB contextmenu
addMenuItem(kIDs, uIDs, "Check for Updates for this button", this.image,
            "var btn = document.getElementById('" + this.id + "'); " +
            "btn.updater.checkForUpdate(btn.updater.getUpdate);");

function initCbPopup() {
  $(Button.id + "-checkForUpdate").hidden = (document.popupNode != Button);
}

$(bIDs[0]).parentNode.addEventListener("popupshowing", initCbPopup, false);
$(bIDs[0]).parentNode.removeEventListener("popuphiding", initCbPopup, false);

// Remove contextmenu items when this button is deleted
this.onDestroy = function() {
  $(kIDs[0]).parentNode.removeEventListener("popupshowing",
                                            initCbPopup, false);
  for (var i = 0; i &lt; 2; i++) {
    $(cIDs[i]) &amp;&amp; $(cIDs[i]).parentNode.removeChild($(cIDs[i]));
    $(kIDs[i]) &amp;&amp; $(kIDs[i]).parentNode.removeChild($(kIDs[i]));
  }
}

//---------- Remove old traces if any ----------//
let tbitem = $(this.id + "-toolbaritem");
tbitem &amp;&amp; tbitem.parentNode.removeChild(tbitem);
let css = "\
@namespace url(http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul);\
#navigator-toolbox:not([customizing=\"true\"]) #" + this.id + ",\
#navigator-toolbox[customizing=\"true\"] #" + this.id + "-toolbaritem\
{ display: none; }";
let sss = Cc["@mozilla.org/content/style-sheet-service;1"].
          getService(Ci.nsIStyleSheetService);
let uri = makeURI("data:text/css," + encodeURIComponent(css), null, null);
if (sss.sheetRegistered(uri, sss.USER_SHEET)) {
  sss.unregisterSheet(uri, sss.USER_SHEET);
}

////////////////////////////////////////////////////////////////////////////
////////////////////////////// Button updater //////////////////////////////
////////////////////////////////////////////////////////////////////////////

this.updateURL = "http://loucypher.googlecode.com/svn/custombuttons/xml/" +
                 "Custom%20Buttons%20XML%20Exporter-Importer.xml";

this.onclick = function(aEvent) {
  if (!aEvent.shiftKey) return;
  aEvent.preventDefault();
  this.updater.checkForUpdate(this.updater.getUpdate);
}

var btnClick = this.onclick;
var btnIcon = this.image;
var Button = this;

this.updater = {

  get bsyIcon() {
    return  Application.name == "Firefox"
            ? Application.version &gt;= "4"
              ? "chrome://browser/skin/tabbrowser/connecting.png"
              : "chrome://global/skin/icons/loading_16.png"
            : Application.name == "SeaMonkey"
              ? "chrome://communicator/skin/icons/loading.gif"
              : "chrome://custombuttons/skin/button.png";
  },

  isValidCbURI: function isValidCbURI(aURL) {
    if (!aURL) return false;
    return /^custombutton\:\/\//.test(aURL);
  },

  convertURItoDOM: function convertURItoDOM(aURL) {
    if (!this.isValidCbURI(aURL)) {
      custombuttons.alertBox(Button.name, "Not a Custom Buttons link!");
      return;
    }
    var string = unescape(aURL.replace(/^custombutton\:\/\//, "").toString());
    var parser = new DOMParser();
    var dom = parser.parseFromString(string, "text/xml");
    if (dom.documentElement.nodeName == "parsererror") {
      return null;
    } else {
      return dom.documentElement;
    }
  },

  getParamValue: function getParamValue(aDocument, aNodeName) {
    var node = aDocument.querySelector(aNodeName);
    if (!node) return "";
    if (!node.firstChild || (node.firstChild &amp;&amp;
        (node.firstChild.nodeType == node.TEXT_NODE))) {
      return node.textContent;
    } else {
      return node.firstChild.textContent;
    }
  },

  getButtonParameters: function getButtonParameters(aButtonLink, aURL) {
    var dom = this.convertURItoDOM(aURL);
    var params = custombuttons.cbService.getButtonParameters(aButtonLink)
                                        .wrappedJSObject;
    params.name             = this.getParamValue(dom, "name")
    params.image            = this.getParamValue(dom, "image") ||
                              this.getParamValue(dom, "stdicon");
    params.code             = this.getParamValue(dom, "code")
    params.initCode         = this.getParamValue(dom, "initcode")
    params.help             = this.getParamValue(dom, "help")
    params.accelkey         = this.getParamValue(dom, "accelkey")
    params.mode             = this.getParamValue(dom, "mode")
    params.wrappedJSObject  = params;
    return params;
  },

  resetAttributes: function resetAttributes() {
    Button.image = btnIcon;
    Button.tooltipText = Button.name;
    Button.removeAttribute("busy");
    Button.onclick = btnClick;
  },

  checkForUpdate: function checkForUpdate(aCallback) {
    var url = Button.updateURL + "?" + Date.now();
    var req = new XMLHttpRequest();
    req.open("GET", url, true);
    if (Button.hasAttribute("busy")) {
      this.resetAttributes();
      return
    }
    var updater = this;
    req.onreadystatechange = function (aEvent) {
      Button.onclick = function(aEvent) {
        aEvent.preventDefault();
        req.abort();
        this.updater.resetAttributes();
      }
      Button.image = updater.bsyIcon;
      Button.setAttribute("busy", "");
      Button.tooltipText = "Checking for update...\nClick to abort.";
      if (req.readyState == 4 &amp;&amp; req.status == 200) {
        updater.resetAttributes();
        aCallback(req.responseXML);
      }
    }
    req.send(null);
  },

  getUpdate: function getUpdate(aDocument) {
    if (aDocument.documentElement.localName != "custombutton") {
      alert("Not a valid Custom Buttons XML file!");
      return;
    }
    let button = aDocument.getElementById("button");
    let link = button.getElementsByTagNameNS("http://www.w3.org/1999/xhtml",
                                             "a")[0];
    if (link.href == Button.URI) {
      let as = Cc['@mozilla.org/alerts-service;1'].
               getService(Ci.nsIAlertsService);
      as.showAlertNotification(btnIcon, "No update found!",
                               "Finish checking", false, "", null);
      return;
    } 
    var install = custombuttons.confirmBox(Button.name, "Update found! " +
                                           "Update this button?",
                                           "Yes", "No");
    if (!install) return;
    let btnLink = custombuttons.makeButtonLink("update", Button.id);
    let params = Button.updater.getButtonParameters(btnLink, link.href);
    custombuttons.cbService.installButton(params);
    custombuttons.alertBox(Button.name, "Button updated!");
  }
}

/////////////////////////////////////////////////////////////////////////////

this.label = "Import XML File As New Button";
this.tooltipText = this.Help;

</initcode>
  <code><![CDATA[/*
  Changelog:
    * 2011-06-26:
       1. Fixed all known issues.
       2. No longer using toolbaritems, the cause of all issues.
    * 2011-06-15:
       1. Includes button's image as XML favicon
       2. No longer using <script>
       3. Fixed: namespace bug.
    * 2011-06-14:
       1. Includes template and CSS as you can see if you click the green button above.
          I need your inputs in comment section about the template.
       2. Yep! I changed the name again.
    * 2011-06-12: Added 'Export to XML' to CB contextmenu.
    * 2011-06-11: No more third button (dropmarker).
    * 2011-06-10:
       1. Fixed: toolbaritem (2-button) wasn't removed when this button was deleted.
          Thanks to Morat.
       2. Fixed: toolbaritem (2-button) wasn't removed when this button was moved.
       3. Import XML file that is opened in browser window. Open this XML file to test it.
       4. Supports application/xml content type as well as text/xml.
    * 2011-06-09:
       1. Initial release
       2. Fixed: error with Cyrillic characters
       3. Changed its name from Save/Load to Export/Import.
       4. CB contextmenu now works with the two buttons.
       5. Check for valid CB XML before installing an XML file to a new button.

  Credits:
    Contextmenu Icon by PixelMixer
     - http://pixelmixer.ru/
     - http://pixel-mixer.com/

  References:
  - https://addons.mozilla.org/firefox/files/browse/93414/file/content/loadsaveutils.js
  - https://developer.mozilla.org/en/nsIFilePicker
  - https://developer.mozilla.org/en/Code_snippets:File_I/O
  - https://developer.mozilla.org/en/Parsing_and_serializing_XML
  - https://developer.mozilla.org/en/Using_the_Stylesheet_Service

*/

this.checkDocumentForCBXML(content.document);
]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[
To export:
1. Right click on any custom buttons
2. Select 'Export to XML'


To import:
1. Click this button
2. Select a Custom Buttons XML file

or just open any Custom Buttons XML file to import.



Shift+click: Find update for this button.

]]></help>
  <attributes/>
</custombutton>