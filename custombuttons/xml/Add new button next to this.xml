<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Add new button next to this]]></html:title>
    <html:link rel="shortcut icon" href=""/>
    <html:style type="text/css"><![CDATA[body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
} 
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-image: -moz-linear-gradient(center top, rgb(147, 200, 94) 30%, rgb(85, 168, 2) 55%);
  border: 1px outset rgb(58, 116, 4);
  border-radius: 1em;
  padding: 0;
  text-shadow: 0pt -1px 0pt rgb(58, 116, 4);
  margin-bottom: 1em;
}
#button a {
  color: rgb(255, 255, 255);
  padding: 1em;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3EAdd%20new%20button%20next%20to%20this%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bcustombuttons-stdicon-3%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5Bfunction%20%24%28aId%29%20%7B%0A%20%20return%20document.getElementById%28aId%29%3B%0A%7D%0A%0Avar%20pref%20%3D%20cbu.ps.getBranch%28%22custombuttons.addNewButtonNext.%22%29%3B%0A%0Afunction%20openEditor%28%29%20%7B%0A%20%20try%20%7B%0A%20%20%20%20return%20pref.getBoolPref%28%22openEditor%22%29%3B%0A%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20return%20false%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20confirmInstall%28%29%20%7B%0A%20%20try%20%7B%0A%20%20%20%20return%20pref.getBoolPref%28%22confirmInstall%22%29%3B%0A%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20return%20false%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20isValidCbURI%28aURL%29%20%7B%0A%20%20if%20%28%21aURL%29%20return%20false%3B%0A%20%20return%20/%5Ecustombutton%5C%3A%5C/%5C//.test%28aURL%29%3B%0A%7D%0A%0Afunction%20isInitialized%28aButton%29%20%7B%0A%20%20return%20aButton.hasAttribute%28%27initialized%27%29%3B%0A%7D%0A%0Afunction%20makeURI%28aURL%2C%20aOriginCharset%2C%20aBaseURI%29%20%7B%0A%20%20var%20ioService%20%3D%20Cc%5B%27@mozilla.org/network/io-service%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIIOService%29%3B%0A%20%20return%20ioService.newURI%28aURL%2C%20aOriginCharset%2C%20aBaseURI%29%3B%0A%7D%0A%0Afunction%20convertURItoDOM%28aURL%29%20%7B%0A%20%20if%20%28%21isValidCbURI%28aURL%29%29%20%7B%0A%20%20%20%20custombuttons.alertBox%28this.name%2C%20%22Not%20a%20Custom%20Buttons%20link%21%22%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20var%20string%20%3D%20unescape%28aURL.replace%28/%5Ecustombutton%5C%3A%5C/%5C//%2C%20%22%22%29.toString%28%29%29%3B%0A%20%20var%20parser%20%3D%20new%20DOMParser%28%29%3B%0A%20%20var%20dom%20%3D%20parser.parseFromString%28string%2C%20%22text/xml%22%29%3B%0A%20%20if%20%28dom.documentElement.nodeName%20%3D%3D%20%22parsererror%22%29%20%7B%0A%20%20%20%20return%20null%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20return%20dom.documentElement%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20getParamValue%28aDocument%2C%20aNodeName%29%20%7B%0A%20%20var%20result%20%3D%20%22%22%3B%0A%20%20%20%20var%20node%20%3D%20aDocument.getElementsByTagName%28aNodeName%29%5B0%5D%3B%0A%20%20%20%20if%20%28%21node%29%20return%20result%3B%0A%20%20%20%20if%20%28%21node.firstChild%20%7C%7C%20%28node.firstChild%20%26%26%0A%20%20%20%20%20%20%20%20%28node.firstChild.nodeType%20%3D%3D%20node.TEXT_NODE%29%29%29%20%7B%0A%20%20%20%20%20%20result%20%3D%20node.%20textContent%3B%0A%20%20%20%20%7D%20else%20%7B%20%20//%20CDATA%0A%20%20%20%20%20%20result%20%3D%20node.firstChild.textContent%3B%0A%20%20%20%20%7D%0A%20%20return%20result%3B%0A%7D%0A%0Afunction%20getButtonParameters%28aButtonLink%2C%20aURL%29%20%7B%0A%20%20var%20dom%20%3D%20convertURItoDOM%28aURL%29%3B%0A%20%20var%20params%20%3D%20custombuttons.cbService.getButtonParameters%28aButtonLink%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.wrappedJSObject%3B%0A%20%20params.name%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22name%22%29%0A%20%20params.image%20%20%20%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22image%22%29%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getParamValue%28dom%2C%20%22stdicon%22%29%3B%0A%20%20params.code%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22code%22%29%0A%20%20params.initCode%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22initcode%22%29%0A%20%20params.help%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22help%22%29%0A%20%20params.accelkey%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22accelkey%22%29%0A%20%20params.mode%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20getParamValue%28dom%2C%20%22mode%22%29%0A%20%20params.wrappedJSObject%20%20%3D%20params%3B%0A%20%20return%20params%3B%0A%7D%0A%0Afunction%20makeButtonFromURI%28aButton%2C%20aURL%29%20%7B%0A%20%20if%20%28%21isValidCbURI%28aURL%29%29%20%7B%0A%20%20%20%20custombuttons.alertBox%28Button.name%2C%20%22Not%20a%20Custom%20Buttons%20link%21%22%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20if%20%28confirmInstall%28%29%29%20%7B%20//%20still%20has%20a%20bug%2C%20just%20turn%20it%20off%0A%20%20%20%20custombuttons.cloneButton%28aButton%2C%20true%29%3B%0A%20%20%20%20window.setTimeout%28function%28%29%20%7B%0A%20%20%20%20%20%20custombuttons.cbService.updateButton%28aButton.nextSibling%2C%20aURL%29%3B%0A%20%20%20%20%7D%29%0A%20%20%7D%20else%20%7B%0A%20%20%20%20custombuttons.cloneButton%28aButton%29%3B%0A%20%20%20%20var%20newButton%20%3D%20custombuttons.makeButtonLink%28%22update%22%2C%20aButton.nextSibling.id%29%3B%0A%20%20%20%20var%20params%20%3D%20getButtonParameters%28newButton%2C%20aURL%29%3B%0A%20%20%20%20custombuttons.cbService.installButton%28params%29%3B%0A%20%20%20%20//inspectObject%28params%29%3B%0A%20%20%7D%0A%7D%0A%0A%0Athis.createNextButton%20%3D%20function%28aButton%29%20%7B%0A%20%20custombuttons.cloneButton%28aButton%2C%20true%29%3B%0A%20%20window.setTimeout%28function%28%29%20%7B%0A%20%20%20%20if%20%28%21isInitialized%28aButton.nextSibling%29%29%20%7B%0A%20%20%20%20%20%20aButton.nextSibling%0A%20%20%20%20%20%20%20%20%20%20%20%20%20.setAttribute%28%22oncommand%22%2C%20%22custombuttons.editButton%28this%29%3B%22%29%3B%0A%20%20%20%20%20%20if%20%28openEditor%28%29%29%20%7B%0A%20%20%20%20%20%20%20%20custombuttons.editButton%28aButton.nextSibling%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%29%0A%7D%0A%0Avar%20newIDs%20%3D%20%5B%22custombuttons-contextpopup-addNextButton%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22custombuttons-contextpopup-addNextButton-sub%22%5D%3B%0A%0Avar%20beforeIDs%20%3D%20%5B%22custombuttons-contextpopup-addnewbutton%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22custombuttons-contextpopup-addnewbutton-sub%22%5D%3B%0A%0Afor%20%28var%20i%20%3D%200%3B%20i%20%3C%20newIDs.length%3B%20i++%29%20%7B%0A%20%20if%20%28%24%28newIDs%5Bi%5D%29%29%20%7B%0A%20%20%20%20%24%28newIDs%5Bi%5D%29.parentNode.removeChild%28%24%28newIDs%5Bi%5D%29%29%3B%0A%20%20%7D%0A%0A%20%20let%20item%20%3D%0A%20%20%20%20%20%20cbu.makeXML%28%3Cmenuitem%20xmlns%3D%22http%3A//www.mozilla.org/keymaster/gatekeeper/there.is.only.xul%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id%3D%7BnewIDs%5Bi%5D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20class%3D%22menuitem-iconic%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22Add%20new%20button%20next%20to%20this%20button%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%7B%22document.getElementById%28%27%22%20+%20this.id%20+%20%22%27%29.createNextButton%28document.popupNode%29%3B%22%7D/%3E%29%3B%0A%0A%20%20if%20%28i%20%3D%3D%200%29%20item.setAttribute%28%22observes%22%2C%20%22custombuttons-contextbroadcaster-primary%22%29%3B%0A%0A%20%20let%20sibling%20%3D%20%24%28beforeIDs%5Bi%5D%29%3B%0A%20%20sibling.parentNode.insertBefore%28item%2C%20sibling.nextSibling%29%3B%0A%0A%7D%0A%0Avar%20Button%20%3D%20this%3B%0A%0Athis.dndObserver%20%3D%20%7B%0A%0A%20%20onDrop%3A%20function%28aEvent%2C%20aXferData%2C%20aDragSession%29%20%7B%0A%20%20%20%20var%20split%20%3D%20aXferData.data.split%28%22%5Cn%22%29%3B%0A%20%20%20%20var%20url%20%3D%20split%5B0%5D%3B%0A%20%20%20%20if%20%28url%20%21%3D%20aXferData.data%29%20%7B%0A%20%20%20%20%20%20var%20dialogArgs%20%3D%20%7Bname%3Asplit%5B1%5D%2C%20url%3Aurl%7D%3B%0A%20%20%20%20%20%20//Application.console.log%28this%29%3B%0A%20%20%20%20%20%20makeButtonFromURI%28aEvent.target%2C%20dialogArgs.url%29%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20split%20%3D%20aXferData.data.split%28%22%20%22%29%3B%0A%20%20%20%20%20%20url%20%3D%20split%5B0%5D%3B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20makeButtonFromURI%28aEvent.target%2C%20makeURI%28url%29.spec%29%3B%0A%20%20%20%20%20%20%7D%20catch%28ex%29%20%7B%0A%20%20%20%20%20%20%20%20custombuttons.alertBox%28Button.name%2C%20%22Not%20a%20Custom%20Buttons%20link%21%22%29%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%0A%20%20onDragOver%3A%20function%28aEvent%2C%20aFlavour%2C%20aDragSession%29%20%7B%0A%20%20%20%20%24%28%22statusbar-display%22%29.label%20%3D%20%22Drop%20the%20link%20there%21%22%3B%0A%20%20%20%20aDragSession.dragAction%20%3D%20Ci.nsIDragService.DRAGDROP_ACTION_LINK%3B%0A%20%20%7D%2C%0A%0A%20%20onDragExit%3A%20function%28aEvent%2C%20aDragSession%29%20%7B%0A%20%20%20%20%24%28%22statusbar-display%22%29.label%20%3D%20%22%22%3B%0A%20%20%7D%2C%0A%0A%20%20getSupportedFlavours%3A%20function%28%29%20%7B%0A%20%20%20%20var%20flavourSet%20%3D%20new%20FlavourSet%3B%0A%20%20%20%20flavourSet.appendFlavour%28%22text/x-moz-url%22%29%3B%0A%20%20%20%20flavourSet.appendFlavour%28%22text/unicode%22%29%3B%0A%20%20%20%20return%20flavourSet%3B%0A%20%20%7D%0A%7D%0A%0Athis.setAttribute%28%22ondragover%22%2C%20%22nsDragAndDrop.dragOver%28event%2C%20this.dndObserver%29%3B%22%29%3B%0Athis.setAttribute%28%22ondragdrop%22%2C%20%22nsDragAndDrop.drop%28event%2C%20this.dndObserver%29%3B%22%29%3B%0Athis.setAttribute%28%22ondragexit%22%2C%20%22nsDragAndDrop.dragExit%28event%2C%20this.dndObserver%29%3B%22%29%3B%0A%0A%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5Bvar%20ww%20%3D%20Components.classes%5B%22@mozilla.org/embedcomp/window-watcher%3B1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.getService%28Components.interfaces.nsIWindowWatcher%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0Avar%20em%20%3D%20ww.getWindowEnumerator%28%29%3B%0A%0Avar%20winName%20%3D%20%22CB_addNewButtonNext%22%3B%0A%0Avar%20index%20%3D%201%3B%0Awhile%20%28em.hasMoreElements%28%29%29%20%7B%0A%20%20let%20win%20%3D%20em.getNext%28%29%3B%0A%20%20if%28win.name%20%3D%3D%20winName%29%20%7B%0A%20%20%20%20win.focus%28%29%3B%0A%20%20%20%20return%3B%0A%20%20%7D%0A%20%20index++%0A%7D%0A%0Avar%20xul%20%3D%20%22data%3Aapplication/vnd.mozilla.xul+xml%3Bbase64%2C%22%20+%0A%20%20%20%20%20%20%20%20%20%20encodeURIComponent%28btoa%28this.Help%29%29%3B%0A%0AopenDialog%28xul%2C%20winName%2C%20%22chrome%2C%20dialog%2C%20centerscreen%2C%20close%22%29%3B%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5B%3C%3Fxml%20version%3D%221.0%22%3F%3E%0A%3C%3Fxml-stylesheet%20href%3D%22chrome%3A//global/skin/%22%3F%3E%0A%0A%3Cprefwindow%0A%20%20xmlns%3D%22http%3A//www.mozilla.org/keymaster/gatekeeper/there.is.only.xul%22%0A%20%20id%3D%22custombuttonsEditor%22%0A%20%20title%3D%22Add%20new%20button%20next%20to%20this%22%3E%0A%0A%20%20%3Cprefpane%0A%20%20%20%20id%3D%22prefpane-menu%22%0A%20%20%20%20label%3D%22Prefpane%20menu%22%0A%20%20%20%20accesskey%3D%22P%22%3E%0A%0A%20%20%20%20%3Cpreferences%3E%0A%20%20%20%20%20%20%3Cpreference%0A%20%20%20%20%20%20%20%20id%3D%22custombuttons.addNewButtonNext.openEditor%22%0A%20%20%20%20%20%20%20%20name%3D%22custombuttons.addNewButtonNext.openEditor%22%0A%20%20%20%20%20%20%20%20type%3D%22bool%22%20/%3E%0A%20%20%20%20%20%20%3C%21--%20It%27s%20still%20has%20a%20bug.%20Don%27t%20use%20it.%20%0A%20%20%20%20%20%20%3Cpreference%0A%20%20%20%20%20%20%20%20id%3D%22custombuttons.addNewButtonNext.confirmInstall%22%0A%20%20%20%20%20%20%20%20name%3D%22custombuttons.addNewButtonNext.confirmInstall%22%0A%20%20%20%20%20%20%20%20type%3D%22bool%22%20/%3E%0A%20%20%20%20%20%20--%3E%0A%20%20%20%20%3C/preferences%3E%0A%0A%20%20%20%20%3Cgroupbox%3E%0A%20%20%20%20%20%20%3Ccaption%20label%3D%22Options%22/%3E%0A%20%20%20%20%20%20%3Ccheckbox%0A%20%20%20%20%20%20%20%20id%3D%22custombuttons.addNewButtonNext.openEditor-checkbox%22%0A%20%20%20%20%20%20%20%20label%3D%22Automatically%20edit%20the%20new%20button%22%0A%20%20%20%20%20%20%20%20accesskey%3D%22A%22%0A%20%20%20%20%20%20%20%20preference%3D%22custombuttons.addNewButtonNext.openEditor%22%20/%3E%0A%0A%20%20%20%20%20%20%3C%21--%20It%27s%20still%20has%20a%20bug.%20Don%27t%20use%20it.%20%0A%20%20%20%20%20%20%3Ccheckbox%0A%20%20%20%20%20%20%20%20id%3D%22custombuttons.addNewButtonNext.confirmInstall-checkbox%22%0A%20%20%20%20%20%20%20%20label%3D%22Confirm%20before%20install%20new%20button%20from%20drag-and-drop%22%0A%20%20%20%20%20%20%20%20accesskey%3D%22C%22%0A%20%20%20%20%20%20%20%20preference%3D%22custombuttons.addNewButtonNext.confirmInstall%22%20/%3E%0A%20%20%20%20%20%20--%3E%0A%0A%20%20%20%3C/groupbox%3E%0A%0A%20%20%3C/prefpane%3E%0A%0A%3C/prefwindow%3E%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Add new button next to this">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.mozdev.org/drupal/node/484">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>

  <name>Add new button next to this</name>
  <image><![CDATA[custombuttons-stdicon-3]]></image>
  <mode>0</mode>
  <initcode><![CDATA[function $(aId) {
  return document.getElementById(aId);
}

var pref = cbu.ps.getBranch("custombuttons.addNewButtonNext.");

function openEditor() {
  try {
    return pref.getBoolPref("openEditor");
  } catch(ex) {
    return false;
  }
}

function confirmInstall() {
  try {
    return pref.getBoolPref("confirmInstall");
  } catch(ex) {
    return false;
  }
}

function isValidCbURI(aURL) {
  if (!aURL) return false;
  return /^custombutton\:\/\//.test(aURL);
}

function isInitialized(aButton) {
  return aButton.hasAttribute('initialized');
}

function makeURI(aURL, aOriginCharset, aBaseURI) {
  var ioService = Cc['@mozilla.org/network/io-service;1'].
                  getService(Ci.nsIIOService);
  return ioService.newURI(aURL, aOriginCharset, aBaseURI);
}

function convertURItoDOM(aURL) {
  if (!isValidCbURI(aURL)) {
    custombuttons.alertBox(this.name, "Not a Custom Buttons link!");
    return;
  }
  var string = unescape(aURL.replace(/^custombutton\:\/\//, "").toString());
  var parser = new DOMParser();
  var dom = parser.parseFromString(string, "text/xml");
  if (dom.documentElement.nodeName == "parsererror") {
    return null;
  } else {
    return dom.documentElement;
  }
}

function getParamValue(aDocument, aNodeName) {
  var result = "";
    var node = aDocument.getElementsByTagName(aNodeName)[0];
    if (!node) return result;
    if (!node.firstChild || (node.firstChild &&
        (node.firstChild.nodeType == node.TEXT_NODE))) {
      result = node. textContent;
    } else {  // CDATA
      result = node.firstChild.textContent;
    }
  return result;
}

function getButtonParameters(aButtonLink, aURL) {
  var dom = convertURItoDOM(aURL);
  var params = custombuttons.cbService.getButtonParameters(aButtonLink)
                                      .wrappedJSObject;
  params.name             = getParamValue(dom, "name")
  params.image            = getParamValue(dom, "image") ||
                            getParamValue(dom, "stdicon");
  params.code             = getParamValue(dom, "code")
  params.initCode         = getParamValue(dom, "initcode")
  params.help             = getParamValue(dom, "help")
  params.accelkey         = getParamValue(dom, "accelkey")
  params.mode             = getParamValue(dom, "mode")
  params.wrappedJSObject  = params;
  return params;
}

function makeButtonFromURI(aButton, aURL) {
  if (!isValidCbURI(aURL)) {
    custombuttons.alertBox(Button.name, "Not a Custom Buttons link!");
    return;
  }
  if (confirmInstall()) { // still has a bug, just turn it off
    custombuttons.cloneButton(aButton, true);
    window.setTimeout(function() {
      custombuttons.cbService.updateButton(aButton.nextSibling, aURL);
    })
  } else {
    custombuttons.cloneButton(aButton);
    var newButton = custombuttons.makeButtonLink("update", aButton.nextSibling.id);
    var params = getButtonParameters(newButton, aURL);
    custombuttons.cbService.installButton(params);
    //inspectObject(params);
  }
}


this.createNextButton = function(aButton) {
  custombuttons.cloneButton(aButton, true);
  window.setTimeout(function() {
    if (!isInitialized(aButton.nextSibling)) {
      aButton.nextSibling
             .setAttribute("oncommand", "custombuttons.editButton(this);");
      if (openEditor()) {
        custombuttons.editButton(aButton.nextSibling);
      }
    }
  })
}

var newIDs = ["custombuttons-contextpopup-addNextButton",
              "custombuttons-contextpopup-addNextButton-sub"];

var beforeIDs = ["custombuttons-contextpopup-addnewbutton",
                 "custombuttons-contextpopup-addnewbutton-sub"];

for (var i = 0; i < newIDs.length; i++) {
  if ($(newIDs[i])) {
    $(newIDs[i]).parentNode.removeChild($(newIDs[i]));
  }

  let item =
      cbu.makeXML(<menuitem xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
                            id={newIDs[i]}
                            class="menuitem-iconic"
                            label="Add new button next to this button"
                            oncommand={"document.getElementById('" + this.id + "').createNextButton(document.popupNode);"}/>);

  if (i == 0) item.setAttribute("observes", "custombuttons-contextbroadcaster-primary");

  let sibling = $(beforeIDs[i]);
  sibling.parentNode.insertBefore(item, sibling.nextSibling);

}

var Button = this;

this.dndObserver = {

  onDrop: function(aEvent, aXferData, aDragSession) {
    var split = aXferData.data.split("\n");
    var url = split[0];
    if (url != aXferData.data) {
      var dialogArgs = {name:split[1], url:url};
      //Application.console.log(this);
      makeButtonFromURI(aEvent.target, dialogArgs.url);
    } else {
      split = aXferData.data.split(" ");
      url = split[0];
      try {
        makeButtonFromURI(aEvent.target, makeURI(url).spec);
      } catch(ex) {
        custombuttons.alertBox(Button.name, "Not a Custom Buttons link!");
      }
    }
  },

  onDragOver: function(aEvent, aFlavour, aDragSession) {
    $("statusbar-display").label = "Drop the link there!";
    aDragSession.dragAction = Ci.nsIDragService.DRAGDROP_ACTION_LINK;
  },

  onDragExit: function(aEvent, aDragSession) {
    $("statusbar-display").label = "";
  },

  getSupportedFlavours: function() {
    var flavourSet = new FlavourSet;
    flavourSet.appendFlavour("text/x-moz-url");
    flavourSet.appendFlavour("text/unicode");
    return flavourSet;
  }
}

this.setAttribute("ondragover", "nsDragAndDrop.dragOver(event, this.dndObserver);");
this.setAttribute("ondragdrop", "nsDragAndDrop.drop(event, this.dndObserver);");
this.setAttribute("ondragexit", "nsDragAndDrop.dragExit(event, this.dndObserver);");

]]></initcode>
  <code><![CDATA[var ww = Components.classes["@mozilla.org/embedcomp/window-watcher;1"]
                   .getService(Components.interfaces.nsIWindowWatcher);
                   
var em = ww.getWindowEnumerator();

var winName = "CB_addNewButtonNext";

var index = 1;
while (em.hasMoreElements()) {
  let win = em.getNext();
  if(win.name == winName) {
    win.focus();
    return;
  }
  index++
}

var xul = "data:application/vnd.mozilla.xul+xml;base64," +
          encodeURIComponent(btoa(this.Help));

openDialog(xul, winName, "chrome, dialog, centerscreen, close");]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[<?xml version="1.0"?>
<?xml-stylesheet href="chrome://global/skin/"?>

<prefwindow
  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
  id="custombuttonsEditor"
  title="Add new button next to this">

  <prefpane
    id="prefpane-menu"
    label="Prefpane menu"
    accesskey="P">

    <preferences>
      <preference
        id="custombuttons.addNewButtonNext.openEditor"
        name="custombuttons.addNewButtonNext.openEditor"
        type="bool" />
      <!-- It's still has a bug. Don't use it. 
      <preference
        id="custombuttons.addNewButtonNext.confirmInstall"
        name="custombuttons.addNewButtonNext.confirmInstall"
        type="bool" />
      -->
    </preferences>

    <groupbox>
      <caption label="Options"/>
      <checkbox
        id="custombuttons.addNewButtonNext.openEditor-checkbox"
        label="Automatically edit the new button"
        accesskey="A"
        preference="custombuttons.addNewButtonNext.openEditor" />

      <!-- It's still has a bug. Don't use it. 
      <checkbox
        id="custombuttons.addNewButtonNext.confirmInstall-checkbox"
        label="Confirm before install new button from drag-and-drop"
        accesskey="C"
        preference="custombuttons.addNewButtonNext.confirmInstall" />
      -->

   </groupbox>

  </prefpane>

</prefwindow>]]></help>
  <attributes/>
</custombutton>