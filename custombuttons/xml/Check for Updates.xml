<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title><![CDATA[Check for Updates]]></html:title>
    <html:link rel="shortcut icon" href="chrome://branding/content/icon16.png"/>
    <html:style type="text/css"><![CDATA[body { font-size: medium; margin: 0; }
body, code:before, help:before, initcode:before {
  font-family: "Verdana", sans-serif;
}
#wrapper { position: fixed; top: 1em; right: 1em; text-align: center; }
p { font-size: small; text-align: center; }
#button {
  background-image: -moz-linear-gradient(center top, rgb(147, 200, 94) 30%, rgb(85, 168, 2) 55%);
  border: 1px outset rgb(58, 116, 4);
  border-radius: 1em;
  -moz-border-radius: 1em;
  padding: 0;
  text-shadow: 0pt -1px 0pt rgb(58, 116, 4);
  margin-bottom: 1em;
}
#button a {
  color: rgb(255, 255, 255);
  padding: 1em;
  text-decoration: none;
}
#button a, code, code:before, initcode, initcode:before, help, help:before {
  display: block;
}
#credits { position: fixed; bottom: 1em; right: 1em; font-size: small; }
custombutton { background-color: rgb(171, 171, 171); margin: 1em; }
image, mode, accelkey { display: none; }
name { font-weight: bold; font-size: x-large; }
code:before, help:before, initcode:before {
  font-weight: bold;
  font-size: large;
  margin: 0 0 1em;
  padding: .5em;
}
code:before { content: "CODE"; }
help:before { content: "Help"; }
initcode:before { content: "Initialization Code"; }
code, initcode, help {
  background-color: rgb(255, 255, 255);
  border: 1px inset rgb(170, 170, 170);
  font: medium monospace;
  margin: 1em 1em 2em 0;
  padding: 1em;
  text-align: left;
  width: 840px;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.clear { clear: both; }
]]></html:style>
  </html:head>
  <html:body>
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3ECheck%20for%20Updates%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bchrome%3A//branding/content/icon16.png%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E0%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5Bfunction%20openURL%28aURL%29%20%7B%0A%20%20if%20%28Application.id%20%3D%3D%20%22%7B3550f703-e582-4d05-9a08-453d09bdfdc6%7D%22%29%20%7B%0A%20%20%20%20//%20Thunderbird%0A%20%20%20%20openContentTab%28aURL%29%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20gBrowser.loadOneTab%28aURL%2C%20null%2C%20null%2C%20null%29%3B%0A%20%20%7D%0A%7D%0A%0Athis.checkForUpdate%20%3D%20function%20checkForUpdate%28%29%20%7B%0A%20%20var%20um%20%3D%20Cc%5B%27@mozilla.org/updates/update-manager%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIUpdateManager%29%3B%0A%20%20var%20prompter%20%3D%20Cc%5B%27@mozilla.org/updates/update-prompt%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20createInstance%28Ci.nsIUpdatePrompt%29%3B%0A%20%20if%20%28um.activeUpdate%20%26%26%20um.activeUpdate.state%20%3D%3D%20%22pending%22%29%20%7B%0A%20%20%20%20prompter.showUpdateDownloaded%28um.activeUpdate%29%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20prompter.checkForUpdates%28%29%3B%0A%20%20%7D%0A%7D%0A%0Athis.openReleaseNotes%20%3D%20function%20openReleaseNotes%28%29%20%7B%0A%20%20var%20formatter%20%3D%20Cc%5B%27@mozilla.org/toolkit/URLFormatterService%3B1%27%5D.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20getService%28Ci.nsIURLFormatter%29%3B%0A%20%20var%20relnotesURL%20%3D%20formatter.formatURLPref%28%22app.releaseNotesURL%22%29%3B%0A%20%20openURL%28relnotesURL%29%3B%0A%7D%0A%0Athis.openChangeset%20%3D%20function%20openChangeset%28%29%20%7B%0A%20%20var%20url%20%3D%20%22about%3Abuildconfig%22%3B%0A%20%20var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%20%20req.open%28%22GET%22%2C%20url%2C%20false%29%3B%0A%20%20req.send%28null%29%3B%0A%20%20var%20changeset%20%3D%20req.responseText.match%28/http%3A%5C/%5C/hg.mozilla.org%5C/%5B%5E%5C%22%5D*/%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.toString%28%29%3B%0A%20%20openURL%28changeset%29%3B%0A%7D%0A%0Avar%20menu%20%3D%20%3Cmenupopup%20xmlns%3D%7Bxulns%7D%20oncommand%3D%22event.stopPropagation%28%29%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cmenuitem%20label%3D%22Release%20Notes%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%22this.parentNode%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.parentNode.openReleaseNotes%28%29%3B%22/%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cmenuitem%20label%3D%22Changeset%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%22this.parentNode%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.parentNode.openChangeset%28%29%3B%22/%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cmenuseparator%20id%3D%7Bthis.id%20+%20%22-separator%22%7D/%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cmenuitem%20label%3D%7B%22About%20%22%20+%20Application.name%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%22openAboutDialog%28%29%3B%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20class%3D%22menuitem-iconic%22%20image%3D%7Bthis.image%7D/%3E%0A%20%20%20%20%20%20%20%20%20%20%20%3C/menupopup%3E%3B%0A%0Athis.appendChild%28cbu.makeXML%28menu%29%29%3B%0Athis.type%20%3D%20%22menu-button%22%3B%0A%0Aif%20%28Application.id%20%3D%3D%20%22%7B92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a%7D%22%29%20%7B%0A%20%20//%20SeaMonkey%0A%20%20this.image%20%3D%20%22chrome%3A//communicator/skin/brand/throbber16-single.png%22%3B%0A%20%20return%3B%20//%20SeaMonkey%20doesn%27t%20need%20the%20following%20lines%0A%7D%0A%0Afunction%20%24%28aId%29%20%7B%0A%20%20return%20document.getElementById%28aId%29%3B%0A%7D%0A%0Afunction%20insertMenuItem%28aParent%2C%20aSibling%2C%20aXUL%29%20%7B%0A%20%20aParent.insertBefore%28cbu.makeXML%28aXUL%29%2C%20aSibling%29%3B%0A%7D%0A%0Avar%20abtMenus%20%3D%20%5B%22aboutName%22%2C%20%22appmenu_about%22%5D%3B%0Avar%20updMenus%20%3D%20%5B%22helpmenu_checkForUpdate%22%2C%20%22appmenu_checkForUpdate%22%5D%3B%0Avar%20rlsMenus%20%3D%20%5B%22helpMenu_releaseNotes%22%2C%20%22appmenu_releaseNotes%22%5D%3B%0A%0Afor%20%28var%20i%20%3D%200%3B%20i%20%3C%20updMenus.length%3B%20i++%29%20%7B%0A%20%20%24%28updMenus%5Bi%5D%29%20%26%26%20%24%28updMenus%5Bi%5D%29.parentNode.removeChild%28%24%28updMenus%5Bi%5D%29%29%3B%0A%20%20%24%28rlsMenus%5Bi%5D%29%20%26%26%20%24%28rlsMenus%5Bi%5D%29.parentNode.removeChild%28%24%28rlsMenus%5Bi%5D%29%29%3B%0A%0A%20%20insertMenuItem%28%24%28abtMenus%5Bi%5D%29.parentNode%2C%20%24%28abtMenus%5Bi%5D%29%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cmenuitem%20xmlns%3D%7Bxulns%7D%20id%3D%7BrlsMenus%5Bi%5D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22Release%20Notes%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%7B%22document.getElementById%28%27%22%20+%20this.id%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%27%29.openReleaseNotes%28%29%3B%22%7D/%3E%29%0A%0A%20%20insertMenuItem%28%24%28abtMenus%5Bi%5D%29.parentNode%2C%20%24%28abtMenus%5Bi%5D%29%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cmenuitem%20xmlns%3D%7Bxulns%7D%20id%3D%7BupdMenus%5Bi%5D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22Check%20for%20Updates...%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20oncommand%3D%7B%22document.getElementById%28%27%22%20+%20this.id%20+%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%27%29.checkForUpdate%28%29%3B%22%7D/%3E%29%0A%7D%0A%0A%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5Bthis.checkForUpdate%28%29%3B%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Check for Updates">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.sourceforge.net/forum/viewtopic.php?t=78#p197">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>

  <name>Check for Updates</name>
  <image><![CDATA[chrome://branding/content/icon16.png]]></image>
  <mode>0</mode>
  <initcode><![CDATA[function openURL(aURL) {
  if (Application.id == "{3550f703-e582-4d05-9a08-453d09bdfdc6}") {
    // Thunderbird
    openContentTab(aURL);
  } else {
    gBrowser.loadOneTab(aURL, null, null, null);
  }
}

this.checkForUpdate = function checkForUpdate() {
  var um = Cc['@mozilla.org/updates/update-manager;1'].
           getService(Ci.nsIUpdateManager);
  var prompter = Cc['@mozilla.org/updates/update-prompt;1'].
                 createInstance(Ci.nsIUpdatePrompt);
  if (um.activeUpdate && um.activeUpdate.state == "pending") {
    prompter.showUpdateDownloaded(um.activeUpdate);
  } else {
    prompter.checkForUpdates();
  }
}

this.openReleaseNotes = function openReleaseNotes() {
  var formatter = Cc['@mozilla.org/toolkit/URLFormatterService;1'].
                  getService(Ci.nsIURLFormatter);
  var relnotesURL = formatter.formatURLPref("app.releaseNotesURL");
  openURL(relnotesURL);
}

this.openChangeset = function openChangeset() {
  var url = "about:buildconfig";
  var req = new XMLHttpRequest();
  req.open("GET", url, false);
  req.send(null);
  var changeset = req.responseText.match(/http:\/\/hg.mozilla.org\/[^\"]*/)
                                  .toString();
  openURL(changeset);
}

var menu = <menupopup xmlns={xulns} oncommand="event.stopPropagation();">
             <menuitem label="Release Notes"
                       oncommand="this.parentNode
                                      .parentNode.openReleaseNotes();"/>
             <menuitem label="Changeset"
                       oncommand="this.parentNode
                                      .parentNode.openChangeset();"/>
             <menuseparator id={this.id + "-separator"}/>
             <menuitem label={"About " + Application.name}
                       oncommand="openAboutDialog();"
                       class="menuitem-iconic" image={this.image}/>
           </menupopup>;

this.appendChild(cbu.makeXML(menu));
this.type = "menu-button";

if (Application.id == "{92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a}") {
  // SeaMonkey
  this.image = "chrome://communicator/skin/brand/throbber16-single.png";
  return; // SeaMonkey doesn't need the following lines
}

function $(aId) {
  return document.getElementById(aId);
}

function insertMenuItem(aParent, aSibling, aXUL) {
  aParent.insertBefore(cbu.makeXML(aXUL), aSibling);
}

var abtMenus = ["aboutName", "appmenu_about"];
var updMenus = ["helpmenu_checkForUpdate", "appmenu_checkForUpdate"];
var rlsMenus = ["helpMenu_releaseNotes", "appmenu_releaseNotes"];

for (var i = 0; i < updMenus.length; i++) {
  $(updMenus[i]) && $(updMenus[i]).parentNode.removeChild($(updMenus[i]));
  $(rlsMenus[i]) && $(rlsMenus[i]).parentNode.removeChild($(rlsMenus[i]));

  insertMenuItem($(abtMenus[i]).parentNode, $(abtMenus[i]),
                 <menuitem xmlns={xulns} id={rlsMenus[i]}
                           label="Release Notes"
                           oncommand={"document.getElementById('" + this.id +
                                      "').openReleaseNotes();"}/>)

  insertMenuItem($(abtMenus[i]).parentNode, $(abtMenus[i]),
                 <menuitem xmlns={xulns} id={updMenus[i]}
                           label="Check for Updates..."
                           oncommand={"document.getElementById('" + this.id +
                                      "').checkForUpdate();"}/>)
}

]]></initcode>
  <code><![CDATA[this.checkForUpdate();
]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[]]></help>
  <attributes/>
</custombutton>