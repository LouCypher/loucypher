<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons"
              xmlns:html="http://www.w3.org/1999/xhtml">
  <html:head>
    <html:title></html:title>
    <html:link rel="shortcut icon" href=""/>
    <html:style type="text/css"><![CDATA[body{font-family:"Verdana";font-size:medium;margin:0;}#wrapper{position:fixed;top:1em;right:1em;text-align:center;}p{font-size:small;text-align:center;}#button{background-image:-moz-linear-gradient(center top,rgb(147,200,94)30%,rgb(85,168,2)55%);border:1px outset rgb(58,116,4);border-radius:1em;padding:0;text-shadow:0pt -1px 0pt rgb(58,116,4);margin-bottom:1em;}#button a{color:#ffffff;display:block;padding:1em;text-decoration:none;}#credits{position:fixed;bottom:1em;right:1em;font-size:small;}custombutton{background-color:AppWorkspace;margin:1em;}image,mode,accelkey{display:none;}name{font-weight:bold;font-size:x-large;}code:before{content:"/*CODE*/";}help:before{content:"/*Help*/";}initcode:before{content:"/*Initialization Code*/";}code,initcode,help{background-color:#f8f8f8;border:1px inset #dddddd;font:medium monospace;margin:1em 1em 2em 0;padding:1em;text-align:left;width:840px;white-space:pre-wrap;word-wrap:break-word;max-height:500px;overflow-y:auto;}code:hover,initcode:hover,help:hover{background-color:#fcfcfc;}code:active,initcode:active,help:active{background-color:#ffffff;}code,code:before,initcode,initcode:before,help,help:before{display:block;white-space:pre-wrap;}.clear{clear:both;}]]></html:style>
    <html:script type="text/javascript"><![CDATA[function cb(el){var serializer=new XMLSerializer();var xml=serializer.serializeToString(document);location.href="custombutton://"+escape(xml)}function tit(el,str){el.setAttribute("title",str)}function onLoad(){document.title=document.documentElement.getElementsByTagName("name")[0].textContent;document.getElementsByTagName("html:link")[0].href=document.documentElement.getElementsByTagName("image")[0].textContent}]]></html:script>
  </html:head>
  <html:body onload="onLoad();">
    <html:div id="wrapper">
      <html:div id="button">
        <html:a href=""
                onmouseover="tit(this, document.title);"
                onmouseout="tit(this, '');"
                onclick="event.preventDefault(); cb(this);">
        <![CDATA[Install this button]]>
        </html:a>
      </html:div>
      <html:a href="https://addons.mozilla.org/addon/custom-buttons/">
        <![CDATA[What's this?]]>
      </html:a>
      <html:div id="credits">
        <html:a href="http://custombuttons.mozdev.org/drupal/node/484">
          <![CDATA[Custom Buttons XML]]><html:br/><![CDATA[Exporter/Importer]]>
        </html:a>
      </html:div>
    </html:div>
  </html:body>

  <name>Extensions Options Menu</name>
  <image><![CDATA[data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACV0lEQVR4Xi3OT2ibZQDH8c/7msT1pZqOtlQ32ulaGJVuB0UvMiyRCbZCT14MHUIzcaCCFcZAGOiKIB3UkyCeBBU86EGYiPZanTIZwnTWScdqbdM/U/vHN1mS5jGHHD637w9+TOM1vKrTtPe8419z7njflrmWt2yb9ocpE0p4CaW2KTjVdtKgkqsnloZCMYyHQjgeHguD4YndoeBDwagZpzCKsfbmNIzjZZxF0aiS+Qd/TUJvRRjYzQcf2DPhotP6TOBJTOE5FIlVPG/NZEvRpq6Wpcp/dR1RXlcmz5pUasWOUalJDQ+3AOC83aGb/SF7TfCdMHCzJ5zYHwjKghXhwC1NXwvmBbOCgheVMI4iGSOas0MXXfWTdWU/WnBjc5kKUqpZkUGibkIFC1IdetSdwZXInB3HJS7bUNR3aCQbr67VaeAuKthGNxbxhVcccNiw8275LbZgw+dm/OUFn/h5falODjVUUUeEHfQKjrhg0OueEunUH3nGfY7akwjWvWnSjEdxG3U0UEOKCAnu4l58605Gzq4EOWRsqLWDFI22/bY6AlJ0ATHOCR6XlcgogCruRx6dgDo6BGvYQQY1cazfu3p9atUlxxT0YxnXcQ2/o4I8yvjSx+ZdsYI9ucjbNj2rx3UMY9O+ryy67bKGX3R42hEnjXnIIr4xJvE3LuH7WCqSw1HUsOAfq96QdU63j+SdUTbrBhLUHJTzg7Ki4ELsHhlNVJHBiIMOOatTnwSRYYeVHEMT2n3WMqoZizZ8pmm/BWKxLQXbHlCxjkfUDGs98yeqUluoAf8DkrzrAnZsWyMAAAAASUVORK5CYII=]]></image>
  <mode>0</mode>
  <initcode><![CDATA[var Cc = Components.classes, Ci = Components.interfaces;
const EXTENSION = Ci.nsIUpdateItem.TYPE_EXTENSION;

function extProp(aElement, aString) {
  var emRDF = "http://www.mozilla.org/2004/em-rdf#";
  var arc = RDFService.GetResource(emRDF + aString);
  var target = ExtensionManager.GetTarget(aElement, arc, true);
  if (target instanceof Ci.nsIRDFLiteral)
    return target.Value;
  if (target instanceof Ci.nsIRDFInt)
    return target.Value;
  return null;
}

var RDFService = Cc["@mozilla.org/rdf/rdf-service;1"]
                   .getService(Ci.nsIRDFService);
var RDFContainer = Cc["@mozilla.org/rdf/container;1"]
                     .getService(Ci.nsIRDFContainer);
var ExtensionManager = Cc["@mozilla.org/extensions/manager;1"]
                         .getService(Ci.nsIExtensionManager)
                         .datasource;

var urn, root;
try {
  urn = "urn:mozilla:item:";
  root = RDFService.GetResource(urn + "root");
} catch(err) {
  urn = "urn:mozilla:extension:";
  root = RDFService.GetResource(urn + "root");
}

RDFContainer.Init(ExtensionManager, root);

var elements = RDFContainer.GetElements();
var extensionArray = [];
var i = -1;
while (elements.hasMoreElements()) {
  i++;
  var element = elements.getNext();
  element.QueryInterface(Ci.nsIRDFResource);
  var prop_OptionsURL = extProp(element, "optionsURL");
  if (extProp(element, "type") == EXTENSION &&  prop_OptionsURL) {
    var prop_name = extProp(element, "name");

    extensionArray[i] = {
      guid: element.Value.replace(urn, ""),
      name: prop_name.charAt(0).toUpperCase() + prop_name.substr(1),
      version: extProp(element, "version"),
      homepageURL: (extProp(element, "homepageURL") != undefined)
                    ? extProp(element, "homepageURL")
                    : "http://www.google.com/search?q=%22" +
                      prop_name.replace(/\s/g, "+") + "%22",
      optionsURL: prop_OptionsURL,
      iconURL: (extProp(element, "iconURL") != undefined)
                ? extProp(element, "iconURL")
                : "chrome://mozapps/skin/xpinstall/" +
                  "xpinstallItemGeneric.png",
      disabled: extProp(element, "userDisabled")
    }
  }
}

extensionArray.sort(function(a, b) {
  a = a.name.toLowerCase();
  b = b.name.toLowerCase();
  if (a < b) return -1;
  if (a > b) return 1;
  return 0;
})


var features = "chrome, dialog = no, resizable, " +
               "titlebar, toolbar, centerscreen";
var extCommand = "window.openDialog('optionsURL', this.id, '" +
                                    features + "');";

var mPopup = this.appendChild(document.createElement("menupopup"));
mPopup.setAttribute("datasources", "rdf:null");
mPopup.setAttribute("ref", urn + "root");
mPopup.setAttribute("context", "cbContext-extensions-popup");
mPopup.setAttribute("oncommand", "event.stopPropagation()");

for (var i = 0; i < extensionArray.length; i++) {
  var extArray = extensionArray[i];
  try {
    var mItem = document.createElement("menuitem");
    mItem.setAttribute("id", urn + extArray.guid);
    mItem.setAttribute("GUID", extArray.guid);
    mItem.setAttribute("label", extArray.name + " " + extArray.version);
    mItem.setAttribute("tooltiptext", extArray.name + " " + extArray.version);
    if (extArray.iconURL) {
      mItem.setAttribute("class", "menuitem-iconic bookmark-item");
      mItem.setAttribute("image", extArray.iconURL);
    }
    if (extArray.optionsURL) {
      mItem.setAttribute("oncommand",
                         extCommand.replace("optionsURL",
                                            extArray.optionsURL));
    }
    if (extArray.disabled) {
      mItem.setAttribute("hidden", true);
    }
    mItem.setAttribute("homepageURL", extArray.homepageURL);
    mPopup.appendChild(mItem);
  } catch(e) {
  }
}


function addMenuItem(aNode, aLabel, aCommand) {
  var mi = aNode.appendChild(document.createElement("menuitem"));
  mi.setAttribute("label", aLabel);
  mi.setAttribute("oncommand", aCommand);

  mi.goHome = function(aNode) {
    var loadInBackground =
        nsPreferences.getBoolPref("browser.tabs.loadBookmarksInBackground");
    var url = aNode.getAttribute("homepageURL");
    if (content.location == "about:blank") {
      gBrowser.loadURI(url);
    } else {
      gBrowser.loadOneTab(url, null, null, null, loadInBackground);
    }
  }

  mi.browseDir = function(aNode) {
    var GUID = aNode.getAttribute("GUID");
    var Cc = Components.classes, Ci = Components.interfaces;
    var dirService = Cc["@mozilla.org/file/directory_service;1"]
                       .getService(Ci.nsIProperties);
    var dir = dirService.get("ProfD", Ci.nsIFile);
    dir.append("extensions");
    dir.append(GUID);
    if (!dir.exists()) {
      alert("Directory " + dir.path + " doesn't exist!");
      return;
    }

    var localFileInterface = Cc["@mozilla.org/file/local;1"]
                               .createInstance(Ci.nsILocalFile);
    localFileInterface.initWithPath(dir.path);
    var iDirectory = localFileInterface;
    try {
      iDirectory.reveal();
    } catch(ex) {
      var uri = Cc["@mozilla.org/network/io-service;1"]
                  .getService(Ci.nsIIOService).newFileURI(iDirectory);
      var protocolSvc = Cc["@mozilla.org/uriloader/external-protocol-service;1"]
                          .getService(Ci.nsIExternalProtocolService);
      protocolSvc.loadUrl(uri);
    }
  }
}


function removeElementById(aID) {
  var test = document.getElementById(aID);
  if (test) test.parentNode.removeChild(test);
}

removeElementById("cbContext-extensions-popup");

var mainPop = document.getElementById("mainPopupSet");
var context = mainPop.appendChild(document.createElement("popup"));
context.id = "cbContext-extensions-popup";
context.setAttribute("oncommand", "closeMenus(document.popupNode);");

var contextItems = [
  { label: "Visit Home Page",
    command: "this.goHome(document.popupNode);" },
  { label: "Browse Install Directory",
    command: "this.browseDir(document.popupNode);" }
];

for (var i in contextItems) {
  addMenuItem(context, contextItems[i].label, contextItems[i].command);
}

this.type = "menu-button";
this.tooltipText = "Extensions";

this.setAttribute("onclick",
                  "if (event.button == 1) gBrowser.loadOneTab(" +
                  "'chrome://mozapps/content/extensions/extensions.xul?" +
                  "type=extensions', null, null, null, false);");
]]></initcode>
  <code><![CDATA[/* -------------------------------------------------------------
   Extensions Menu
   Based on snippet by onemen
   http://forums.mozillazine.org/viewtopic.php?p=1774082#1774082
   Modified by LouCypher (aka Zoolcar9)
   ------------------------------------------------------------- */

if(typeof BrowserOpenAddonsMgr == "function") {
  BrowserOpenAddonsMgr();
} else {
  BrowserOpenExtensions("extensions");
}
]]></code>
  <accelkey><![CDATA[]]></accelkey>
  <help><![CDATA[]]></help>
  <attributes/>
</custombutton>